-- ========================================
-- SCRIPT DE SINCRONIZACIÓN (Generado: 1/18/2026 3:01:39 PM)
-- ========================================


-- Modificar columna: fza_variaciones.CODIGO_VAR
ALTER TABLE `fza_variaciones` MODIFY COLUMN `CODIGO_VAR` varchar(20) NOT NULL;

-- Agregar índice: fza_variaciones.PRIMARY
ALTER TABLE `fza_variaciones` ADD PRIMARY KEY (`CODIGO_VAR`);

-- Tabla nueva: fza_variaciones_atributos
CREATE TABLE `fza_variaciones_atributos` (
  `ID_VA` varchar(20) NOT NULL,
  `ID_ATRIBUTO_VA` varchar(20) NOT NULL,
  `NOMBRE_VA` varchar(50) NULL DEFAULT NULL,
  `ESDEFINITORIO` char(1) NULL DEFAULT NULL,
  `ORDEN_VA` int(11) NULL DEFAULT NULL,
  PRIMARY KEY (`ID_VA`,`ID_ATRIBUTO_VA`)
);

-- === VISTAS ===
-- Recreando vista: vi_articulos
DROP VIEW IF EXISTS `vi_articulos`;

CREATE ALGORITHM=UNDEFINED  VIEW `vi_articulos` AS select `fza_articulos`.`CODIGO_ARTICULO` AS `CODIGO_ARTICULO`,`fza_articulos`.`ACTIVO_ARTICULO` AS `ACTIVO_ARTICULO`,`fza_articulos`.`ORDEN_ARTICULO` AS `ORDEN_ARTICULO`,`fza_articulos`.`DESCRIPCION_ARTICULO` AS `DESCRIPCION_ARTICULO`,`fza_articulos`.`CODIGO_FAMILIA_ARTICULO` AS `CODIGO_FAMILIA_ARTICULO`,`fza_articulos_familias`.`DESCRIPCION_FAMILIA` AS `DESCRIPCION_FAMILIA`,`fza_articulos_familias`.`NOMBRE_FAMILIA` AS `NOMBRE_FAMILIA`,`fza_articulos`.`TIPOIVA_ARTICULO` AS `TIPOIVA_ARTICULO`,`fza_ivas_tipos`.`NOMBRE_TIPO_IVA` AS `NOMBRE_TIPO_IVA`,`fza_articulos`.`ESACTIVO_FIJO_ARTICULO` AS `ESACTIVO_FIJO_ARTICULO`,`fza_articulos`.`TIPO_CANTIDAD_ARTICULO` AS `TIPO_CANTIDAD_ARTICULO`,`fza_proveedores`.`RAZONSOCIAL_PROVEEDOR` AS `RAZONSOCIAL_PROVEEDOR`,`fza_articulos`.`INSTANTEMODIF` AS `INSTANTEMODIF`,`fza_articulos`.`INSTANTEALTA` AS `INSTANTEALTA`,`fza_articulos`.`USUARIOALTA` AS `USUARIOALTA`,`fza_articulos`.`USUARIOMODIF` AS `USUARIOMODIF` from ((((`fza_articulos` left join `fza_articulos_familias` on(`fza_articulos`.`CODIGO_FAMILIA_ARTICULO` = `fza_articulos_familias`.`CODIGO_FAMILIA`)) left join `fza_articulos_proveedores` on(`fza_articulos`.`CODIGO_ARTICULO` = `fza_articulos_proveedores`.`CODIGO_ARTICULO_ARTICULO_PROVEEDOR` and `fza_articulos_proveedores`.`ESPROVEEDORPRINCIPAL_ARTICULO_PROVEEDOR` = 'S')) left join `fza_proveedores` on(`fza_articulos_proveedores`.`CODIGO_PROVEEDOR_ARTICULO_PROVEEDOR` = `fza_proveedores`.`CODIGO_PROVEEDOR`)) left join `fza_ivas_tipos` on(`fza_articulos`.`TIPOIVA_ARTICULO` = `fza_ivas_tipos`.`CODIGO_ABREVIATURA_TIPO_IVA`)) order by `fza_articulos`.`ORDEN_ARTICULO`;

-- Recreando vista: vi_articulos_familias
DROP VIEW IF EXISTS `vi_articulos_familias`;

CREATE ALGORITHM=UNDEFINED  VIEW `vi_articulos_familias` AS select `fza_articulos_familias`.`CODIGO_FAMILIA` AS `CODIGO_FAMILIA`,`fza_articulos_familias`.`ACTIVO_FAMILIA` AS `ACTIVO_FAMILIA`,`fza_articulos_familias`.`ORDEN_FAMILIA` AS `ORDEN_FAMILIA`,`fza_articulos_familias`.`ESDEFAULT_FAMILIA` AS `ESDEFAULT_FAMILIA`,`fza_articulos_familias`.`CODIGO_SUBFAMILIA` AS `CODIGO_SUBFAMILIA`,`fza_articulos_familias2`.`NOMBRE_FAMILIA` AS `NOMBRE_SUBFAMILIA`,`fza_articulos_familias`.`NOMBRE_FAMILIA` AS `NOMBRE_FAMILIA`,`fza_articulos_familias`.`DESCRIPCION_FAMILIA` AS `DESCRIPCION_FAMILIA`,`fza_articulos_familias`.`INSTANTEMODIF` AS `INSTANTEMODIF`,`fza_articulos_familias`.`INSTANTEALTA` AS `INSTANTEALTA`,`fza_articulos_familias`.`USUARIOALTA` AS `USUARIOALTA`,`fza_articulos_familias`.`USUARIOMODIF` AS `USUARIOMODIF` from (`fza_articulos_familias` left join `fza_articulos_familias` `fza_articulos_familias2` on(`fza_articulos_familias`.`CODIGO_SUBFAMILIA` = `fza_articulos_familias2`.`CODIGO_FAMILIA`));

-- Recreando vista: vi_articulos_familias_list
DROP VIEW IF EXISTS `vi_articulos_familias_list`;

CREATE ALGORITHM=UNDEFINED  VIEW `vi_articulos_familias_list` AS select `fza_articulos_familias`.`CODIGO_FAMILIA` AS `CODIGO_FAMILIA`,`fza_articulos_familias`.`ACTIVO_FAMILIA` AS `ACTIVO_FAMILIA`,`fza_articulos_familias`.`ORDEN_FAMILIA` AS `ORDEN_FAMILIA`,`fza_articulos_familias`.`ESDEFAULT_FAMILIA` AS `ESDEFAULT_FAMILIA`,`fza_articulos_familias`.`CODIGO_SUBFAMILIA` AS `CODIGO_SUBFAMILIA`,`fza_articulos_familias`.`NOMBRE_FAMILIA` AS `NOMBRE_FAMILIA`,`fza_articulos_familias`.`DESCRIPCION_FAMILIA` AS `DESCRIPCION_FAMILIA`,`fza_articulos_familias`.`INSTANTEMODIF` AS `INSTANTEMODIF`,`fza_articulos_familias`.`INSTANTEALTA` AS `INSTANTEALTA`,`fza_articulos_familias`.`USUARIOALTA` AS `USUARIOALTA`,`fza_articulos_familias`.`USUARIOMODIF` AS `USUARIOMODIF` from `fza_articulos_familias` where `fza_articulos_familias`.`ACTIVO_FAMILIA` = 'S' order by `fza_articulos_familias`.`ORDEN_FAMILIA`;

-- Recreando vista: vi_articulos_list
DROP VIEW IF EXISTS `vi_articulos_list`;

CREATE ALGORITHM=UNDEFINED  VIEW `vi_articulos_list` AS select `fza_articulos`.`CODIGO_ARTICULO` AS `CODIGO_ARTICULO`,`fza_articulos`.`ACTIVO_ARTICULO` AS `ACTIVO_ARTICULO`,`fza_articulos`.`ORDEN_ARTICULO` AS `ORDEN_ARTICULO`,`fza_articulos`.`DESCRIPCION_ARTICULO` AS `DESCRIPCION_ARTICULO`,`fza_articulos`.`CODIGO_FAMILIA_ARTICULO` AS `CODIGO_FAMILIA_ARTICULO`,`fza_articulos_familias`.`DESCRIPCION_FAMILIA` AS `DESCRIPCION_FAMILIA`,`fza_articulos`.`TIPOIVA_ARTICULO` AS `TIPOIVA_ARTICULO`,`fza_articulos`.`ESACTIVO_FIJO_ARTICULO` AS `ESACTIVO_FIJO_ARTICULO`,`fza_articulos`.`TIPO_CANTIDAD_ARTICULO` AS `TIPO_CANTIDAD_ARTICULO`,`fza_articulos_proveedores`.`CODIGO_PROVEEDOR_ARTICULO_PROVEEDOR` AS `CODIGO_PROVEEDOR`,`fza_proveedores`.`RAZONSOCIAL_PROVEEDOR` AS `RAZONSOCIAL_PROVEEDOR`,`fza_articulos`.`INSTANTEMODIF` AS `INSTANTEMODIF`,`fza_articulos`.`INSTANTEALTA` AS `INSTANTEALTA`,`fza_articulos`.`USUARIOALTA` AS `USUARIOALTA`,`fza_articulos`.`USUARIOMODIF` AS `USUARIOMODIF` from (((`fza_articulos` left join `fza_articulos_familias` on(`fza_articulos`.`CODIGO_FAMILIA_ARTICULO` = `fza_articulos_familias`.`CODIGO_FAMILIA`)) left join `fza_articulos_proveedores` on(`fza_articulos_proveedores`.`CODIGO_ARTICULO_ARTICULO_PROVEEDOR` = `fza_articulos`.`CODIGO_ARTICULO` and `fza_articulos_proveedores`.`ESPROVEEDORPRINCIPAL_ARTICULO_PROVEEDOR` = 'S')) left join `fza_proveedores` on(`fza_proveedores`.`CODIGO_PROVEEDOR` = `fza_articulos_proveedores`.`CODIGO_PROVEEDOR_ARTICULO_PROVEEDOR`)) where `fza_articulos`.`ACTIVO_ARTICULO` = 'S' order by `fza_articulos`.`ORDEN_ARTICULO`;

-- Recreando vista: vi_articulos_proveedores
DROP VIEW IF EXISTS `vi_articulos_proveedores`;

CREATE ALGORITHM=UNDEFINED  VIEW `vi_articulos_proveedores` AS select `fza_articulos_proveedores`.`CODIGO_PROVEEDOR_ARTICULO_PROVEEDOR` AS `CODIGO_PROVEEDOR`,`fza_proveedores`.`RAZONSOCIAL_PROVEEDOR` AS `RAZONSOCIAL_PROVEEDOR`,`fza_articulos_proveedores`.`CODIGO_ARTICULO_ARTICULO_PROVEEDOR` AS `CODIGO_ARTICULO`,`fza_articulos_proveedores`.`PRECIO_ULT_COMPRA_ARTICULO_PROVEEDOR` AS `PRECIO_ULT_COMPRA`,`fza_articulos_proveedores`.`FECHA_VALIDEZ_ARTICULO_PROVEEDOR` AS `FECHA_VALIDEZ`,`fza_articulos_proveedores`.`ESPROVEEDORPRINCIPAL_ARTICULO_PROVEEDOR` AS `ESPROVEEDORPRINCIPAL`,`fza_articulos_proveedores`.`INSTANTEMODIF` AS `INSTANTEMODIF`,`fza_articulos_proveedores`.`INSTANTEALTA` AS `INSTANTEALTA`,`fza_articulos_proveedores`.`USUARIOALTA` AS `USUARIOALTA`,`fza_articulos_proveedores`.`USUARIOMODIF` AS `USUARIOMODIF` from (`fza_articulos_proveedores` left join `fza_proveedores` on(`fza_articulos_proveedores`.`CODIGO_PROVEEDOR_ARTICULO_PROVEEDOR` = `fza_proveedores`.`CODIGO_PROVEEDOR`));

-- Recreando vista: vi_articulos_tarifas
DROP VIEW IF EXISTS `vi_articulos_tarifas`;

CREATE ALGORITHM=UNDEFINED  VIEW `vi_articulos_tarifas` AS select `fza_articulos_tarifas`.`CODIGO_UNICO_TARIFA` AS `CODIGO_UNICO_TARIFA`,`fza_articulos_tarifas`.`CODIGO_ARTICULO_TARIFA` AS `CODIGO_ARTICULO_TARIFA`,`fza_tarifas`.`ESIMP_INCL_TARIFA` AS `ESIMP_INCL_TARIFA`,`fza_tarifas`.`ESDEFAULT_TARIFA` AS `ESDEFAULT_TARIFA`,`fza_articulos`.`DESCRIPCION_ARTICULO` AS `DESCRIPCION_ARTICULO`,`fza_articulos`.`TIPO_CANTIDAD_ARTICULO` AS `TIPO_CANTIDAD_ARTICULO`,`fza_ivas_tipos`.`CODIGO_ABREVIATURA_TIPO_IVA` AS `TIPO_IVA_ARTICULO`,`fza_articulos_tarifas`.`ACTIVO_TARIFA` AS `ACTIVO_TARIFA`,`fza_articulos_tarifas`.`CODIGO_TARIFA` AS `CODIGO_TARIFA`,`fza_tarifas`.`NOMBRE_TARIFA` AS `NOMBRE_TARIFA`,`fza_articulos_tarifas`.`FECHA_DESDE_TARIFA` AS `FECHA_DESDE_TARIFA`,`fza_articulos_tarifas`.`FECHA_HASTA_TARIFA` AS `FECHA_HASTA_TARIFA`,`fza_articulos_tarifas`.`PRECIOFINAL_TARIFA` AS `PRECIOFINAL_TARIFA`,`fza_articulos_tarifas`.`PRECIOSALIDA_TARIFA` AS `PRECIOSALIDA_TARIFA`,`fza_articulos_tarifas`.`PORCEN_DTO_TARIFA` AS `PORCEN_DTO_TARIFA`,`fza_articulos_tarifas`.`PRECIO_DTO_TARIFA` AS `PRECIO_DTO_TARIFA`,`fza_articulos_proveedores`.`CODIGO_PROVEEDOR_ARTICULO_PROVEEDOR` AS `CODIGO_PROVEEDOR`,`fza_proveedores`.`RAZONSOCIAL_PROVEEDOR` AS `RAZONSOCIAL_PROVEEDOR`,`fza_articulos_proveedores`.`PRECIO_ULT_COMPRA_ARTICULO_PROVEEDOR` AS `PRECIO_ULT_COMPRA`,`fza_articulos_proveedores`.`FECHA_VALIDEZ_ARTICULO_PROVEEDOR` AS `FECHA_VALIDEZ`,`fza_articulos`.`CODIGO_FAMILIA_ARTICULO` AS `CODIGO_FAMILIA_ARTICULO`,`fza_articulos_familias`.`DESCRIPCION_FAMILIA` AS `DESCRIPCION_FAMILIA`,`fza_articulos_tarifas`.`INSTANTEALTA` AS `INSTANTEALTA`,`fza_articulos_tarifas`.`INSTANTEMODIF` AS `INSTANTEMODIF`,`fza_articulos_tarifas`.`USUARIOALTA` AS `USUARIOALTA`,`fza_articulos_tarifas`.`USUARIOMODIF` AS `USUARIOMODIF` from ((((((`fza_articulos_tarifas` left join `fza_articulos_proveedores` on(`fza_articulos_tarifas`.`CODIGO_ARTICULO_TARIFA` = `fza_articulos_proveedores`.`CODIGO_ARTICULO_ARTICULO_PROVEEDOR` and `fza_articulos_proveedores`.`ESPROVEEDORPRINCIPAL_ARTICULO_PROVEEDOR` = 'S')) left join `fza_tarifas` on(`fza_articulos_tarifas`.`CODIGO_TARIFA` = `fza_tarifas`.`CODIGO_TARIFA`)) left join `fza_articulos` on(`fza_articulos_tarifas`.`CODIGO_ARTICULO_TARIFA` = `fza_articulos`.`CODIGO_ARTICULO`)) left join `fza_articulos_familias` on(`fza_articulos`.`CODIGO_FAMILIA_ARTICULO` = `fza_articulos_familias`.`CODIGO_FAMILIA`)) left join `fza_proveedores` on(`fza_articulos_proveedores`.`CODIGO_PROVEEDOR_ARTICULO_PROVEEDOR` = `fza_proveedores`.`CODIGO_PROVEEDOR`)) left join `fza_ivas_tipos` on(`fza_articulos`.`TIPOIVA_ARTICULO` = `fza_ivas_tipos`.`CODIGO_ABREVIATURA_TIPO_IVA`)) order by `fza_tarifas`.`ORDEN_TARIFA`,`fza_articulos`.`ORDEN_ARTICULO`;

-- Recreando vista: vi_art_busquedas
DROP VIEW IF EXISTS `vi_art_busquedas`;

CREATE ALGORITHM=UNDEFINED  VIEW `vi_art_busquedas` AS select `fza_articulos`.`CODIGO_ARTICULO` AS `CODIGO_ARTICULO`,`fza_articulos`.`ACTIVO_ARTICULO` AS `ACTIVO_ARTICULO`,`fza_articulos`.`DESCRIPCION_ARTICULO` AS `DESCRIPCION_ARTICULO`,`fza_articulos`.`CODIGO_FAMILIA_ARTICULO` AS `CODIGO_FAMILIA_ARTICULO`,`fza_articulos_familias`.`DESCRIPCION_FAMILIA` AS `DESCRIPCION_FAMILIA`,`fza_articulos_proveedores`.`CODIGO_PROVEEDOR_ARTICULO_PROVEEDOR` AS `CODIGO_PROVEEDOR`,`fza_proveedores`.`RAZONSOCIAL_PROVEEDOR` AS `RAZON_SOCIAL_PROVEEDOR`,`fza_articulos_proveedores`.`ESPROVEEDORPRINCIPAL_ARTICULO_PROVEEDOR` AS `ESPROVEEDORPRINCIPAL`,`fza_articulos_proveedores`.`PRECIO_ULT_COMPRA_ARTICULO_PROVEEDOR` AS `PRECIO_ULT_COMPRA`,`fza_articulos_tarifas`.`CODIGO_TARIFA` AS `CODIGO_TARIFA`,`fza_tarifas`.`NOMBRE_TARIFA` AS `NOMBRE_TARIFA`,`fza_articulos_tarifas`.`PRECIOSALIDA_TARIFA` AS `PRECIOSALIDA_TARIFA`,`fza_articulos_tarifas`.`PRECIO_DTO_TARIFA` AS `PRECIO_DTO_TARIFA`,`fza_articulos_tarifas`.`PORCEN_DTO_TARIFA` AS `PORCEN_DTO_TARIFA`,`fza_articulos_tarifas`.`PRECIOFINAL_TARIFA` AS `PRECIOFINAL_TARIFA`,`fza_articulos_tarifas`.`FECHA_DESDE_TARIFA` AS `FECHA_DESDE_TARIFA`,`fza_articulos_tarifas`.`FECHA_HASTA_TARIFA` AS `FECHA_HASTA_TARIFA`,`fza_tarifas`.`ESIMP_INCL_TARIFA` AS `ESIMP_INCL_TARIFA`,`fza_ivas_tipos`.`NOMBRE_TIPO_IVA` AS `NOMBRE_TIPO_IVA`,`fza_articulos`.`TIPOIVA_ARTICULO` AS `TIPOIVA_ARTICULO`,`fza_articulos`.`TIPO_CANTIDAD_ARTICULO` AS `TIPO_CANTIDAD_ARTICULO`,`fza_articulos`.`USUARIOMODIF` AS `USUARIOMODIF`,`fza_articulos`.`INSTANTEALTA` AS `INSTANTEALTA`,`fza_articulos`.`INSTANTEMODIF` AS `INSTANTEMODIF`,`fza_articulos`.`USUARIOALTA` AS `USUARIOALTA`,`fza_articulos`.`ESACTIVO_FIJO_ARTICULO` AS `ESACTIVO_FIJO_ARTICULO` from ((((((`fza_articulos` left join `fza_articulos_familias` on(`fza_articulos`.`CODIGO_FAMILIA_ARTICULO` = `fza_articulos_familias`.`CODIGO_FAMILIA`)) left join `fza_articulos_tarifas` on(`fza_articulos`.`CODIGO_ARTICULO` = `fza_articulos_tarifas`.`CODIGO_ARTICULO_TARIFA`)) left join `fza_tarifas` on(`fza_articulos_tarifas`.`CODIGO_TARIFA` = `fza_tarifas`.`CODIGO_TARIFA` and `fza_tarifas`.`ESDEFAULT_TARIFA` = 'S')) left join `fza_ivas_tipos` on(`fza_articulos`.`TIPOIVA_ARTICULO` = `fza_ivas_tipos`.`CODIGO_ABREVIATURA_TIPO_IVA`)) left join `fza_articulos_proveedores` on(`fza_articulos`.`CODIGO_ARTICULO` = `fza_articulos_proveedores`.`CODIGO_ARTICULO_ARTICULO_PROVEEDOR` and `fza_articulos_proveedores`.`ESPROVEEDORPRINCIPAL_ARTICULO_PROVEEDOR` = 'S')) left join `fza_proveedores` on(`fza_proveedores`.`CODIGO_PROVEEDOR` = `fza_articulos_proveedores`.`CODIGO_PROVEEDOR_ARTICULO_PROVEEDOR`)) where `fza_articulos`.`ACTIVO_ARTICULO` = 'S' order by `fza_articulos`.`ORDEN_ARTICULO`;

-- Recreando vista: vi_atributos_nombres
DROP VIEW IF EXISTS `vi_atributos_nombres`;

CREATE ALGORITHM=UNDEFINED  VIEW `vi_atributos_nombres` AS select distinct `ask`.`CODIGO_ARTICULO_SKU` AS `CODIGO_ARTICULO_PADRE`,`vat`.`ID_ATRIBUTO_VA` AS `ID_ATRIBUTO`,`vat`.`NOMBRE_VA` AS `NOMBRE_ATRIBUTO`,`vat`.`ORDEN_VA` AS `ORDEN_VISUAL_ATRIBUTO` from (`fza_articulos_skus` `ask` join `fza_variaciones_atributos` `vat` on(`vat`.`ID_VA` = `ask`.`CODIGO_VAR_SKU`)) where `vat`.`ESDEFINITORIO` = 'S' order by `ask`.`CODIGO_ARTICULO_SKU`,`vat`.`ORDEN_VA`;

-- Recreando vista: vi_caja_busqueda_unificada
DROP VIEW IF EXISTS `vi_caja_busqueda_unificada`;

CREATE ALGORITHM=UNDEFINED  VIEW `vi_caja_busqueda_unificada` AS select `a`.`CODIGO_ARTICULO` AS `INPUT_BUSQUEDA`,'CODIGO' AS `TIPO_COINCIDENCIA`,`a`.`CODIGO_ARTICULO` AS `CODIGO_PADRE`,NULL AS `CODIGO_SKU`,`a`.`DESCRIPCION_ARTICULO` AS `DESCRIPCION_ARTICULO`,`a`.`TIPO_ARTICULO` AS `TIPO_ARTICULO` from `fza_articulos` `a` where `a`.`ACTIVO_ARTICULO` = 'S' union all select `sku`.`CODIGO_UNIDAD_SKU` AS `INPUT_BUSQUEDA`,'SKU' AS `TIPO_COINCIDENCIA`,`a`.`CODIGO_ARTICULO` AS `CODIGO_PADRE`,`sku`.`CODIGO_UNIDAD_SKU` AS `CODIGO_SKU`,`a`.`DESCRIPCION_ARTICULO` AS `DESCRIPCION_ARTICULO`,`a`.`TIPO_ARTICULO` AS `TIPO_ARTICULO` from (`fza_articulos_skus` `sku` join `fza_articulos` `a` on(`sku`.`CODIGO_ARTICULO_SKU` = `a`.`CODIGO_ARTICULO`)) where `sku`.`ESACTIVO_SKU` = 'S' union all select `cb`.`CODIGO_BARRAS_CB` AS `INPUT_BUSQUEDA`,'EAN' AS `TIPO_COINCIDENCIA`,`a`.`CODIGO_ARTICULO` AS `CODIGO_PADRE`,`sku`.`CODIGO_UNIDAD_SKU` AS `CODIGO_SKU`,`a`.`DESCRIPCION_ARTICULO` AS `DESCRIPCION_ARTICULO`,`a`.`TIPO_ARTICULO` AS `TIPO_ARTICULO` from ((`fza_codigos_barras` `cb` join `fza_articulos_skus` `sku` on(`cb`.`CODIGO_UNIDAD_CB` = `sku`.`CODIGO_UNIDAD_SKU`)) join `fza_articulos` `a` on(`sku`.`CODIGO_ARTICULO_SKU` = `a`.`CODIGO_ARTICULO`));

-- Recreando vista: vi_caja_tarifa_sku_articulos
DROP VIEW IF EXISTS `vi_caja_tarifa_sku_articulos`;

CREATE ALGORITHM=UNDEFINED  VIEW `vi_caja_tarifa_sku_articulos` AS select `skus`.`CODIGO_UNIDAD_SKU` AS `CODIGO_UNIDAD_TARIFA`,`skus`.`CODIGO_ARTICULO_SKU` AS `CODIGO_ARTICULO`,`tarifas`.`CODIGO_TARIFA` AS `CODIGO_TARIFA`,`tarifas`.`NOMBRE_TARIFA` AS `NOMBRE_TARIFA`,coalesce(`tarifa_sku`.`PRECIOFINAL_TARIFA`,`tarifa_padre`.`PRECIOFINAL_TARIFA`) AS `PRECIOFINAL_TARIFA`,coalesce(`tarifa_sku`.`PRECIOSALIDA_TARIFA`,`tarifa_padre`.`PRECIOSALIDA_TARIFA`) AS `PRECIOSALIDA_TARIFA`,case when `tarifa_sku`.`PRECIOFINAL_TARIFA` is not null then 'ESPECIFICO_SKU' when `tarifa_padre`.`PRECIOFINAL_TARIFA` is not null then 'HEREDADO_PADRE' else 'SIN_PRECIO' end AS `ORIGEN_PRECIO`,concat(`articulos`.`DESCRIPCION_ARTICULO`,' (',`skus`.`CODIGO_UNIDAD_SKU`,')') AS `DESCRIPCION_COMPLETA`,`tarifas`.`ESIMP_INCL_TARIFA` AS `ESIMP_INCL_TARIFA`,`articulos`.`TIPO_CANTIDAD_ARTICULO` AS `TIPO_CANTIDAD_ARTICULO`,`articulos`.`CODIGO_FAMILIA_ARTICULO` AS `CODIGO_FAMILIA_ARTICULO` from ((((`fza_articulos_skus` `skus` join `fza_articulos` `articulos` on(`skus`.`CODIGO_ARTICULO_SKU` = `articulos`.`CODIGO_ARTICULO`)) join `fza_tarifas` `tarifas`) left join `fza_articulos_tarifas` `tarifa_sku` on(`skus`.`CODIGO_UNIDAD_SKU` = `tarifa_sku`.`CODIGO_UNIDAD_TARIFA` and `tarifas`.`CODIGO_TARIFA` = `tarifa_sku`.`CODIGO_TARIFA`)) left join `fza_articulos_tarifas` `tarifa_padre` on(`articulos`.`CODIGO_ARTICULO` = `tarifa_padre`.`CODIGO_ARTICULO_TARIFA` and `tarifas`.`CODIGO_TARIFA` = `tarifa_padre`.`CODIGO_TARIFA` and (`tarifa_padre`.`CODIGO_UNIDAD_TARIFA` is null or `tarifa_padre`.`CODIGO_UNIDAD_TARIFA` = ''))) where `skus`.`ESACTIVO_SKU` = 'S' order by `skus`.`CODIGO_ARTICULO_SKU`,`skus`.`CODIGO_UNIDAD_SKU`,`tarifas`.`ORDEN_TARIFA`;

-- Recreando vista: vi_caja_totalventas
DROP VIEW IF EXISTS `vi_caja_totalventas`;

CREATE ALGORITHM=UNDEFINED  VIEW `vi_caja_totalventas` AS select `fza_facturas`.`FECHA_FACTURA` AS `FECHA`,count(0) AS `TOTAL_VENTAS`,sum(`fza_facturas`.`TOTAL_LIQUIDO_FACTURA`) AS `TOTAL_COBRADO` from `fza_facturas` group by `fza_facturas`.`FECHA_FACTURA` order by `fza_facturas`.`FECHA_FACTURA`;

-- Recreando vista: vi_clientes
DROP VIEW IF EXISTS `vi_clientes`;

CREATE ALGORITHM=UNDEFINED  VIEW `vi_clientes` AS select `fza_clientes`.`CODIGO_CLIENTE` AS `CODIGO_CLIENTE`,`fza_clientes`.`ORDEN_CLIENTE` AS `ORDEN_CLIENTE`,`fza_clientes`.`ACTIVO_CLIENTE` AS `ACTIVO_CLIENTE`,`fza_clientes`.`RAZONSOCIAL_CLIENTE` AS `RAZONSOCIAL_CLIENTE`,`fza_clientes`.`NIF_CLIENTE` AS `NIF_CLIENTE`,`fza_clientes`.`MOVIL_CLIENTE` AS `MOVIL_CLIENTE`,`fza_clientes`.`EMAIL_CLIENTE` AS `EMAIL_CLIENTE`,`fza_clientes`.`DIRECCION1_CLIENTE` AS `DIRECCION1_CLIENTE`,`fza_clientes`.`DIRECCION2_CLIENTE` AS `DIRECCION2_CLIENTE`,`fza_clientes`.`POBLACION_CLIENTE` AS `POBLACION_CLIENTE`,`fza_clientes`.`PROVINCIA_CLIENTE` AS `PROVINCIA_CLIENTE`,`fza_clientes`.`CPOSTAL_CLIENTE` AS `CPOSTAL_CLIENTE`,`fza_clientes`.`NOMBRE_PAIS_CLIENTE` AS `NOMBRE_PAIS_CLIENTE`,`fza_clientes`.`CODIGO_PAIS_CLIENTE` AS `CODIGO_PAIS_CLIENTE`,`fza_clientes`.`OBSERVACIONES_CLIENTE` AS `OBSERVACIONES_CLIENTE`,`fza_clientes`.`REFERENCIA_CLIENTE` AS `REFERENCIA_CLIENTE`,`fza_clientes`.`CONTACTO_CLIENTE` AS `CONTACTO_CLIENTE`,`fza_clientes`.`TELEFONO_CONTACTO_CLIENTE` AS `TELEFONO_CONTACTO_CLIENTE`,`fza_clientes`.`TELEFONO_CLIENTE` AS `TELEFONO_CLIENTE`,`fza_clientes`.`IBAN_CLIENTE` AS `IBAN_CLIENTE`,`fza_clientes`.`ESIVA_RECARGO_CLIENTE` AS `ESIVA_RECARGO_CLIENTE`,`fza_clientes`.`ESRETENCIONES_CLIENTE` AS `ESRETENCIONES_CLIENTE`,`fza_clientes`.`ESIVA_EXENTO_CLIENTE` AS `ESIVA_EXENTO_CLIENTE`,`fza_clientes`.`ESINTRACOMUNITARIO_CLIENTE` AS `ESINTRACOMUNITARIO_CLIENTE`,`fza_clientes`.`ESREGIMENESPECIALAGRICOLA_CLIENTE` AS `ESREGIMENESPECIALAGRICOLA_CLIENTE`,`fza_clientes`.`CODIGO_FORMA_PAGO_CLIENTE` AS `CODIGO_FORMA_PAGO_CLIENTE`,`fza_clientes`.`TARIFA_ARTICULO_CLIENTE` AS `TARIFA_ARTICULO_CLIENTE`,`fza_clientes`.`SERIE_CONTADOR_CLIENTE` AS `SERIE_CONTADOR_CLIENTE`,`fza_clientes`.`TEXTO_LEGAL_FACTURA_CLIENTE` AS `TEXTO_LEGAL_FACTURA_CLIENTE`,`fza_clientes`.`INSTANTEMODIF` AS `INSTANTEMODIF`,`fza_clientes`.`INSTANTEALTA` AS `INSTANTEALTA`,`fza_clientes`.`USUARIOALTA` AS `USUARIOALTA`,`fza_clientes`.`USUARIOMODIF` AS `USUARIOMODIF` from `fza_clientes`;

-- Recreando vista: vi_cli_busquedas
DROP VIEW IF EXISTS `vi_cli_busquedas`;

CREATE ALGORITHM=UNDEFINED  VIEW `vi_cli_busquedas` AS select `fza_clientes`.`CODIGO_CLIENTE` AS `CODIGO_CLIENTE`,`fza_clientes`.`ACTIVO_CLIENTE` AS `ACTIVO_CLIENTE`,`fza_clientes`.`RAZONSOCIAL_CLIENTE` AS `RAZONSOCIAL_CLIENTE`,`fza_clientes`.`NIF_CLIENTE` AS `NIF_CLIENTE`,`fza_clientes`.`MOVIL_CLIENTE` AS `MOVIL_CLIENTE`,`fza_clientes`.`EMAIL_CLIENTE` AS `EMAIL_CLIENTE`,`fza_clientes`.`DIRECCION1_CLIENTE` AS `DIRECCION1_CLIENTE`,`fza_clientes`.`DIRECCION2_CLIENTE` AS `DIRECCION2_CLIENTE`,`fza_clientes`.`POBLACION_CLIENTE` AS `POBLACION_CLIENTE`,`fza_clientes`.`PROVINCIA_CLIENTE` AS `PROVINCIA_CLIENTE`,`fza_clientes`.`CPOSTAL_CLIENTE` AS `CPOSTAL_CLIENTE`,`fza_clientes`.`CODIGO_PAIS_CLIENTE` AS `CODIGO_PAIS_CLIENTE`,`fza_clientes`.`NOMBRE_PAIS_CLIENTE` AS `NOMBRE_PAIS_CLIENTE`,`fza_clientes`.`OBSERVACIONES_CLIENTE` AS `OBSERVACIONES_CLIENTE`,`fza_clientes`.`REFERENCIA_CLIENTE` AS `REFERENCIA_CLIENTE`,`fza_clientes`.`CONTACTO_CLIENTE` AS `CONTACTO_CLIENTE`,`fza_clientes`.`TELEFONO_CONTACTO_CLIENTE` AS `TELEFONO_CONTACTO_CLIENTE`,`fza_clientes`.`TELEFONO_CLIENTE` AS `TELEFONO_CLIENTE`,`fza_clientes`.`IBAN_CLIENTE` AS `IBAN_CLIENTE`,`fza_clientes`.`ESIVA_RECARGO_CLIENTE` AS `ESIVA_RECARGO_CLIENTE`,`fza_clientes`.`ESRETENCIONES_CLIENTE` AS `ESRETENCIONES_CLIENTE`,`fza_clientes`.`ESIVA_EXENTO_CLIENTE` AS `ESIVA_EXENTO_CLIENTE`,`fza_clientes`.`ESREGIMENESPECIALAGRICOLA_CLIENTE` AS `ESREGIMENESPECIALAGRICOLA_CLIENTE`,`fza_clientes`.`ESINTRACOMUNITARIO_CLIENTE` AS `ESINTRACOMUNITARIO_CLIENTE`,`fza_clientes`.`CODIGO_FORMA_PAGO_CLIENTE` AS `CODIGO_FORMA_PAGO_CLIENTE`,`fza_clientes`.`SERIE_CONTADOR_CLIENTE` AS `SERIE_CONTADOR_CLIENTE`,`fza_clientes`.`TARIFA_ARTICULO_CLIENTE` AS `TARIFA_ARTICULO_CLIENTE`,`fza_clientes`.`TEXTO_LEGAL_FACTURA_CLIENTE` AS `TEXTO_LEGAL_FACTURA_CLIENTE`,`fza_clientes`.`INSTANTEMODIF` AS `INSTANTEMODIF`,`fza_clientes`.`INSTANTEALTA` AS `INSTANTEALTA`,`fza_clientes`.`USUARIOALTA` AS `USUARIOALTA`,`fza_clientes`.`USUARIOMODIF` AS `USUARIOMODIF` from `fza_clientes` where `fza_clientes`.`ACTIVO_CLIENTE` = 'S' order by `fza_clientes`.`CODIGO_CLIENTE` desc;

-- Recreando vista: vi_contadores
DROP VIEW IF EXISTS `vi_contadores`;

CREATE ALGORITHM=UNDEFINED  VIEW `vi_contadores` AS select `fza_contadores`.`TIPODOC_CONTADOR` AS `TIPODOC_CONTADOR`,`fza_contadores`.`SERIE_CONTADOR` AS `SERIE_CONTADOR`,`fza_contadores`.`CONTADOR_CONTADOR` AS `CONTADOR_CONTADOR`,`fza_contadores`.`SUBTIPODOC_CONTADOR` AS `SUBTIPODOC_CONTADOR`,`fza_contadores`.`EMPRESA_CONTADOR` AS `EMPRESA_CONTADOR`,`fza_tipos_documentos`.`DESCRIPCION_TIPODOCUMENTO` AS `DESCRIPCION_TIPODOCUMENTO`,`fza_contadores`.`DEFAULT_CONTADOR` AS `DEFAULT_CONTADOR`,`fza_contadores`.`NUMDIGIT_CONTADOR` AS `NUMDIGIT_CONTADOR`,`fza_contadores`.`ACTIVO_CONTADOR` AS `ACTIVO_CONTADOR`,`fza_contadores`.`INSTANTEMODIF` AS `INSTANTEMODIF`,`fza_contadores`.`INSTANTEALTA` AS `INSTANTEALTA`,`fza_contadores`.`USUARIOALTA` AS `USUARIOALTA`,`fza_contadores`.`USUARIOMODIF` AS `USUARIOMODIF` from (`fza_contadores` left join `fza_tipos_documentos` on(`fza_contadores`.`TIPODOC_CONTADOR` = `fza_tipos_documentos`.`CODIGO_TIPODOCUMENTO`));

-- Recreando vista: vi_empresas
DROP VIEW IF EXISTS `vi_empresas`;

CREATE ALGORITHM=UNDEFINED  VIEW `vi_empresas` AS select `fza_empresas`.`CODIGO_EMPRESA` AS `CODIGO_EMPRESA`,`fza_empresas`.`ORDEN_EMPRESA` AS `ORDEN_EMPRESA`,`fza_empresas`.`ACTIVO_EMPRESA` AS `ACTIVO_EMPRESA`,`fza_empresas`.`RAZONSOCIAL_EMPRESA` AS `RAZONSOCIAL_EMPRESA`,`fza_empresas`.`NIF_EMPRESA` AS `NIF_EMPRESA`,`fza_empresas`.`MOVIL_EMPRESA` AS `MOVIL_EMPRESA`,`fza_empresas`.`EMAIL_EMPRESA` AS `EMAIL_EMPRESA`,`fza_empresas`.`DIRECCION1_EMPRESA` AS `DIRECCION1_EMPRESA`,`fza_empresas`.`DIRECCION2_EMPRESA` AS `DIRECCION2_EMPRESA`,`fza_empresas`.`CPOSTAL_EMPRESA` AS `CPOSTAL_EMPRESA`,`fza_empresas`.`POBLACION_EMPRESA` AS `POBLACION_EMPRESA`,`fza_empresas`.`PROVINCIA_EMPRESA` AS `PROVINCIA_EMPRESA`,`fza_empresas`.`NOMBRE_PAIS_EMPRESA` AS `NOMBRE_PAIS_EMPRESA`,`fza_empresas`.`CODIGO_PAIS_EMPRESA` AS `CODIGO_PAIS_EMPRESA`,`fza_empresas`.`IBAN_EMPRESA` AS `IBAN_EMPRESA`,`fza_empresas`.`GRUPO_ZONA_IVA_EMPRESA` AS `GRUPO_ZONA_IVA_EMPRESA`,`fza_ivas_grupos`.`DESCRIPCION_ZONA_IVA` AS `DESCRIPCION_ZONA_IVA`,`fza_empresas`.`ESRETENCIONES_EMPRESA` AS `ESRETENCIONES_EMPRESA`,`fza_empresas`.`ESREGIMENESPECIALAGRICOLA_EMPRESA` AS `ESREGIMENESPECIALAGRICOLA_EMPRESA`,`fza_empresas`.`TEXTO_LEGAL_FACTURA_EMPRESA` AS `TEXTO_LEGAL_FACTURA_EMPRESA`,`fza_empresas`.`CODIGO_CERTIFICADO_EMPRESA` AS `CODIGO_CERTIFICADO_EMPRESA`,`fza_empresas`.`TITULAR_CERTIFICADO_EMPRESA` AS `TITULAR_CERTIFICADO_EMPRESA`,`fza_empresas`.`TIPO_CERTIFICADO_EMPRESA` AS `TIPO_CERTIFICADO_EMPRESA`,`fza_empresas`.`FECHA_DESDE_CERTIFICADO_EMPRESA` AS `FECHA_DESDE_CERTIFICADO_EMPRESA`,`fza_empresas`.`FECHA_HASTA_CERTIFICADO_EMPRESA` AS `FECHA_HASTA_CERTIFICADO_EMPRESA`,`fza_empresas`.`INSTANTEMODIF` AS `INSTANTEMODIF`,`fza_empresas`.`INSTANTEALTA` AS `INSTANTEALTA`,`fza_empresas`.`USUARIOALTA` AS `USUARIOALTA`,`fza_empresas`.`USUARIOMODIF` AS `USUARIOMODIF` from (`fza_empresas` left join `fza_ivas_grupos` on(`fza_empresas`.`GRUPO_ZONA_IVA_EMPRESA` = `fza_ivas_grupos`.`GRUPO_ZONA_IVA`));

-- Recreando vista: vi_empresas_retenciones
DROP VIEW IF EXISTS `vi_empresas_retenciones`;

CREATE ALGORITHM=UNDEFINED  VIEW `vi_empresas_retenciones` AS select `fza_empresas_retenciones`.`CODIGO_RETENCION` AS `CODIGO_RETENCION`,`fza_empresas_retenciones`.`CODIGO_EMPRESA_RETENCION` AS `CODIGO_EMPRESA_RETENCION`,`fza_empresas_retenciones`.`PORCENRETENCION_RETENCION` AS `PORCENRETENCION_RETENCION`,`fza_empresas_retenciones`.`FECHA_DESDE_RETENCION` AS `FECHA_DESDE_RETENCION`,`fza_empresas_retenciones`.`FECHA_HASTA_RETENCION` AS `FECHA_HASTA_RETENCION`,`fza_empresas_retenciones`.`INSTANTEMODIF` AS `INSTANTEMODIF`,`fza_empresas_retenciones`.`INSTANTEALTA` AS `INSTANTEALTA`,`fza_empresas_retenciones`.`USUARIOALTA` AS `USUARIOALTA`,`fza_empresas_retenciones`.`USUARIOMODIF` AS `USUARIOMODIF` from `fza_empresas_retenciones`;

-- Recreando vista: vi_empresas_series
DROP VIEW IF EXISTS `vi_empresas_series`;

CREATE ALGORITHM=UNDEFINED  VIEW `vi_empresas_series` AS select `fza_empresas_series`.`CODIGO_SERIE` AS `CODIGO_SERIE`,`fza_empresas_series`.`CODIGO_EMPRESA_SERIE` AS `CODIGO_EMPRESA_SERIE`,`fza_empresas_series`.`SERIE_SERIE` AS `SERIE_SERIE`,`fza_empresas_series`.`FECHA_DESDE_SERIE` AS `FECHA_DESDE_SERIE`,`fza_empresas_series`.`FECHA_HASTA_SERIE` AS `FECHA_HASTA_SERIE`,`fza_empresas_series`.`INSTANTEMODIF` AS `INSTANTEMODIF`,`fza_empresas_series`.`INSTANTEALTA` AS `INSTANTEALTA`,`fza_empresas_series`.`USUARIOALTA` AS `USUARIOALTA`,`fza_empresas_series`.`USUARIOMODIF` AS `USUARIOMODIF` from `fza_empresas_series`;

-- Recreando vista: vi_emp_busquedas
DROP VIEW IF EXISTS `vi_emp_busquedas`;

CREATE ALGORITHM=UNDEFINED  VIEW `vi_emp_busquedas` AS select `fza_empresas`.`CODIGO_EMPRESA` AS `CODIGO_EMPRESA`,`fza_empresas`.`RAZONSOCIAL_EMPRESA` AS `RAZONSOCIAL_EMPRESA`,`fza_empresas`.`NIF_EMPRESA` AS `NIF_EMPRESA`,`fza_empresas`.`MOVIL_EMPRESA` AS `MOVIL_EMPRESA`,`fza_empresas`.`EMAIL_EMPRESA` AS `EMAIL_EMPRESA`,`fza_empresas`.`DIRECCION1_EMPRESA` AS `DIRECCION1_EMPRESA`,`fza_empresas`.`DIRECCION2_EMPRESA` AS `DIRECCION2_EMPRESA`,`fza_empresas`.`CPOSTAL_EMPRESA` AS `CPOSTAL_EMPRESA`,`fza_empresas`.`POBLACION_EMPRESA` AS `POBLACION_EMPRESA`,`fza_empresas`.`PROVINCIA_EMPRESA` AS `PROVINCIA_EMPRESA`,`fza_empresas`.`CODIGO_PAIS_EMPRESA` AS `CODIGO_PAIS_EMPRESA`,`fza_empresas`.`NOMBRE_PAIS_EMPRESA` AS `NOMBRE_PAIS_EMPRESA`,`fza_empresas`.`SERIE_CONTADOR_EMPRESA` AS `SERIE_CONTADOR_EMPRESA`,`fza_empresas`.`GRUPO_ZONA_IVA_EMPRESA` AS `GRUPO_ZONA_IVA_EMPRESA`,`fza_empresas`.`ESRETENCIONES_EMPRESA` AS `ESRETENCIONES_EMPRESA`,`fza_empresas`.`ESREGIMENESPECIALAGRICOLA_EMPRESA` AS `ESREGIMENESPECIALAGRICOLA_EMPRESA`,`fza_empresas`.`TEXTO_LEGAL_FACTURA_EMPRESA` AS `TEXTO_LEGAL_FACTURA_EMPRESA` from `fza_empresas` where `fza_empresas`.`ACTIVO_EMPRESA` = 'S' order by `fza_empresas`.`ORDEN_EMPRESA`;

-- Recreando vista: vi_facturas
DROP VIEW IF EXISTS `vi_facturas`;

CREATE ALGORITHM=UNDEFINED  VIEW `vi_facturas` AS select `fza_facturas`.`FECHA_FACTURA` AS `FECHA_FACTURA`,`fza_facturas`.`NRO_FACTURA` AS `NRO_FACTURA`,`fza_facturas`.`SERIE_FACTURA` AS `SERIE_FACTURA`,`fza_facturas`.`TOTAL_LIQUIDO_FACTURA` AS `TOTAL_LIQUIDO_FACTURA`,`fza_facturas`.`PORCEN_RETENCION_FACTURA` AS `PORCEN_RETENCION_FACTURA`,`fza_facturas`.`TOTAL_RETENCION_FACTURA` AS `TOTAL_RETENCION_FACTURA`,`fza_facturas`.`TOTAL_IMPUESTOS_FACTURA` AS `TOTAL_IMPUESTOS_FACTURA`,`fza_facturas`.`TOTAL_BASES_FACTURA` AS `TOTAL_BASES_FACTURA`,`fza_facturas`.`FORMA_PAGO_FACTURA` AS `FORMA_PAGO_FACTURA`,`fza_facturas`.`CODIGO_EMPRESA_FACTURA` AS `CODIGO_EMPRESA_FACTURA`,`fza_facturas`.`RAZONSOCIAL_EMPRESA_FACTURA` AS `RAZONSOCIAL_EMPRESA_FACTURA`,`fza_facturas`.`NIF_EMPRESA_FACTURA` AS `NIF_EMPRESA_FACTURA`,`fza_facturas`.`MOVIL_EMPRESA_FACTURA` AS `MOVIL_EMPRESA_FACTURA`,`fza_facturas`.`EMAIL_EMPRESA_FACTURA` AS `EMAIL_EMPRESA_FACTURA`,`fza_facturas`.`DIRECCION1_EMPRESA_FACTURA` AS `DIRECCION1_EMPRESA_FACTURA`,`fza_facturas`.`DIRECCION2_EMPRESA_FACTURA` AS `DIRECCION2_EMPRESA_FACTURA`,`fza_facturas`.`POBLACION_EMPRESA_FACTURA` AS `POBLACION_EMPRESA_FACTURA`,`fza_facturas`.`PROVINCIA_EMPRESA_FACTURA` AS `PROVINCIA_EMPRESA_FACTURA`,`fza_facturas`.`NOMBRE_PAIS_EMPRESA_FACTURA` AS `NOMBRE_PAIS_EMPRESA_FACTURA`,`fza_facturas`.`CODIGO_PAIS_EMPRESA_FACTURA` AS `CODIGO_PAIS_EMPRESA_FACTURA`,`fza_facturas`.`CPOSTAL_EMPRESA_FACTURA` AS `CPOSTAL_EMPRESA_FACTURA`,`fza_facturas`.`ESRETENCIONES_EMPRESA_FACTURA` AS `ESRETENCIONES_EMPRESA_FACTURA`,`fza_facturas`.`GRUPO_ZONA_IVA_EMPRESA_FACTURA` AS `GRUPO_ZONA_IVA_EMPRESA_FACTURA`,`fza_facturas`.`ESREGIMENESPECIALAGRICOLA_EMPRESA_FACTURA` AS `ESREGIMENESPECIALAGRICOLA_EMPRESA_FACTURA`,`fza_facturas`.`CODIGO_CLIENTE_FACTURA` AS `CODIGO_CLIENTE_FACTURA`,`fza_facturas`.`RAZONSOCIAL_CLIENTE_FACTURA` AS `RAZONSOCIAL_CLIENTE_FACTURA`,`fza_facturas`.`NIF_CLIENTE_FACTURA` AS `NIF_CLIENTE_FACTURA`,`fza_facturas`.`MOVIL_CLIENTE_FACTURA` AS `MOVIL_CLIENTE_FACTURA`,`fza_facturas`.`EMAIL_CLIENTE_FACTURA` AS `EMAIL_CLIENTE_FACTURA`,`fza_facturas`.`DIRECCION1_CLIENTE_FACTURA` AS `DIRECCION1_CLIENTE_FACTURA`,`fza_facturas`.`DIRECCION2_CLIENTE_FACTURA` AS `DIRECCION2_CLIENTE_FACTURA`,`fza_facturas`.`POBLACION_CLIENTE_FACTURA` AS `POBLACION_CLIENTE_FACTURA`,`fza_facturas`.`PROVINCIA_CLIENTE_FACTURA` AS `PROVINCIA_CLIENTE_FACTURA`,`fza_facturas`.`CPOSTAL_CLIENTE_FACTURA` AS `CPOSTAL_CLIENTE_FACTURA`,`fza_facturas`.`NOMBRE_PAIS_CLIENTE_FACTURA` AS `NOMBRE_PAIS_CLIENTE_FACTURA`,`fza_facturas`.`CODIGO_PAIS_CLIENTE_FACTURA` AS `CODIGO_PAIS_CLIENTE_FACTURA`,`fza_facturas`.`ESIVA_RECARGO_CLIENTE_FACTURA` AS `ESIVA_RECARGO_CLIENTE_FACTURA`,`fza_facturas`.`ESIVA_EXENTO_CLIENTE_FACTURA` AS `ESIVA_EXENTO_CLIENTE_FACTURA`,`fza_facturas`.`ESREGIMENESPECIALAGRICOLA_CLIENTE_FACTURA` AS `ESREGIMENESPECIALAGRICOLA_CLIENTE_FACTURA`,`fza_facturas`.`ESRETENCIONES_CLIENTE_FACTURA` AS `ESRETENCIONES_CLIENTE_FACTURA`,`fza_facturas`.`TARIFA_ARTICULO_CLIENTE_FACTURA` AS `TARIFA_ARTICULO_CLIENTE_FACTURA`,`fza_facturas`.`ESIMP_INCL_TARIFA_CLIENTE_FACTURA` AS `ESIMP_INCL_TARIFA_CLIENTE_FACTURA`,`fza_facturas`.`ESINTRACOMUNITARIO_CLIENTE_FACTURA` AS `ESINTRACOMUNITARIO_CLIENTE_FACTURA`,`fza_facturas`.`ESIRPF_IMP_INCL_ZONA_IVA_FACTURA` AS `ESIRPF_IMP_INCL_ZONA_IVA_FACTURA`,`fza_facturas`.`ESAPLICA_RE_ZONA_IVA_FACTURA` AS `ESAPLICA_RE_ZONA_IVA_FACTURA`,`fza_facturas`.`ESIVAAGRICOLA_ZONA_IVA_FACTURA` AS `ESIVAAGRICOLA_ZONA_IVA_FACTURA`,`fza_facturas`.`PALABRA_REPORTS_ZONA_IVA_FACTURA` AS `PALABRA_REPORTS_ZONA_IVA_FACTURA`,`fza_facturas`.`CODIGO_IVA_FACTURA` AS `CODIGO_IVA_FACTURA`,`fza_facturas`.`ESVENTA_ACTIVO_FIJO_FACTURA` AS `ESVENTA_ACTIVO_FIJO_FACTURA`,`fza_facturas`.`PORCEN_IVAN_FACTURA` AS `PORCEN_IVAN_FACTURA`,`fza_facturas`.`TOTAL_IVAN_FACTURA` AS `TOTAL_IVAN_FACTURA`,`fza_facturas`.`PORCEN_REN_FACTURA` AS `PORCEN_REN_FACTURA`,`fza_facturas`.`TOTAL_REN_FACTURA` AS `TOTAL_REN_FACTURA`,`fza_facturas`.`TOTAL_BASEI_IVAN_FACTURA` AS `TOTAL_BASEI_IVAN_FACTURA`,`fza_facturas`.`PORCEN_IVAR_FACTURA` AS `PORCEN_IVAR_FACTURA`,`fza_facturas`.`TOTAL_IVAR_FACTURA` AS `TOTAL_IVAR_FACTURA`,`fza_facturas`.`PORCEN_RER_FACTURA` AS `PORCEN_RER_FACTURA`,`fza_facturas`.`TOTAL_RER_FACTURA` AS `TOTAL_RER_FACTURA`,`fza_facturas`.`TOTAL_BASEI_IVAR_FACTURA` AS `TOTAL_BASEI_IVAR_FACTURA`,`fza_facturas`.`PORCEN_IVAS_FACTURA` AS `PORCEN_IVAS_FACTURA`,`fza_facturas`.`TOTAL_IVAS_FACTURA` AS `TOTAL_IVAS_FACTURA`,`fza_facturas`.`PORCEN_RES_FACTURA` AS `PORCEN_RES_FACTURA`,`fza_facturas`.`TOTAL_RES_FACTURA` AS `TOTAL_RES_FACTURA`,`fza_facturas`.`TOTAL_BASEI_IVAS_FACTURA` AS `TOTAL_BASEI_IVAS_FACTURA`,`fza_facturas`.`PORCEN_IVAE_FACTURA` AS `PORCEN_IVAE_FACTURA`,`fza_facturas`.`TOTAL_IVAE_FACTURA` AS `TOTAL_IVAE_FACTURA`,`fza_facturas`.`PORCEN_REE_FACTURA` AS `PORCEN_REE_FACTURA`,`fza_facturas`.`TOTAL_REE_FACTURA` AS `TOTAL_REE_FACTURA`,`fza_facturas`.`TOTAL_BASEI_IVAE_FACTURA` AS `TOTAL_BASEI_IVAE_FACTURA`,`fza_facturas`.`NRO_FACTURA_ABONO_FACTURA` AS `NRO_FACTURA_ABONO_FACTURA`,`fza_facturas`.`SERIE_FACTURA_ABONO_FACTURA` AS `SERIE_FACTURA_ABONO_FACTURA`,`fza_facturas`.`TEXTO_LEGAL_FACTURA_CLIENTE_FACTURA` AS `TEXTO_LEGAL_FACTURA_CLIENTE_FACTURA`,`fza_facturas`.`TEXTO_LEGAL_FACTURA_EMPRESA_FACTURA` AS `TEXTO_LEGAL_FACTURA_EMPRESA_FACTURA`,`fza_facturas`.`DOCUMENTO_FACTURA` AS `DOCUMENTO_FACTURA`,`fza_facturas`.`XML_FACTURA` AS `XML_FACTURA`,`fza_facturas`.`COMENTARIOS_FACTURA` AS `COMENTARIOS_FACTURA`,`fza_facturas`.`CONTADOR_LINEAS_FACTURA` AS `CONTADOR_LINEAS_FACTURA`,`fza_facturas`.`ESCREARARTICULOS_FACTURA` AS `ESCREARARTICULOS_FACTURA`,`fza_facturas`.`ESDESCRIPCIONES_AMP_FACTURA` AS `ESDESCRIPCIONES_AMP_FACTURA`,`fza_facturas`.`ESFECHADEENTREGA_FACTURA` AS `ESFECHADEENTREGA_FACTURA`,`fza_facturas`.`INSTANTEMODIF` AS `INSTANTEMODIF`,`fza_facturas`.`INSTANTEALTA` AS `INSTANTEALTA`,`fza_facturas`.`USUARIOALTA` AS `USUARIOALTA`,`fza_facturas`.`USUARIOMODIF` AS `USUARIOMODIF`,`fza_formapago`.`DESCRIPCION_FORMAPAGO` AS `DESCRIPCION_FORMAPAGO`,`fza_facturas`.`ESCONSOLIDADA_FACTURA` AS `ESCONSOLIDADA_FACTURA`,`fza_facturas`.`INSTANTECONSO_FACTURA` AS `INSTANTECONSO_FACTURA` from (`fza_facturas` left join `fza_formapago` on(`fza_facturas`.`FORMA_PAGO_FACTURA` = `fza_formapago`.`CODIGO_FORMAPAGO`)) order by `fza_facturas`.`FECHA_FACTURA` desc;

-- Recreando vista: vi_facturas_lineas
DROP VIEW IF EXISTS `vi_facturas_lineas`;

CREATE ALGORITHM=UNDEFINED  VIEW `vi_facturas_lineas` AS select `fza_facturas_lineas`.`NRO_FACTURA_LINEA` AS `NRO_FACTURA_LINEA`,`fza_facturas_lineas`.`SERIE_FACTURA_LINEA` AS `SERIE_FACTURA_LINEA`,`fza_facturas_lineas`.`LINEA_FACTURA_LINEA` AS `LINEA_FACTURA_LINEA`,`fza_facturas_lineas`.`CODIGO_ARTICULO_FACTURA_LINEA` AS `CODIGO_ARTICULO_FACTURA_LINEA`,`fza_facturas_lineas`.`CODIGO_FAMILIA_FACTURA_LINEA` AS `CODIGO_FAMILIA_FACTURA_LINEA`,`fza_facturas_lineas`.`NOMBRE_FAMILIA_FACTURA_LINEA` AS `NOMBRE_FAMILIA_FACTURA_LINEA`,`fza_facturas_lineas`.`ESPROVEEDORPRINCIPAL_FACTURA_LINEA` AS `ESPROVEEDORPRINCIPAL_FACTURA_LINEA`,`fza_facturas_lineas`.`CODIGO_PROVEEDOR_FACTURA_LINEA` AS `CODIGO_PROVEEDOR_FACTURA_LINEA`,`fza_facturas_lineas`.`RAZONSOCIAL_PROVEEDOR_FACTURA_LINEA` AS `RAZONSOCIAL_PROVEEDOR_FACTURA_LINEA`,`fza_facturas_lineas`.`PRECIO_ULT_COMPRA_FACTURA_LINEA` AS `PRECIO_ULT_COMPRA_FACTURA_LINEA`,`fza_facturas_lineas`.`FECHA_ENTREGA_FACTURA_LINEA` AS `FECHA_ENTREGA_FACTURA_LINEA`,`fza_facturas_lineas`.`TIPO_CANTIDAD_ARTICULO_FACTURA_LINEA` AS `TIPO_CANTIDAD_ARTICULO_FACTURA_LINEA`,`fza_facturas_lineas`.`ESIMP_INCL_TARIFA_FACTURA_LINEA` AS `ESIMP_INCL_TARIFA_FACTURA_LINEA`,`fza_facturas_lineas`.`TIPOIVA_ARTICULO_FACTURA_LINEA` AS `TIPOIVA_ARTICULO_FACTURA_LINEA`,`fza_facturas_lineas`.`DESCRIPCION_ARTICULO_FACTURA_LINEA` AS `DESCRIPCION_ARTICULO_FACTURA_LINEA`,`fza_facturas_lineas`.`CODIGO_TARIFA_FACTURA_LINEA` AS `CODIGO_TARIFA_FACTURA_LINEA`,`fza_facturas_lineas`.`CANTIDAD_FACTURA_LINEA` AS `CANTIDAD_FACTURA_LINEA`,`fza_facturas_lineas`.`PRECIOSALIDA_FACTURA_LINEA` AS `PRECIOSALIDA_FACTURA_LINEA`,`fza_facturas_lineas`.`PORCEN_DTO_FACTURA_LINEA` AS `PORCEN_DTO_FACTURA_LINEA`,`fza_facturas_lineas`.`PRECIO_DTO_FACTURA_LINEA` AS `PRECIO_DTO_FACTURA_LINEA`,`fza_facturas_lineas`.`PRECIOVENTA_SIVA_ARTICULO_FACTURA_LINEA` AS `PRECIOVENTA_SIVA_ARTICULO_FACTURA_LINEA`,`fza_facturas_lineas`.`PORCEN_IVA_FACTURA_LINEA` AS `PORCEN_IVA_FACTURA_LINEA`,`fza_facturas_lineas`.`PRECIOVENTA_CIVA_ARTICULO_FACTURA_LINEA` AS `PRECIOVENTA_CIVA_ARTICULO_FACTURA_LINEA`,`fza_facturas_lineas`.`TOTAL_FACTURA_LINEA` AS `TOTAL_FACTURA_LINEA`,`fza_facturas_lineas`.`TOTAL_FACTURASIVA_LINEA` AS `TOTAL_FACTURASIVA_LINEA`,`fza_facturas_lineas`.`INSTANTEMODIF` AS `INSTANTEMODIF`,`fza_facturas_lineas`.`INSTANTEALTA` AS `INSTANTEALTA`,`fza_facturas_lineas`.`USUARIOALTA` AS `USUARIOALTA`,`fza_facturas_lineas`.`USUARIOMODIF` AS `USUARIOMODIF` from `fza_facturas_lineas`;

-- Recreando vista: vi_facturas_lineas_print
DROP VIEW IF EXISTS `vi_facturas_lineas_print`;

CREATE ALGORITHM=UNDEFINED  VIEW `vi_facturas_lineas_print` AS select `fza_facturas_lineas`.`NRO_FACTURA_LINEA` AS `NRO_FACTURA_LINEA`,`fza_facturas_lineas`.`SERIE_FACTURA_LINEA` AS `SERIE_FACTURA_LINEA`,`fza_facturas_lineas`.`LINEA_FACTURA_LINEA` AS `LINEA_FACTURA_LINEA`,`fza_facturas_lineas`.`CODIGO_ARTICULO_FACTURA_LINEA` AS `CODIGO_ARTICULO_FACTURA_LINEA`,`fza_facturas_lineas`.`CODIGO_FAMILIA_FACTURA_LINEA` AS `CODIGO_FAMILIA_FACTURA_LINEA`,`fza_facturas_lineas`.`NOMBRE_FAMILIA_FACTURA_LINEA` AS `NOMBRE_FAMILIA_FACTURA_LINEA`,`fza_facturas_lineas`.`FECHA_ENTREGA_FACTURA_LINEA` AS `FECHA_ENTREGA_FACTURA_LINEA`,`fza_facturas_lineas`.`TIPO_CANTIDAD_ARTICULO_FACTURA_LINEA` AS `TIPO_CANTIDAD_ARTICULO_FACTURA_LINEA`,`fza_facturas_lineas`.`ESIMP_INCL_TARIFA_FACTURA_LINEA` AS `ESIMP_INCL_TARIFA_FACTURA_LINEA`,`fza_facturas_lineas`.`TIPOIVA_ARTICULO_FACTURA_LINEA` AS `TIPOIVA_ARTICULO_FACTURA_LINEA`,`fza_facturas_lineas`.`DESCRIPCION_ARTICULO_FACTURA_LINEA` AS `DESCRIPCION_ARTICULO_FACTURA_LINEA`,`fza_facturas_lineas`.`CODIGO_TARIFA_FACTURA_LINEA` AS `CODIGO_TARIFA_FACTURA_LINEA`,`fza_facturas_lineas`.`CANTIDAD_FACTURA_LINEA` AS `CANTIDAD_FACTURA_LINEA`,`fza_facturas_lineas`.`PRECIOSALIDA_FACTURA_LINEA` AS `PRECIOSALIDA_FACTURA_LINEA`,`fza_facturas_lineas`.`PORCEN_DTO_FACTURA_LINEA` AS `PORCEN_DTO_FACTURA_LINEA`,`fza_facturas_lineas`.`PRECIO_DTO_FACTURA_LINEA` AS `PRECIO_DTO_FACTURA_LINEA`,`fza_facturas_lineas`.`PRECIOVENTA_SIVA_ARTICULO_FACTURA_LINEA` AS `PRECIOVENTA_SIVA_ARTICULO_FACTURA_LINEA`,`fza_facturas_lineas`.`PORCEN_IVA_FACTURA_LINEA` AS `PORCEN_IVA_FACTURA_LINEA`,`fza_facturas_lineas`.`PRECIOVENTA_CIVA_ARTICULO_FACTURA_LINEA` AS `PRECIOVENTA_CIVA_ARTICULO_FACTURA_LINEA`,`fza_facturas_lineas`.`TOTAL_FACTURA_LINEA` AS `TOTAL_FACTURA_LINEA`,`fza_facturas_lineas`.`TOTAL_FACTURASIVA_LINEA` AS `TOTAL_FACTURASIVA_LINEA`,`fza_facturas_lineas`.`INSTANTEMODIF` AS `INSTANTEMODIF`,`fza_facturas_lineas`.`INSTANTEALTA` AS `INSTANTEALTA`,`fza_facturas_lineas`.`USUARIOALTA` AS `USUARIOALTA`,`fza_facturas_lineas`.`USUARIOMODIF` AS `USUARIOMODIF` from `fza_facturas_lineas`;

-- Recreando vista: vi_facturas_print
DROP VIEW IF EXISTS `vi_facturas_print`;

CREATE ALGORITHM=UNDEFINED  VIEW `vi_facturas_print` AS select `fza_facturas`.`FECHA_FACTURA` AS `FECHA_FACTURA`,`fza_facturas`.`NRO_FACTURA` AS `NRO_FACTURA`,`fza_facturas`.`SERIE_FACTURA` AS `SERIE_FACTURA`,`fza_facturas`.`TOTAL_LIQUIDO_FACTURA` AS `TOTAL_LIQUIDO_FACTURA`,`fza_facturas`.`PORCEN_RETENCION_FACTURA` AS `PORCEN_RETENCION_FACTURA`,`fza_facturas`.`TOTAL_RETENCION_FACTURA` AS `TOTAL_RETENCION_FACTURA`,`fza_facturas`.`TOTAL_IMPUESTOS_FACTURA` AS `TOTAL_IMPUESTOS_FACTURA`,`fza_facturas`.`TOTAL_BASES_FACTURA` AS `TOTAL_BASES_FACTURA`,`fza_facturas`.`FORMA_PAGO_FACTURA` AS `FORMA_PAGO_FACTURA`,`fza_facturas`.`CODIGO_EMPRESA_FACTURA` AS `CODIGO_EMPRESA_FACTURA`,`fza_facturas`.`RAZONSOCIAL_EMPRESA_FACTURA` AS `RAZONSOCIAL_EMPRESA_FACTURA`,`fza_facturas`.`NIF_EMPRESA_FACTURA` AS `NIF_EMPRESA_FACTURA`,`fza_facturas`.`MOVIL_EMPRESA_FACTURA` AS `MOVIL_EMPRESA_FACTURA`,`fza_facturas`.`EMAIL_EMPRESA_FACTURA` AS `EMAIL_EMPRESA_FACTURA`,`fza_facturas`.`DIRECCION1_EMPRESA_FACTURA` AS `DIRECCION1_EMPRESA_FACTURA`,`fza_facturas`.`DIRECCION2_EMPRESA_FACTURA` AS `DIRECCION2_EMPRESA_FACTURA`,`fza_facturas`.`POBLACION_EMPRESA_FACTURA` AS `POBLACION_EMPRESA_FACTURA`,`fza_facturas`.`PROVINCIA_EMPRESA_FACTURA` AS `PROVINCIA_EMPRESA_FACTURA`,`fza_facturas`.`NOMBRE_PAIS_EMPRESA_FACTURA` AS `NOMBRE_PAIS_EMPRESA_FACTURA`,`fza_facturas`.`CODIGO_PAIS_EMPRESA_FACTURA` AS `CODIGO_PAIS_EMPRESA_FACTURA`,`fza_facturas`.`CPOSTAL_EMPRESA_FACTURA` AS `CPOSTAL_EMPRESA_FACTURA`,`fza_facturas`.`ESRETENCIONES_EMPRESA_FACTURA` AS `ESRETENCIONES_EMPRESA_FACTURA`,`fza_facturas`.`GRUPO_ZONA_IVA_EMPRESA_FACTURA` AS `GRUPO_ZONA_IVA_EMPRESA_FACTURA`,`fza_facturas`.`ESREGIMENESPECIALAGRICOLA_EMPRESA_FACTURA` AS `ESREGIMENESPECIALAGRICOLA_EMPRESA_FACTURA`,`fza_facturas`.`CODIGO_CLIENTE_FACTURA` AS `CODIGO_CLIENTE_FACTURA`,`fza_facturas`.`RAZONSOCIAL_CLIENTE_FACTURA` AS `RAZONSOCIAL_CLIENTE_FACTURA`,`fza_facturas`.`NIF_CLIENTE_FACTURA` AS `NIF_CLIENTE_FACTURA`,`fza_facturas`.`MOVIL_CLIENTE_FACTURA` AS `MOVIL_CLIENTE_FACTURA`,`fza_facturas`.`EMAIL_CLIENTE_FACTURA` AS `EMAIL_CLIENTE_FACTURA`,`fza_facturas`.`DIRECCION1_CLIENTE_FACTURA` AS `DIRECCION1_CLIENTE_FACTURA`,`fza_facturas`.`DIRECCION2_CLIENTE_FACTURA` AS `DIRECCION2_CLIENTE_FACTURA`,`fza_facturas`.`POBLACION_CLIENTE_FACTURA` AS `POBLACION_CLIENTE_FACTURA`,`fza_facturas`.`PROVINCIA_CLIENTE_FACTURA` AS `PROVINCIA_CLIENTE_FACTURA`,`fza_facturas`.`CPOSTAL_CLIENTE_FACTURA` AS `CPOSTAL_CLIENTE_FACTURA`,`fza_facturas`.`NOMBRE_PAIS_CLIENTE_FACTURA` AS `NOMBRE_PAIS_CLIENTE_FACTURA`,`fza_facturas`.`CODIGO_PAIS_CLIENTE_FACTURA` AS `CODIGO_PAIS_CLIENTE_FACTURA`,`fza_facturas`.`ESIVA_RECARGO_CLIENTE_FACTURA` AS `ESIVA_RECARGO_CLIENTE_FACTURA`,`fza_facturas`.`ESIVA_EXENTO_CLIENTE_FACTURA` AS `ESIVA_EXENTO_CLIENTE_FACTURA`,`fza_facturas`.`ESREGIMENESPECIALAGRICOLA_CLIENTE_FACTURA` AS `ESREGIMENESPECIALAGRICOLA_CLIENTE_FACTURA`,`fza_facturas`.`ESRETENCIONES_CLIENTE_FACTURA` AS `ESRETENCIONES_CLIENTE_FACTURA`,`fza_facturas`.`TARIFA_ARTICULO_CLIENTE_FACTURA` AS `TARIFA_ARTICULO_CLIENTE_FACTURA`,`fza_facturas`.`ESIMP_INCL_TARIFA_CLIENTE_FACTURA` AS `ESIMP_INCL_TARIFA_CLIENTE_FACTURA`,`fza_facturas`.`ESINTRACOMUNITARIO_CLIENTE_FACTURA` AS `ESINTRACOMUNITARIO_CLIENTE_FACTURA`,`fza_facturas`.`ESIRPF_IMP_INCL_ZONA_IVA_FACTURA` AS `ESIRPF_IMP_INCL_ZONA_IVA_FACTURA`,`fza_facturas`.`ESAPLICA_RE_ZONA_IVA_FACTURA` AS `ESAPLICA_RE_ZONA_IVA_FACTURA`,`fza_facturas`.`ESIVAAGRICOLA_ZONA_IVA_FACTURA` AS `ESIVAAGRICOLA_ZONA_IVA_FACTURA`,`fza_facturas`.`PALABRA_REPORTS_ZONA_IVA_FACTURA` AS `PALABRA_REPORTS_ZONA_IVA_FACTURA`,`fza_facturas`.`CODIGO_IVA_FACTURA` AS `CODIGO_IVA_FACTURA`,`fza_facturas`.`ESVENTA_ACTIVO_FIJO_FACTURA` AS `ESVENTA_ACTIVO_FIJO_FACTURA`,`fza_facturas`.`PORCEN_IVAN_FACTURA` AS `PORCEN_IVAN_FACTURA`,`fza_facturas`.`TOTAL_IVAN_FACTURA` AS `TOTAL_IVAN_FACTURA`,`fza_facturas`.`PORCEN_REN_FACTURA` AS `PORCEN_REN_FACTURA`,`fza_facturas`.`TOTAL_REN_FACTURA` AS `TOTAL_REN_FACTURA`,`fza_facturas`.`TOTAL_BASEI_IVAN_FACTURA` AS `TOTAL_BASEI_IVAN_FACTURA`,`fza_facturas`.`PORCEN_IVAR_FACTURA` AS `PORCEN_IVAR_FACTURA`,`fza_facturas`.`TOTAL_IVAR_FACTURA` AS `TOTAL_IVAR_FACTURA`,`fza_facturas`.`PORCEN_RER_FACTURA` AS `PORCEN_RER_FACTURA`,`fza_facturas`.`TOTAL_RER_FACTURA` AS `TOTAL_RER_FACTURA`,`fza_facturas`.`TOTAL_BASEI_IVAR_FACTURA` AS `TOTAL_BASEI_IVAR_FACTURA`,`fza_facturas`.`PORCEN_IVAS_FACTURA` AS `PORCEN_IVAS_FACTURA`,`fza_facturas`.`TOTAL_IVAS_FACTURA` AS `TOTAL_IVAS_FACTURA`,`fza_facturas`.`PORCEN_RES_FACTURA` AS `PORCEN_RES_FACTURA`,`fza_facturas`.`TOTAL_RES_FACTURA` AS `TOTAL_RES_FACTURA`,`fza_facturas`.`TOTAL_BASEI_IVAS_FACTURA` AS `TOTAL_BASEI_IVAS_FACTURA`,`fza_facturas`.`PORCEN_IVAE_FACTURA` AS `PORCEN_IVAE_FACTURA`,`fza_facturas`.`TOTAL_IVAE_FACTURA` AS `TOTAL_IVAE_FACTURA`,`fza_facturas`.`PORCEN_REE_FACTURA` AS `PORCEN_REE_FACTURA`,`fza_facturas`.`TOTAL_REE_FACTURA` AS `TOTAL_REE_FACTURA`,`fza_facturas`.`TOTAL_BASEI_IVAE_FACTURA` AS `TOTAL_BASEI_IVAE_FACTURA`,`fza_facturas`.`NRO_FACTURA_ABONO_FACTURA` AS `NRO_FACTURA_ABONO_FACTURA`,`fza_facturas`.`SERIE_FACTURA_ABONO_FACTURA` AS `SERIE_FACTURA_ABONO_FACTURA`,`fza_facturas`.`TEXTO_LEGAL_FACTURA_CLIENTE_FACTURA` AS `TEXTO_LEGAL_FACTURA_CLIENTE_FACTURA`,`fza_facturas`.`TEXTO_LEGAL_FACTURA_EMPRESA_FACTURA` AS `TEXTO_LEGAL_FACTURA_EMPRESA_FACTURA`,`fza_facturas`.`DOCUMENTO_FACTURA` AS `DOCUMENTO_FACTURA`,`fza_facturas`.`COMENTARIOS_FACTURA` AS `COMENTARIOS_FACTURA`,`fza_facturas`.`CONTADOR_LINEAS_FACTURA` AS `CONTADOR_LINEAS_FACTURA`,`fza_facturas`.`ESCREARARTICULOS_FACTURA` AS `ESCREARARTICULOS_FACTURA`,`fza_facturas`.`ESDESCRIPCIONES_AMP_FACTURA` AS `ESDESCRIPCIONES_AMP_FACTURA`,`fza_facturas`.`ESFECHADEENTREGA_FACTURA` AS `ESFECHADEENTREGA_FACTURA`,`fza_facturas`.`INSTANTEMODIF` AS `INSTANTEMODIF`,`fza_facturas`.`INSTANTEALTA` AS `INSTANTEALTA`,`fza_facturas`.`USUARIOALTA` AS `USUARIOALTA`,`fza_facturas`.`USUARIOMODIF` AS `USUARIOMODIF`,`fza_formapago`.`DESCRIPCION_FORMAPAGO` AS `DESCRIPCION_FORMAPAGO`,`fza_formapago`.`ESCONTADO_FORMAPAGO` AS `ESCONTADO_FORMAPAGO`,(select group_concat(' ',date_format(`fza_recibos`.`FECHA_VENCIMIENTO_RECIBO`,'%d/%m/%Y'),'=> ',format(`fza_recibos`.`EUROS_RECIBO`,2),'€' separator ',') from `fza_recibos` where `fza_recibos`.`NRO_FACTURA_RECIBO` = `fza_facturas`.`NRO_FACTURA` and `fza_recibos`.`SERIE_FACTURA_RECIBO` = `fza_facturas`.`SERIE_FACTURA`) AS `VENCIMIENTOS_RECIBOS`,`fza_empresas`.`IBAN_EMPRESA` AS `IBAN_EMPRESA`,`fza_clientes`.`IBAN_CLIENTE` AS `IBAN_CLIENTE`,`fza_formapago`.`ESVERBANCOEMPRESA_FORMAPAGO` AS `ESVERBANCOEMPRESA_FORMAPAGO` from (((`fza_facturas` left join `fza_formapago` on(`fza_facturas`.`FORMA_PAGO_FACTURA` = `fza_formapago`.`CODIGO_FORMAPAGO`)) left join `fza_empresas` on(`fza_facturas`.`CODIGO_EMPRESA_FACTURA` = `fza_empresas`.`CODIGO_EMPRESA`)) left join `fza_clientes` on(`fza_facturas`.`CODIGO_CLIENTE_FACTURA` = `fza_clientes`.`CODIGO_CLIENTE`)) order by `fza_facturas`.`FECHA_FACTURA` desc;

-- Recreando vista: vi_fac_busquedas
DROP VIEW IF EXISTS `vi_fac_busquedas`;

CREATE ALGORITHM=UNDEFINED  VIEW `vi_fac_busquedas` AS select `fza_facturas`.`FECHA_FACTURA` AS `FECHA_FACTURA`,`fza_facturas`.`NRO_FACTURA` AS `NRO_FACTURA`,`fza_facturas`.`SERIE_FACTURA` AS `SERIE_FACTURA`,`fza_facturas`.`TOTAL_LIQUIDO_FACTURA` AS `TOTAL_LIQUIDO_FACTURA`,`fza_facturas`.`PORCEN_RETENCION_FACTURA` AS `PORCEN_RETENCION_FACTURA`,`fza_facturas`.`TOTAL_RETENCION_FACTURA` AS `TOTAL_RETENCION_FACTURA`,`fza_facturas`.`TOTAL_IMPUESTOS_FACTURA` AS `TOTAL_IMPUESTOS_FACTURA`,`fza_facturas`.`TOTAL_BASES_FACTURA` AS `TOTAL_BASES_FACTURA`,`fza_facturas`.`FORMA_PAGO_FACTURA` AS `FORMA_PAGO_FACTURA`,`fza_formapago`.`DESCRIPCION_FORMAPAGO` AS `DESCRIPCION_FORMAPAGO`,`fza_facturas`.`CODIGO_EMPRESA_FACTURA` AS `CODIGO_EMPRESA_FACTURA`,`fza_facturas`.`RAZONSOCIAL_EMPRESA_FACTURA` AS `RAZONSOCIAL_EMPRESA_FACTURA`,`fza_facturas`.`NIF_EMPRESA_FACTURA` AS `NIF_EMPRESA_FACTURA`,`fza_facturas`.`MOVIL_EMPRESA_FACTURA` AS `MOVIL_EMPRESA_FACTURA`,`fza_facturas`.`EMAIL_EMPRESA_FACTURA` AS `EMAIL_EMPRESA_FACTURA`,`fza_facturas`.`DIRECCION1_EMPRESA_FACTURA` AS `DIRECCION1_EMPRESA_FACTURA`,`fza_facturas`.`DIRECCION2_EMPRESA_FACTURA` AS `DIRECCION2_EMPRESA_FACTURA`,`fza_facturas`.`POBLACION_EMPRESA_FACTURA` AS `POBLACION_EMPRESA_FACTURA`,`fza_facturas`.`PROVINCIA_EMPRESA_FACTURA` AS `PROVINCIA_EMPRESA_FACTURA`,`fza_facturas`.`NOMBRE_PAIS_EMPRESA_FACTURA` AS `NOMBRE_PAIS_EMPRESA_FACTURA`,`fza_facturas`.`CPOSTAL_EMPRESA_FACTURA` AS `CPOSTAL_EMPRESA_FACTURA`,`fza_facturas`.`ESRETENCIONES_EMPRESA_FACTURA` AS `ESRETENCIONES_EMPRESA_FACTURA`,`fza_facturas`.`GRUPO_ZONA_IVA_EMPRESA_FACTURA` AS `GRUPO_ZONA_IVA_EMPRESA_FACTURA`,`fza_facturas`.`ESREGIMENESPECIALAGRICOLA_EMPRESA_FACTURA` AS `ESREGIMENESPECIALAGRICOLA_EMPRESA_FACTURA`,`fza_facturas`.`CODIGO_CLIENTE_FACTURA` AS `CODIGO_CLIENTE_FACTURA`,`fza_facturas`.`RAZONSOCIAL_CLIENTE_FACTURA` AS `RAZONSOCIAL_CLIENTE_FACTURA`,`fza_facturas`.`NIF_CLIENTE_FACTURA` AS `NIF_CLIENTE_FACTURA`,`fza_facturas`.`MOVIL_CLIENTE_FACTURA` AS `MOVIL_CLIENTE_FACTURA`,`fza_facturas`.`EMAIL_CLIENTE_FACTURA` AS `EMAIL_CLIENTE_FACTURA`,`fza_facturas`.`DIRECCION1_CLIENTE_FACTURA` AS `DIRECCION1_CLIENTE_FACTURA`,`fza_facturas`.`DIRECCION2_CLIENTE_FACTURA` AS `DIRECCION2_CLIENTE_FACTURA`,`fza_facturas`.`POBLACION_CLIENTE_FACTURA` AS `POBLACION_CLIENTE_FACTURA`,`fza_facturas`.`PROVINCIA_CLIENTE_FACTURA` AS `PROVINCIA_CLIENTE_FACTURA`,`fza_facturas`.`CPOSTAL_CLIENTE_FACTURA` AS `CPOSTAL_CLIENTE_FACTURA`,`fza_facturas`.`NOMBRE_PAIS_CLIENTE_FACTURA` AS `NOMBRE_PAIS_CLIENTE_FACTURA`,`fza_facturas`.`ESIVA_RECARGO_CLIENTE_FACTURA` AS `ESIVA_RECARGO_CLIENTE_FACTURA`,`fza_facturas`.`ESIVA_EXENTO_CLIENTE_FACTURA` AS `ESIVA_EXENTO_CLIENTE_FACTURA`,`fza_facturas`.`ESREGIMENESPECIALAGRICOLA_CLIENTE_FACTURA` AS `ESREGIMENESPECIALAGRICOLA_CLIENTE_FACTURA`,`fza_facturas`.`ESRETENCIONES_CLIENTE_FACTURA` AS `ESRETENCIONES_CLIENTE_FACTURA`,`fza_facturas`.`TARIFA_ARTICULO_CLIENTE_FACTURA` AS `TARIFA_ARTICULO_CLIENTE_FACTURA`,`fza_facturas`.`ESIMP_INCL_TARIFA_CLIENTE_FACTURA` AS `ESIMP_INCL_TARIFA_CLIENTE_FACTURA`,`fza_facturas`.`ESINTRACOMUNITARIO_CLIENTE_FACTURA` AS `ESINTRACOMUNITARIO_CLIENTE_FACTURA`,`fza_facturas`.`ESIRPF_IMP_INCL_ZONA_IVA_FACTURA` AS `ESIRPF_IMP_INCL_ZONA_IVA_FACTURA`,`fza_facturas`.`ESAPLICA_RE_ZONA_IVA_FACTURA` AS `ESAPLICA_RE_ZONA_IVA_FACTURA`,`fza_facturas`.`ESIVAAGRICOLA_ZONA_IVA_FACTURA` AS `ESIVAAGRICOLA_ZONA_IVA_FACTURA`,`fza_facturas`.`PALABRA_REPORTS_ZONA_IVA_FACTURA` AS `PALABRA_REPORTS_ZONA_IVA_FACTURA`,`fza_facturas`.`CODIGO_IVA_FACTURA` AS `CODIGO_IVA_FACTURA`,`fza_facturas`.`ESVENTA_ACTIVO_FIJO_FACTURA` AS `ESVENTA_ACTIVO_FIJO_FACTURA`,`fza_facturas`.`PORCEN_IVAN_FACTURA` AS `PORCEN_IVAN_FACTURA`,`fza_facturas`.`TOTAL_IVAN_FACTURA` AS `TOTAL_IVAN_FACTURA`,`fza_facturas`.`PORCEN_REN_FACTURA` AS `PORCEN_REN_FACTURA`,`fza_facturas`.`TOTAL_REN_FACTURA` AS `TOTAL_REN_FACTURA`,`fza_facturas`.`TOTAL_BASEI_IVAN_FACTURA` AS `TOTAL_BASEI_IVAN_FACTURA`,`fza_facturas`.`PORCEN_IVAR_FACTURA` AS `PORCEN_IVAR_FACTURA`,`fza_facturas`.`TOTAL_IVAR_FACTURA` AS `TOTAL_IVAR_FACTURA`,`fza_facturas`.`PORCEN_RER_FACTURA` AS `PORCEN_RER_FACTURA`,`fza_facturas`.`TOTAL_RER_FACTURA` AS `TOTAL_RER_FACTURA`,`fza_facturas`.`TOTAL_BASEI_IVAR_FACTURA` AS `TOTAL_BASEI_IVAR_FACTURA`,`fza_facturas`.`PORCEN_IVAS_FACTURA` AS `PORCEN_IVAS_FACTURA`,`fza_facturas`.`TOTAL_IVAS_FACTURA` AS `TOTAL_IVAS_FACTURA`,`fza_facturas`.`PORCEN_RES_FACTURA` AS `PORCEN_RES_FACTURA`,`fza_facturas`.`TOTAL_RES_FACTURA` AS `TOTAL_RES_FACTURA`,`fza_facturas`.`TOTAL_BASEI_IVAS_FACTURA` AS `TOTAL_BASEI_IVAS_FACTURA`,`fza_facturas`.`PORCEN_IVAE_FACTURA` AS `PORCEN_IVAE_FACTURA`,`fza_facturas`.`TOTAL_IVAE_FACTURA` AS `TOTAL_IVAE_FACTURA`,`fza_facturas`.`PORCEN_REE_FACTURA` AS `PORCEN_REE_FACTURA`,`fza_facturas`.`TOTAL_REE_FACTURA` AS `TOTAL_REE_FACTURA`,`fza_facturas`.`TOTAL_BASEI_IVAE_FACTURA` AS `TOTAL_BASEI_IVAE_FACTURA` from (`fza_facturas` left join `fza_formapago` on(`fza_facturas`.`FORMA_PAGO_FACTURA` = `fza_formapago`.`CODIGO_FORMAPAGO`));

-- Recreando vista: vi_fac_lin_busquedas
DROP VIEW IF EXISTS `vi_fac_lin_busquedas`;

CREATE ALGORITHM=UNDEFINED  VIEW `vi_fac_lin_busquedas` AS select `fza_facturas_lineas`.`NRO_FACTURA_LINEA` AS `NRO_FACTURA_LINEA`,`fza_facturas_lineas`.`SERIE_FACTURA_LINEA` AS `SERIE_FACTURA_LINEA`,`fza_facturas_lineas`.`LINEA_FACTURA_LINEA` AS `LINEA_FACTURA_LINEA`,`fza_facturas_lineas`.`CODIGO_ARTICULO_FACTURA_LINEA` AS `CODIGO_ARTICULO_FACTURA_LINEA`,`fza_facturas_lineas`.`CODIGO_FAMILIA_FACTURA_LINEA` AS `CODIGO_FAMILIA_FACTURA_LINEA`,`fza_facturas_lineas`.`NOMBRE_FAMILIA_FACTURA_LINEA` AS `NOMBRE_FAMILIA_FACTURA_LINEA`,`fza_facturas_lineas`.`FECHA_ENTREGA_FACTURA_LINEA` AS `FECHA_ENTREGA_FACTURA_LINEA`,`fza_facturas_lineas`.`TIPO_CANTIDAD_ARTICULO_FACTURA_LINEA` AS `TIPO_CANTIDAD_ARTICULO_FACTURA_LINEA`,`fza_facturas_lineas`.`ESIMP_INCL_TARIFA_FACTURA_LINEA` AS `ESIMP_INCL_TARIFA_FACTURA_LINEA`,`fza_facturas_lineas`.`TIPOIVA_ARTICULO_FACTURA_LINEA` AS `TIPOIVA_ARTICULO_FACTURA_LINEA`,`fza_ivas_tipos`.`NOMBRE_TIPO_IVA` AS `NOMBRE_TIPO_IVA`,`fza_facturas_lineas`.`DESCRIPCION_ARTICULO_FACTURA_LINEA` AS `DESCRIPCION_ARTICULO_FACTURA_LINEA`,`fza_facturas_lineas`.`CODIGO_TARIFA_FACTURA_LINEA` AS `CODIGO_TARIFA_FACTURA_LINEA`,`fza_facturas_lineas`.`CANTIDAD_FACTURA_LINEA` AS `CANTIDAD_FACTURA_LINEA`,`fza_facturas_lineas`.`PRECIOSALIDA_FACTURA_LINEA` AS `PRECIOSALIDA_FACTURA_LINEA`,`fza_facturas_lineas`.`PORCEN_DTO_FACTURA_LINEA` AS `PORCEN_DTO_FACTURA_LINEA`,`fza_facturas_lineas`.`PRECIO_DTO_FACTURA_LINEA` AS `PRECIO_DTO_FACTURA_LINEA`,`fza_facturas_lineas`.`PRECIOVENTA_SIVA_ARTICULO_FACTURA_LINEA` AS `PRECIOVENTA_SIVA_ARTICULO_FACTURA_LINEA`,`fza_facturas_lineas`.`PORCEN_IVA_FACTURA_LINEA` AS `PORCEN_IVA_FACTURA_LINEA`,`fza_facturas_lineas`.`PRECIOVENTA_CIVA_ARTICULO_FACTURA_LINEA` AS `PRECIOVENTA_CIVA_ARTICULO_FACTURA_LINEA`,`fza_facturas_lineas`.`TOTAL_FACTURA_LINEA` AS `TOTAL_FACTURA_LINEA`,`fza_facturas_lineas`.`TOTAL_FACTURASIVA_LINEA` AS `TOTAL_FACTURASIVA_LINEA`,`fza_facturas`.`CODIGO_CLIENTE_FACTURA` AS `CODIGO_CLIENTE_FACTURA_LINEA`,`fza_facturas`.`CODIGO_EMPRESA_FACTURA` AS `CODIGO_EMPRESA_FACTURA_LINEA` from ((`fza_facturas_lineas` left join `fza_facturas` on(`fza_facturas_lineas`.`NRO_FACTURA_LINEA` = `fza_facturas`.`NRO_FACTURA` and `fza_facturas_lineas`.`SERIE_FACTURA_LINEA` = `fza_facturas`.`SERIE_FACTURA`)) left join `fza_ivas_tipos` on(`fza_facturas_lineas`.`TIPOIVA_ARTICULO_FACTURA_LINEA` = `fza_ivas_tipos`.`CODIGO_ABREVIATURA_TIPO_IVA`));

-- Recreando vista: vi_formapago
DROP VIEW IF EXISTS `vi_formapago`;

CREATE ALGORITHM=UNDEFINED  VIEW `vi_formapago` AS select `fza_formapago`.`CODIGO_FORMAPAGO` AS `CODIGO_FORMAPAGO`,`fza_formapago`.`ACTIVO_FORMAPAGO` AS `ACTIVO_FORMAPAGO`,`fza_formapago`.`ORDEN_FORMAPAGO` AS `ORDEN_FORMAPAGO`,`fza_formapago`.`DESCRIPCION_FORMAPAGO` AS `DESCRIPCION_FORMAPAGO`,`fza_formapago`.`N_PLAZOS_FORMAPAGO` AS `N_PLAZOS_FORMAPAGO`,`fza_formapago`.`N_DIAS_ENTRE_PLAZOS_FORMAPAGO` AS `N_DIAS_ENTRE_PLAZOS_FORMAPAGO`,`fza_formapago`.`PORCEN_ANTICIPO_FORMAPAGO` AS `PORCEN_ANTICIPO_FORMAPAGO`,`fza_formapago`.`ESVERBANCOEMPRESA_FORMAPAGO` AS `ESVERBANCOEMPRESA_FORMAPAGO`,`fza_formapago`.`ESDEFAULT_FORMAPAGO` AS `ESDEFAULT_FORMAPAGO`,`fza_formapago`.`INSTANTEMODIF` AS `INSTANTEMODIF`,`fza_formapago`.`INSTANTEALTA` AS `INSTANTEALTA`,`fza_formapago`.`USUARIOALTA` AS `USUARIOALTA`,`fza_formapago`.`USUARIOMODIF` AS `USUARIOMODIF` from `fza_formapago`;

-- Recreando vista: vi_info_tpv_completa
DROP VIEW IF EXISTS `vi_info_tpv_completa`;

CREATE ALGORITHM=UNDEFINED  VIEW `vi_info_tpv_completa` AS select `a`.`CODIGO_ARTICULO` AS `CODIGO_ARTICULO`,`a`.`DESCRIPCION_ARTICULO` AS `DESCRIPCION_ARTICULO`,`a`.`TIPO_ARTICULO` AS `TIPO_ARTICULO`,`a`.`TIENE_TRAZABILIDAD` AS `TIENE_TRAZABILIDAD`,(select count(0) from `vi_atributos_nombres` `n` where `n`.`CODIGO_ARTICULO_PADRE` = `a`.`CODIGO_ARTICULO`) AS `NUM_ATRIBUTOS_REQ`,(select `n`.`NOMBRE_ATRIBUTO` from `vi_atributos_nombres` `n` where `n`.`CODIGO_ARTICULO_PADRE` = `a`.`CODIGO_ARTICULO` and `n`.`ORDEN_VISUAL_ATRIBUTO` = 1 limit 1) AS `ATTR1_NOMBRE`,(select `n`.`NOMBRE_ATRIBUTO` from `vi_atributos_nombres` `n` where `n`.`CODIGO_ARTICULO_PADRE` = `a`.`CODIGO_ARTICULO` and `n`.`ORDEN_VISUAL_ATRIBUTO` = 2 limit 1) AS `ATTR2_NOMBRE`,(select `n`.`NOMBRE_ATRIBUTO` from `vi_atributos_nombres` `n` where `n`.`CODIGO_ARTICULO_PADRE` = `a`.`CODIGO_ARTICULO` and `n`.`ORDEN_VISUAL_ATRIBUTO` = 3 limit 1) AS `ATTR3_NOMBRE`,(select `n`.`NOMBRE_ATRIBUTO` from `vi_atributos_nombres` `n` where `n`.`CODIGO_ARTICULO_PADRE` = `a`.`CODIGO_ARTICULO` and `n`.`ORDEN_VISUAL_ATRIBUTO` = 4 limit 1) AS `ATTR4_NOMBRE`,(select `n`.`NOMBRE_ATRIBUTO` from `vi_atributos_nombres` `n` where `n`.`CODIGO_ARTICULO_PADRE` = `a`.`CODIGO_ARTICULO` and `n`.`ORDEN_VISUAL_ATRIBUTO` = 5 limit 1) AS `ATTR5_NOMBRE` from `fza_articulos` `a`;

-- Recreando vista: vi_ivas
DROP VIEW IF EXISTS `vi_ivas`;

CREATE ALGORITHM=UNDEFINED  VIEW `vi_ivas` AS select `fza_ivas`.`CODIGO_IVA` AS `CODIGO_IVA`,`fza_ivas`.`GRUPO_ZONA_IVA` AS `GRUPO_ZONA_IVA`,`fza_ivas`.`DESCRIPCION_ZONA_IVA` AS `DESCRIPCION_ZONA_IVA`,`fza_ivas`.`PORCENEXENTO_IVA` AS `PORCENEXENTO_IVA`,`fza_ivas`.`PORCENEXENTO_RE_IVA` AS `PORCENEXENTO_RE_IVA`,`fza_ivas`.`PORCENNORMAL_IVA` AS `PORCENNORMAL_IVA`,`fza_ivas`.`PORCENNORMAL_RE_IVA` AS `PORCENNORMAL_RE_IVA`,`fza_ivas`.`PORCENREDUCIDO_IVA` AS `PORCENREDUCIDO_IVA`,`fza_ivas`.`PORCENREDUCIDO_RE_IVA` AS `PORCENREDUCIDO_RE_IVA`,`fza_ivas`.`PORCENSUPERREDUCIDO_IVA` AS `PORCENSUPERREDUCIDO_IVA`,`fza_ivas`.`PORCENSUPERREDUCIDO_RE_IVA` AS `PORCENSUPERREDUCIDO_RE_IVA`,`fza_ivas`.`FECHA_DESDE_IVA` AS `FECHA_DESDE_IVA`,`fza_ivas`.`FECHA_HASTA_IVA` AS `FECHA_HASTA_IVA`,`fza_ivas`.`INSTANTEMODIF` AS `INSTANTEMODIF`,`fza_ivas`.`INSTANTEALTA` AS `INSTANTEALTA`,`fza_ivas`.`USUARIOALTA` AS `USUARIOALTA`,`fza_ivas`.`USUARIOMODIF` AS `USUARIOMODIF`,`fza_ivas_grupos`.`ESAPLICA_RE_ZONA_IVA` AS `ESAPLICA_RE_ZONA_IVA`,`fza_ivas_grupos`.`ESIVAAGRICOLA_ZONA_IVA` AS `ESIVAAGRICOLA_ZONA_IVA`,`fza_ivas_grupos`.`ESDEFAULT_ZONA_IVA` AS `ESDEFAULT_ZONA_IVA`,`fza_ivas_grupos`.`ESIRPF_IMP_INCL_ZONA_IVA` AS `ESIRPF_IMP_INCL_ZONA_IVA`,`fza_ivas_grupos`.`PALABRA_REPORTS_ZONA_IVA` AS `PALABRA_REPORTS_ZONA_IVA` from (`fza_ivas` join `fza_ivas_grupos` on(`fza_ivas`.`GRUPO_ZONA_IVA` = `fza_ivas_grupos`.`GRUPO_ZONA_IVA`));

-- Recreando vista: vi_ivas_empresa
DROP VIEW IF EXISTS `vi_ivas_empresa`;

CREATE ALGORITHM=UNDEFINED  VIEW `vi_ivas_empresa` AS select `i`.`CODIGO_IVA` AS `CODIGO_IVA`,`i`.`GRUPO_ZONA_IVA` AS `GRUPO_ZONA_IVA`,`i`.`DESCRIPCION_ZONA_IVA` AS `DESCRIPCION_ZONA_IVA`,`i`.`PORCENEXENTO_IVA` AS `PORCENEXENTO_IVA`,`i`.`PORCENEXENTO_RE_IVA` AS `PORCENEXENTO_RE_IVA`,`i`.`PORCENNORMAL_IVA` AS `PORCENNORMAL_IVA`,`i`.`PORCENNORMAL_RE_IVA` AS `PORCENNORMAL_RE_IVA`,`i`.`PORCENREDUCIDO_IVA` AS `PORCENREDUCIDO_IVA`,`i`.`PORCENREDUCIDO_RE_IVA` AS `PORCENREDUCIDO_RE_IVA`,`i`.`PORCENSUPERREDUCIDO_IVA` AS `PORCENSUPERREDUCIDO_IVA`,`i`.`PORCENSUPERREDUCIDO_RE_IVA` AS `PORCENSUPERREDUCIDO_RE_IVA`,`i`.`FECHA_DESDE_IVA` AS `FECHA_DESDE_IVA`,`i`.`FECHA_HASTA_IVA` AS `FECHA_HASTA_IVA`,`ig`.`ESAPLICA_RE_ZONA_IVA` AS `ESAPLICA_RE_ZONA_IVA`,`ig`.`ESIVAAGRICOLA_ZONA_IVA` AS `ESIVAAGRICOLA_ZONA_IVA`,`ig`.`ESDEFAULT_ZONA_IVA` AS `ESDEFAULT_ZONA_IVA`,`em`.`CODIGO_EMPRESA` AS `CODIGO_EMPRESA`,`ig`.`ESIRPF_IMP_INCL_ZONA_IVA` AS `ESIRPF_IMP_INCL_ZONA_IVA`,`ig`.`PALABRA_REPORTS_ZONA_IVA` AS `PALABRA_REPORTS_ZONA_IVA` from ((`fza_ivas` `i` join `fza_ivas_grupos` `ig` on(`i`.`GRUPO_ZONA_IVA` = `ig`.`GRUPO_ZONA_IVA`)) join `fza_empresas` `em` on(`em`.`GRUPO_ZONA_IVA_EMPRESA` = `ig`.`GRUPO_ZONA_IVA`));

-- Recreando vista: vi_ivas_grupos
DROP VIEW IF EXISTS `vi_ivas_grupos`;

CREATE ALGORITHM=UNDEFINED  VIEW `vi_ivas_grupos` AS select `fza_ivas_grupos`.`GRUPO_ZONA_IVA` AS `GRUPO_ZONA_IVA`,`fza_ivas_grupos`.`DESCRIPCION_ZONA_IVA` AS `DESCRIPCION_ZONA_IVA`,`fza_ivas_grupos`.`ESIRPF_IMP_INCL_ZONA_IVA` AS `ESIRPF_IMP_INCL_ZONA_IVA`,`fza_ivas_grupos`.`ESIVAAGRICOLA_ZONA_IVA` AS `ESIVAAGRICOLA_ZONA_IVA`,`fza_ivas_grupos`.`ESAPLICA_RE_ZONA_IVA` AS `ESAPLICA_RE_ZONA_IVA`,`fza_ivas_grupos`.`ESDEFAULT_ZONA_IVA` AS `ESDEFAULT_ZONA_IVA`,`fza_ivas_grupos`.`PALABRA_REPORTS_ZONA_IVA` AS `PALABRA_REPORTS_ZONA_IVA`,`fza_ivas_grupos`.`INSTANTEMODIF` AS `INSTANTEMODIF`,`fza_ivas_grupos`.`INSTANTEALTA` AS `INSTANTEALTA`,`fza_ivas_grupos`.`USUARIOALTA` AS `USUARIOALTA`,`fza_ivas_grupos`.`USUARIOMODIF` AS `USUARIOMODIF` from `fza_ivas_grupos`;

-- Recreando vista: vi_ivas_zonas
DROP VIEW IF EXISTS `vi_ivas_zonas`;

CREATE ALGORITHM=UNDEFINED  VIEW `vi_ivas_zonas` AS select `fza_ivas_zonas`.`CODIGO_ZONA_IVA` AS `CODIGO_ZONA_IVA`,`fza_ivas_zonas`.`DESCRIPCION_ZONA_IVA` AS `DESCRIPCION_ZONA_IVA`,`fza_ivas_zonas`.`ESDEFAULT_ZONA_IVA` AS `ESDEFAULT_ZONA_IVA` from `fza_ivas_zonas`;

-- Recreando vista: vi_paises
DROP VIEW IF EXISTS `vi_paises`;

CREATE ALGORITHM=UNDEFINED  VIEW `vi_paises` AS select `fza_paises`.`COD_PAIS_ALPHA2` AS `CODIGO`,`fza_paises`.`NOMBRE_SPA_PAIS` AS `NOMBRE` from `fza_paises` order by `fza_paises`.`ORDEN_PAIS`,`fza_paises`.`NOMBRE_SPA_PAIS`;

-- Recreando vista: vi_proveedores
DROP VIEW IF EXISTS `vi_proveedores`;

CREATE ALGORITHM=UNDEFINED  VIEW `vi_proveedores` AS select `fza_proveedores`.`CODIGO_PROVEEDOR` AS `CODIGO_PROVEEDOR`,`fza_proveedores`.`ACTIVO_PROVEEDOR` AS `ACTIVO_PROVEEDOR`,`fza_proveedores`.`RAZONSOCIAL_PROVEEDOR` AS `RAZONSOCIAL_PROVEEDOR`,`fza_proveedores`.`NIF_PROVEEDOR` AS `NIF_PROVEEDOR`,`fza_proveedores`.`MOVIL_PROVEEDOR` AS `MOVIL_PROVEEDOR`,`fza_proveedores`.`EMAIL_PROVEEDOR` AS `EMAIL_PROVEEDOR`,`fza_proveedores`.`DIRECCION1_PROVEEDOR` AS `DIRECCION1_PROVEEDOR`,`fza_proveedores`.`DIRECCION2_PROVEEDOR` AS `DIRECCION2_PROVEEDOR`,`fza_proveedores`.`POBLACION_PROVEEDOR` AS `POBLACION_PROVEEDOR`,`fza_proveedores`.`PROVINCIA_PROVEEDOR` AS `PROVINCIA_PROVEEDOR`,`fza_proveedores`.`CPOSTAL_PROVEEDOR` AS `CPOSTAL_PROVEEDOR`,`fza_proveedores`.`PAIS_PROVEEDOR` AS `PAIS_PROVEEDOR`,`fza_proveedores`.`OBSERVACIONES_PROVEEDOR` AS `OBSERVACIONES_PROVEEDOR`,`fza_proveedores`.`REFERENCIA_PROVEEDOR` AS `REFERENCIA_PROVEEDOR`,`fza_proveedores`.`CONTACTO_PROVEEDOR` AS `CONTACTO_PROVEEDOR`,`fza_proveedores`.`TELEFONO_CONTACTO_PROVEEDOR` AS `TELEFONO_CONTACTO_PROVEEDOR`,`fza_proveedores`.`TELEFONO_PROVEEDOR` AS `TELEFONO_PROVEEDOR`,`fza_proveedores`.`IBAN_PROVEEDOR` AS `IBAN_PROVEEDOR`,`fza_proveedores`.`ORDEN_PROVEEDOR` AS `ORDEN_PROVEEDOR`,`fza_proveedores`.`INSTANTEMODIF` AS `INSTANTEMODIF`,`fza_proveedores`.`INSTANTEALTA` AS `INSTANTEALTA`,`fza_proveedores`.`USUARIOALTA` AS `USUARIOALTA`,`fza_proveedores`.`USUARIOMODIF` AS `USUARIOMODIF` from `fza_proveedores`;

-- Recreando vista: vi_proveedores_articulos
DROP VIEW IF EXISTS `vi_proveedores_articulos`;

CREATE ALGORITHM=UNDEFINED  VIEW `vi_proveedores_articulos` AS select `fza_articulos_proveedores`.`CODIGO_PROVEEDOR_ARTICULO_PROVEEDOR` AS `CODIGO_PROVEEDOR`,`fza_articulos_proveedores`.`CODIGO_ARTICULO_ARTICULO_PROVEEDOR` AS `CODIGO_ARTICULO`,`vi_articulos`.`DESCRIPCION_ARTICULO` AS `DESCRIPCION_ARTICULO`,`vi_articulos`.`CODIGO_FAMILIA_ARTICULO` AS `CODIGO_FAMILIA`,`vi_articulos`.`DESCRIPCION_FAMILIA` AS `DESCRIPCION_FAMILIA`,`vi_articulos`.`TIPO_CANTIDAD_ARTICULO` AS `TIPO_CATNTIDAD_ARTICULO`,`vi_articulos`.`ESACTIVO_FIJO_ARTICULO` AS `ESACTIVO_FIJO_ARTICULO`,`fza_articulos_proveedores`.`PRECIO_ULT_COMPRA_ARTICULO_PROVEEDOR` AS `PRECIO_ULT_COMPRA`,`fza_articulos_proveedores`.`FECHA_VALIDEZ_ARTICULO_PROVEEDOR` AS `FECHA_VALIDEZ`,`fza_articulos_proveedores`.`ESPROVEEDORPRINCIPAL_ARTICULO_PROVEEDOR` AS `ESPROVEEDORPRINCIPAL`,`fza_articulos_proveedores`.`INSTANTEMODIF` AS `INSTANTEMODIF`,`fza_articulos_proveedores`.`INSTANTEALTA` AS `INSTANTEALTA`,`fza_articulos_proveedores`.`USUARIOALTA` AS `USUARIOALTA`,`fza_articulos_proveedores`.`USUARIOMODIF` AS `USUARIOMODIF` from (`fza_articulos_proveedores` left join `vi_articulos` on(`fza_articulos_proveedores`.`CODIGO_ARTICULO_ARTICULO_PROVEEDOR` = `vi_articulos`.`CODIGO_ARTICULO`));

-- Recreando vista: vi_proveedores_busquedas
DROP VIEW IF EXISTS `vi_proveedores_busquedas`;

CREATE ALGORITHM=UNDEFINED  VIEW `vi_proveedores_busquedas` AS select `fza_proveedores`.`CODIGO_PROVEEDOR` AS `CODIGO_PROVEEDOR`,`fza_proveedores`.`ACTIVO_PROVEEDOR` AS `ACTIVO_PROVEEDOR`,`fza_proveedores`.`RAZONSOCIAL_PROVEEDOR` AS `RAZONSOCIAL_PROVEEDOR`,`fza_proveedores`.`NIF_PROVEEDOR` AS `NIF_PROVEEDOR`,`fza_proveedores`.`MOVIL_PROVEEDOR` AS `MOVIL_PROVEEDOR`,`fza_proveedores`.`EMAIL_PROVEEDOR` AS `EMAIL_PROVEEDOR`,`fza_proveedores`.`DIRECCION1_PROVEEDOR` AS `DIRECCION1_PROVEEDOR`,`fza_proveedores`.`DIRECCION2_PROVEEDOR` AS `DIRECCION2_PROVEEDOR`,`fza_proveedores`.`POBLACION_PROVEEDOR` AS `POBLACION_PROVEEDOR`,`fza_proveedores`.`PROVINCIA_PROVEEDOR` AS `PROVINCIA_PROVEEDOR`,`fza_proveedores`.`CPOSTAL_PROVEEDOR` AS `CPOSTAL_PROVEEDOR`,`fza_proveedores`.`PAIS_PROVEEDOR` AS `PAIS_PROVEEDOR`,`fza_proveedores`.`OBSERVACIONES_PROVEEDOR` AS `OBSERVACIONES_PROVEEDOR`,`fza_proveedores`.`REFERENCIA_PROVEEDOR` AS `REFERENCIA_PROVEEDOR`,`fza_proveedores`.`CONTACTO_PROVEEDOR` AS `CONTACTO_PROVEEDOR`,`fza_proveedores`.`TELEFONO_CONTACTO_PROVEEDOR` AS `TELEFONO_CONTACTO_PROVEEDOR`,`fza_proveedores`.`TELEFONO_PROVEEDOR` AS `TELEFONO_PROVEEDOR`,`fza_proveedores`.`IBAN_PROVEEDOR` AS `IBAN_PROVEEDOR`,`fza_proveedores`.`ORDEN_PROVEEDOR` AS `ORDEN_PROVEEDOR`,`fza_proveedores`.`INSTANTEMODIF` AS `INSTANTEMODIF`,`fza_proveedores`.`INSTANTEALTA` AS `INSTANTEALTA`,`fza_proveedores`.`USUARIOALTA` AS `USUARIOALTA`,`fza_proveedores`.`USUARIOMODIF` AS `USUARIOMODIF` from `fza_proveedores` where `fza_proveedores`.`ACTIVO_PROVEEDOR` = 'S' order by `fza_proveedores`.`ORDEN_PROVEEDOR`;

-- Recreando vista: vi_recibos
DROP VIEW IF EXISTS `vi_recibos`;

CREATE ALGORITHM=UNDEFINED  VIEW `vi_recibos` AS select `fza_recibos`.`NRO_FACTURA_RECIBO` AS `NRO_FACTURA_RECIBO`,`fza_recibos`.`SERIE_FACTURA_RECIBO` AS `SERIE_FACTURA_RECIBO`,`fza_recibos`.`NRO_PLAZO_RECIBO` AS `NRO_PLAZO_RECIBO`,`fza_recibos`.`FORMA_PAGO_ORIGEN_RECIBO` AS `FORMA_PAGO_ORIGEN_RECIBO`,`fza_recibos`.`FORMA_PAGO_DESCRIPCION_ORIGEN_RECIBO` AS `FORMA_PAGO_DESCRIPCION_ORIGEN_RECIBO`,`fza_recibos`.`EUROS_RECIBO` AS `EUROS_RECIBO`,`fza_recibos`.`STADO_RECIBO` AS `STADO_RECIBO`,`fza_recibos`.`FECHA_EXPEDICION_RECIBO` AS `FECHA_EXPEDICION_RECIBO`,`fza_recibos`.`FECHA_VENCIMIENTO_RECIBO` AS `FECHA_VENCIMIENTO_RECIBO`,`fza_recibos`.`IBAN_CLIENTE_RECIBO` AS `IBAN_CLIENTE_RECIBO`,`fza_recibos`.`FECHA_PAGO_RECIBO` AS `FECHA_PAGO_RECIBO`,`fza_recibos`.`LOCALIDAD_EXPEDICION_RECIBO` AS `LOCALIDAD_EXPEDICION_RECIBO`,`fza_recibos`.`CODIGO_CLIENTE_RECIBO` AS `CODIGO_CLIENTE_RECIBO`,`fza_recibos`.`RAZONSOCIAL_CLIENTE_RECIBO` AS `RAZONSOCIAL_CLIENTE_RECIBO`,`fza_recibos`.`DIRECCION1_CLIENTE_RECIBO` AS `DIRECCION1_CLIENTE_RECIBO`,`fza_recibos`.`POBLACION_CLIENTE_RECIBO` AS `POBLACION_CLIENTE_RECIBO`,`fza_recibos`.`PROVINCIA_CLIENTE_RECIBO` AS `PROVINCIA_CLIENTE_RECIBO`,`fza_recibos`.`CPOSTAL_CLIENTE_RECIBO` AS `CPOSTAL_CLIENTE_RECIBO`,`fza_recibos`.`IMPORTE_LETRA_RECIBO` AS `IMPORTE_LETRA_RECIBO`,`fza_recibos`.`INSTANTEMODIF` AS `INSTANTEMODIF`,`fza_recibos`.`INSTANTEALTA` AS `INSTANTEALTA`,`fza_recibos`.`USUARIOALTA` AS `USUARIOALTA`,`fza_recibos`.`USUARIOMODIF` AS `USUARIOMODIF` from `fza_recibos` order by `fza_recibos`.`SERIE_FACTURA_RECIBO`,`fza_recibos`.`NRO_FACTURA_RECIBO`,`fza_recibos`.`NRO_PLAZO_RECIBO`;

-- Recreando vista: vi_tarifas
DROP VIEW IF EXISTS `vi_tarifas`;

CREATE ALGORITHM=UNDEFINED  VIEW `vi_tarifas` AS select `fza_tarifas`.`CODIGO_TARIFA` AS `CODIGO_TARIFA`,`fza_tarifas`.`NOMBRE_TARIFA` AS `NOMBRE_TARIFA`,`fza_tarifas`.`ACTIVO_TARIFA` AS `ACTIVO_TARIFA`,`fza_tarifas`.`ORDEN_TARIFA` AS `ORDEN_TARIFA`,`fza_tarifas`.`ESIMP_INCL_TARIFA` AS `ESIMP_INCL_TARIFA`,`fza_tarifas`.`ESDEFAULT_TARIFA` AS `ESDEFAULT_TARIFA`,`fza_tarifas`.`INSTANTEMODIF` AS `INSTANTEMODIF`,`fza_tarifas`.`INSTANTEALTA` AS `INSTANTEALTA`,`fza_tarifas`.`USUARIOALTA` AS `USUARIOALTA`,`fza_tarifas`.`USUARIOMODIF` AS `USUARIOMODIF` from `fza_tarifas` where `fza_tarifas`.`ACTIVO_TARIFA` = 'S' order by `fza_tarifas`.`ORDEN_TARIFA`;

-- Recreando vista: vi_usuarios
DROP VIEW IF EXISTS `vi_usuarios`;

CREATE ALGORITHM=UNDEFINED  VIEW `vi_usuarios` AS select `fza_usuarios`.`USUARIO_USUARIO` AS `USUARIO_USUARIO`,`fza_usuarios`.`PASSWORD_USUARIO` AS `PASSWORD_USUARIO`,`fza_usuarios`.`GRUPO_USUARIO` AS `GRUPO_USUARIO`,`fza_usuarios`.`EMPRESADEF_USUARIO` AS `EMPRESADEF_USUARIO`,`fza_usuarios`.`DIMINUTIVO_TICKET_USUARIO` AS `DIMINUTIVO_TICKET_USUARIO`,`fza_usuarios`.`CODIGO_EMPLEADO_USUARIO` AS `CODIGO_EMPLEADO_USUARIO`,`fza_usuarios`.`ULTIMOLOGIN_USUARIO` AS `ULTIMOLOGIN_USUARIO`,`fza_usuarios`.`INSTANTEMODIF` AS `INSTANTEMODIF`,`fza_usuarios`.`INSTANTEALTA` AS `INSTANTEALTA`,`fza_usuarios`.`USUARIOALTA` AS `USUARIOALTA`,`fza_usuarios`.`USUARIOMODIF` AS `USUARIOMODIF`,`vi_empresas`.`RAZONSOCIAL_EMPRESA` AS `RAZONSOCIAL_EMPRESA`,`fza_usuarios_grupos`.`GRUPO_GRUPO` AS `GRUPO_GRUPO`,`fza_usuarios_grupos`.`ESGRUPOADMINISTRADOR_GRUPO` AS `ESGRUPOADMINISTRADOR_GRUPO` from ((`fza_usuarios` join `fza_usuarios_grupos` on(`fza_usuarios`.`GRUPO_USUARIO` = `fza_usuarios_grupos`.`GRUPO_GRUPO`)) left join `vi_empresas` on(`fza_usuarios`.`EMPRESADEF_USUARIO` = `vi_empresas`.`CODIGO_EMPRESA`));

-- Recreando vista: vi_usuarios_grupos
DROP VIEW IF EXISTS `vi_usuarios_grupos`;

CREATE ALGORITHM=UNDEFINED  VIEW `vi_usuarios_grupos` AS select `fza_usuarios_grupos`.`GRUPO_GRUPO` AS `GRUPO_GRUPO`,`fza_usuarios_grupos`.`ESGRUPOADMINISTRADOR_GRUPO` AS `ESGRUPOADMINISTRADOR_GRUPO`,`fza_usuarios_grupos`.`INSTANTEMODIF` AS `INSTANTEMODIF`,`fza_usuarios_grupos`.`INSTANTEALTA` AS `INSTANTEALTA`,`fza_usuarios_grupos`.`USUARIOALTA` AS `USUARIOALTA`,`fza_usuarios_grupos`.`USUARIOMODIF` AS `USUARIOMODIF` from `fza_usuarios_grupos`;

-- Recreando vista: vi_usuarios_perfiles
DROP VIEW IF EXISTS `vi_usuarios_perfiles`;

CREATE ALGORITHM=UNDEFINED  VIEW `vi_usuarios_perfiles` AS select `fza_usuarios_perfiles`.`USUARIO_GRUPO_PERFILES` AS `USUARIO_GRUPO_PERFILES`,`fza_usuarios_perfiles`.`KEY_PERFILES` AS `KEY_PERFILES`,`fza_usuarios_perfiles`.`SUBKEY_PERFILES` AS `SUBKEY_PERFILES`,`fza_usuarios_perfiles`.`VALUE_PERFILES` AS `VALUE_PERFILES`,`fza_usuarios_perfiles`.`VALUE_TEXT_PERFILES` AS `VALUE_TEXT_PERFILES`,`fza_usuarios_perfiles`.`TYPE_BLOB_PERFILES` AS `TYPE_BLOB_PERFILES`,`fza_usuarios_perfiles`.`VALUE_BLOB_PERFILES` AS `VALUE_BLOB_PERFILES`,`fza_usuarios_perfiles`.`INSTANTEMODIF` AS `INSTANTEMODIF`,`fza_usuarios_perfiles`.`INSTANTEALTA` AS `INSTANTEALTA`,`fza_usuarios_perfiles`.`USUARIOALTA` AS `USUARIOALTA`,`fza_usuarios_perfiles`.`USUARIOMODIF` AS `USUARIOMODIF` from `fza_usuarios_perfiles`;

-- === PROCEDIMIENTOS ===
-- Recreando procedimiento: PRC_AGREGAR_VALOR_CONJUNTO
DROP PROCEDURE IF EXISTS `PRC_AGREGAR_VALOR_CONJUNTO`;

DELIMITER $$
CREATE  PROCEDURE `PRC_AGREGAR_VALOR_CONJUNTO`(IN `p_id_conjunto` INT,         -- ID de la Paleta (ej: 5 para 'Verano 2026')
    IN `p_valor_texto` VARCHAR(100), -- Lo que escribió el usuario (ej: 'VERDE RADIOACTIVO')
    IN `p_usuario` VARCHAR(100))
BEGIN
    DECLARE v_id_valor INT;
    DECLARE v_tipo_variacion VARCHAR(20);
    
    -- 1. Averiguamos de qué tipo es esta paleta (¿Es de Colores CO o Tallas TC?)
    SELECT ID_VA_AC INTO v_tipo_variacion
    FROM fza_atributos_conjuntos
    WHERE ID_CONJUNTO_AC = p_id_conjunto;
    
    -- 2. Usamos el truco del "Find or Create" que vimos antes
    -- Esto busca el ID de 'VERDE RADIOACTIVO'. Si no existe, lo crea en fza_atributos_valores
    CALL PRC_GET_CREAR_VALOR(v_tipo_variacion, p_valor_texto, p_usuario, v_id_valor);
    
    -- 3. Ahora que SEGURO tenemos un ID (v_id_valor), lo vinculamos a la paleta
    -- Usamos INSERT IGNORE para que si ya estaba en la paleta, no de error
    INSERT IGNORE INTO fza_atributos_conjuntos_det (
        ID_CONJUNTO_ACD, 
        ID_VALOR_ACD, 
        USUARIOALTA, 
        USUARIOMODIF, 
        INSTANTEALTA
    ) VALUES (
        p_id_conjunto, 
        v_id_valor, 
        p_usuario, 
        p_usuario, 
        NOW()
    );
    
END $$
DELIMITER ;

-- Recreando procedimiento: PRC_CALCULAR_FACTURA_NETOS
DROP PROCEDURE IF EXISTS `PRC_CALCULAR_FACTURA_NETOS`;

DELIMITER $$
CREATE  PROCEDURE `PRC_CALCULAR_FACTURA_NETOS`(IN `pSERIE_FACTURA` VARCHAR(12), 
                                              IN `pNRO_FACTURA` VARCHAR(12))
BEGIN
  DECLARE pPRECIOSIVA decimal(19,6);
  DECLARE pPRECIOCIVA decimal(19,6);
  DECLARE pPORCEN decimal(19,6);
  DECLARE pTIPO VARCHAR(2);
  DECLARE pIVA_RECARGO varchar(1) DEFAULT '';
  DECLARE pAPLICA_RECARGO varchar(1) DEFAULT '';
  DECLARE pIVA_EXENTO varchar(1) DEFAULT '';
  DECLARE pREG_AG_EMP varchar(1) DEFAULT '';
  DECLARE pREG_AG_CLI varchar(1) DEFAULT '';
  DECLARE pINTRACOMUNITARIO varchar(1) DEFAULT '';
  DECLARE pAPLICA_RETENCIONES_CLI varchar(1) DEFAULT '';
  DECLARE pAPLICA_RETENCIONES_EMP varchar(1) DEFAULT '';
  DECLARE pPORCENREN decimal(19,6) DEFAULT 0;
  DECLARE pPORCENRER decimal(19,6) DEFAULT 0;
  DECLARE pPORCENRES decimal(19,6) DEFAULT 0;
  DECLARE pPORCENREE decimal(19,6) DEFAULT 0;
  DECLARE pSUMBASEN decimal(19,6) DEFAULT 0;
  DECLARE pSUMBASER decimal(19,6) DEFAULT 0;
  DECLARE pSUMBASES decimal(19,6) DEFAULT 0;
  DECLARE pSUMBASEE decimal(19,6) DEFAULT 0;
  DECLARE pTOTN decimal(19,6) DEFAULT 0;
  DECLARE pTOTR decimal(19,6) DEFAULT 0;
  DECLARE pTOTS decimal(19,6) DEFAULT 0;
  DECLARE pTOTE decimal(19,6) DEFAULT 0;
  DECLARE pTOTRECN decimal(19,6) DEFAULT 0;
  DECLARE pTOTRECR decimal(19,6) DEFAULT 0;
  DECLARE pTOTRECS decimal(19,6) DEFAULT 0;
  DECLARE pTOTRECE decimal(19,6) DEFAULT 0;
  DECLARE pSUMTOTREC decimal(19,6) DEFAULT 0;
  DECLARE pSUMTOT decimal(19,6) DEFAULT 0;
  DECLARE pPORCENN decimal(19,6) DEFAULT 0;
  DECLARE pTOTBASES decimal(19,6) DEFAULT 0;
  DECLARE pPORCENR decimal(19,6) DEFAULT 0;
  DECLARE pPORCENS decimal(19,6) DEFAULT 0;
  DECLARE pPORCENE decimal(19,6) DEFAULT 0;
  DECLARE pPORCENRET decimal(19,6) DEFAULT 0;
  DECLARE pGRUPO_ZONA_IVA varchar(12);
  DECLARE pCODIGO_IVA varchar(12);
  DECLARE pTOTALRET decimal(19,6) DEFAULT 0;
  DECLARE pFECHA datetime;
  DECLARE pLINEA varchar(3);
  DECLARE pIMP_INCL varchar(1);
  DECLARE pCANTIDAD decimal(19,6) DEFAULT 0;
  DECLARE pCODART varchar(20);
  DECLARE pTIPOIVAF varchar(1) DEFAULT 'X';
  DECLARE pIRPF_IMP_INCL VARCHAR(1);
  DECLARE pVENTA_ACT_FIJ VARCHAR(1);
  DECLARE finished INTEGER DEFAULT 0;
  DECLARE pCODEMPRESA varchar(8);
  DECLARE CUR_LINEAS 
          CURSOR FOR 
              SELECT LINEA_FACTURA_LINEA,
                     CODIGO_ARTICULO_FACTURA_LINEA,
                     PRECIOVENTA_SIVA_ARTICULO_FACTURA_LINEA AS PRECIOSIVA,
                     PRECIOVENTA_CIVA_ARTICULO_FACTURA_LINEA AS PRECIOCIVA,
                     PORCEN_IVA_FACTURA_LINEA AS PORCEN,
                     TIPOIVA_ARTICULO_FACTURA_LINEA AS TIPO,
                     ESIMP_INCL_TARIFA_FACTURA_LINEA AS IMP_INCL,
                     CANTIDAD_FACTURA_LINEA as CANTIDAD
                FROM FZA_FACTURAS_LINEAS 
               WHERE SERIE_FACTURA_LINEA = pSERIE_FACTURA 
                 AND NRO_FACTURA_LINEA = pNRO_FACTURA;
  DECLARE CONTINUE HANDLER 
          FOR NOT FOUND SET finished = 1;
  START TRANSACTION;
  SELECT PORCEN_IVAN_FACTURA,
         PORCEN_IVAR_FACTURA,
         PORCEN_IVAS_FACTURA,
         PORCEN_IVAE_FACTURA,
         PORCEN_RETENCION_FACTURA,
         ESAPLICA_RE_ZONA_IVA_FACTURA,
         ESIVA_RECARGO_CLIENTE_FACTURA,
         ESIVA_EXENTO_CLIENTE_FACTURA,
         ESRETENCIONES_CLIENTE_FACTURA,
         ESRETENCIONES_EMPRESA_FACTURA,
         ESIRPF_IMP_INCL_ZONA_IVA_FACTURA,
         PORCEN_REN_FACTURA,
         PORCEN_RER_FACTURA,
         PORCEN_RES_FACTURA,
         PORCEN_REE_FACTURA,
         ESREGIMENESPECIALAGRICOLA_EMPRESA_FACTURA,
         ESREGIMENESPECIALAGRICOLA_CLIENTE_FACTURA,
         GRUPO_ZONA_IVA_EMPRESA_FACTURA,
         CODIGO_IVA_FACTURA,
         ESINTRACOMUNITARIO_CLIENTE_FACTURA,
         FECHA_FACTURA,
         CODIGO_EMPRESA_FACTURA,
         ESVENTA_ACTIVO_FIJO_FACTURA
    INTO pPORCENN,
         pPORCENR,
         pPORCENS,
         pPORCENE,
         pPORCENRET,
         pIVA_RECARGO,
         pAPLICA_RECARGO,
         pIVA_EXENTO,
         pAPLICA_RETENCIONES_CLI,
         pAPLICA_RETENCIONES_EMP,
         pIRPF_IMP_INCL,
         pPORCENREN,
         pPORCENRER,
         pPORCENRES,
         pPORCENREE,
         pREG_AG_EMP,
         pREG_AG_CLI,
         pGRUPO_ZONA_IVA,
         pCODIGO_IVA,
         pINTRACOMUNITARIO,
         pFECHA,
         pCODEMPRESA,
         pVENTA_ACT_FIJ
    FROM fza_facturas
   WHERE SERIE_FACTURA = pSERIE_FACTURA
     AND NRO_FACTURA = pNRO_FACTURA;
  IF (pREG_AG_EMP = 'S') THEN
    SET pAPLICA_RETENCIONES_EMP = 'S';
    SET pAPLICA_RECARGO = 'N';
    IF ( EXISTS(SELECT CODIGO_EMPRESA 
                  FROM vi_ivas_empresa 
                 WHERE CODIGO_EMPRESA = pcodempresa 
                   AND ESIVAAGRICOLA_ZONA_IVA = 'S') ) THEN
      SELECT GRUPO_ZONA_IVA,
             CODIGO_IVA, 
             PORCENNORMAL_IVA,
             PORCENEXENTO_IVA,
             PORCENREDUCIDO_IVA,
             PORCENSUPERREDUCIDO_IVA
        INTO pGRUPO_ZONA_IVA,
             pCODIGO_IVA,
             pPORCENN,
             pPORCENE,
             pPORCENR,
             pPORCENS
        FROM vi_ivas_empresa 
       WHERE ESIVAAGRICOLA_ZONA_IVA ='S'
         AND CODIGO_EMPRESA = pCODEMPRESA
         AND FECHA_DESDE_IVA <= pFECHA
         AND (FECHA_HASTA_IVA IS NULL 
              OR FECHA_HASTA_IVA >= pFECHA);
	  END IF;
  END IF;
  IF (pINTRACOMUNITARIO = 'S') THEN
    SET pIVA_EXENTO = 'S';
    SET pAPLICA_RETENCIONES_CLI = 'N';
    SET pREG_AG_CLI = 'N';
  END IF;
  IF ((pVENTA_ACT_FIJ = 'S') AND (pREG_AG_EMP = 'S')) THEN
    SET pIVA_EXENTO = 'S';   
  END IF;    
	/* SELECT pREG_AG_EMP, pREG_AG_CLI; */
  IF ((pREG_AG_EMP = 'S') AND (pREG_AG_CLI = 'S')) THEN
    SET pAPLICA_RETENCIONES_CLI = 'S';
    SET pIVA_EXENTO = 'S';
  END IF;
  IF ((pREG_AG_EMP = 'S') AND (pREG_AG_CLI = 'N') AND 
      (pAPLICA_RETENCIONES_CLI='N' )) THEN
    SET pIVA_EXENTO = 'S';
  END IF;    
  IF ((pREG_AG_EMP = 'S') AND (pREG_AG_CLI = 'N') AND 
      (pAPLICA_RETENCIONES_CLI='S' )) THEN
    SET pTIPOIVAF = 'N';
  END IF;
	/* SELECT pIVA_EXENTO, pSUMBASEE; */
  IF (pIVA_EXENTO = 'S') THEN
    SET pPORCENN = pPORCENE;
    SET pPORCENR = pPORCENE;
    SET pPORCENS = pPORCENE;
    SET pPORCENE = pPORCENE;
    SET pPORCENREN = 0;
    SET pPORCENRER = 0;
    SET pPORCENRES = 0;
    SET pPORCENREE = 0;
    SET pTIPOIVAF = 'E';
    SET pSUMBASEN = 0;
    SET pSUMBASER = 0;
    SET pSUMBASES = 0;
    SET pSUMBASEE = pSUMBASEE +
                    pSUMBASEN +
                    pSUMBASER +
                    pSUMBASES;
	  /* select pSUMBASEE, pSUMBASEN, pSUMBASER, pSUMBASES, 'IVA EXENTO obl' as comment; */
  END IF;
  OPEN CUR_LINEAS;
  GETLINEAS: LOOP
    FETCH CUR_LINEAS INTO pLINEA, 
                          pCODART, 
                          pPRECIOSIVA, 
                          pPRECIOCIVA, 
                          pPORCEN, 
                          pTIPO, 
                          pIMP_INCL, 
                          pCANTIDAD ;
    IF finished = 1 THEN 
      LEAVE GETLINEAS;
    END IF;
		/* select pLINEA,pTIPO, pCODART, pPRECIOSIVA, pPRECIOCIVA, pPORCEN, pIMP_INCL, pCANTIDAD, pSERIE_FACTURA, pNRO_FACTURA; */
    IF pIVA_EXENTO = 'S' THEN
		  SET pTIPO = 'E';			
		END IF;
		CASE pTIPO
    WHEN  'N' THEN
      SET pPORCEN = pPORCENN;
      IF (pIMP_INCL = 'S') THEN
        SET pPRECIOSIVA = pPRECIOCIVA/(1+pPORCEN/100);
				/* SELECT pPRECIOSIVA, pPRECIOCIVA; */
			END IF;
      SET pSUMBASEN = PSUMBASEN + pPRECIOSIVA*pCANTIDAD;
    WHEN 'R' THEN
      SET pPORCEN = pPORCENR;
      IF (pIMP_INCL = 'S') THEN
        SET pPRECIOSIVA = pPRECIOCIVA/(1+pPORCEN/100);			  
      END IF;
      SET pSUMBASER = PSUMBASER + pPRECIOSIVA*pCANTIDAD;
    WHEN 'S' THEN
      SET pPORCEN = pPORCENS;
      IF (pIMP_INCL = 'S') THEN
        SET pPRECIOSIVA = pPRECIOCIVA/(1+pPORCEN/100);
      END IF;
      SET pSUMBASES = PSUMBASES + pPRECIOSIVA*pCANTIDAD;
    WHEN 'E' THEN
       SET pPORCEN = pPORCENE;
        IF (pIMP_INCL = 'S') THEN
          SET pPRECIOSIVA = pPRECIOCIVA/(1+pPORCEN/100);
        END IF;
        SET pSUMBASEE = PSUMBASEE + pPRECIOSIVA*pCANTIDAD;
    END CASE;
	  /* SELECT pSUMBASEN, pSUMBASER, pSUMBASES, pSUMBASEE; */
    IF (pIMP_INCL = 'S') THEN
      UPDATE FZA_FACTURAS_LINEAS 
         SET PORCEN_IVA_FACTURA_LINEA = pPORCEN,
             TIPOIVA_ARTICULO_FACTURA_LINEA = pTIPO,
             PRECIOVENTA_SIVA_ARTICULO_FACTURA_LINEA = 
                       PRECIOVENTA_CIVA_ARTICULO_FACTURA_LINEA/(1+pPORCEN/100),
             TOTAL_FACTURA_LINEA = 
               CANTIDAD_FACTURA_LINEA * PRECIOVENTA_CIVA_ARTICULO_FACTURA_LINEA,
					   TOTAL_FACTURASIVA_LINEA = 
						   CANTIDAD_FACTURA_LINEA * PRECIOVENTA_SIVA_ARTICULO_FACTURA_LINEA
       WHERE SERIE_FACTURA_LINEA = pSERIE_FACTURA 
         AND NRO_FACTURA_LINEA = pNRO_FACTURA
             AND LINEA_FACTURA_LINEA = pLINEA; 
    ELSE
      UPDATE FZA_FACTURAS_LINEAS 
         SET PORCEN_IVA_FACTURA_LINEA = pPORCEN,
             TIPOIVA_ARTICULO_FACTURA_LINEA = pTIPO,
             PRECIOVENTA_CIVA_ARTICULO_FACTURA_LINEA = 
               PRECIOVENTA_SIVA_ARTICULO_FACTURA_LINEA*(1+pPORCEN/100),
						 TOTAL_FACTURASIVA_LINEA = 
						   CANTIDAD_FACTURA_LINEA * PRECIOVENTA_SIVA_ARTICULO_FACTURA_LINEA,
             TOTAL_FACTURA_LINEA = 
               CANTIDAD_FACTURA_LINEA * PRECIOVENTA_CIVA_ARTICULO_FACTURA_LINEA
        WHERE SERIE_FACTURA_LINEA = pSERIE_FACTURA 
          AND NRO_FACTURA_LINEA = pNRO_FACTURA
          AND LINEA_FACTURA_LINEA = pLINEA; 
    END IF;
  END LOOP GETLINEAS;
  SET PTOTBASES = pSUMBASEN + pSUMBASER + pSUMBASES + pSUMBASEE;
  SET pTOTN = pSUMBASEN * (1 + pPORCENN/100) - pSUMBASEN;
  SET pTOTR = pSUMBASER * (1 + pPORCENR/100) - pSUMBASER;
  SET pTOTS = pSUMBASES * (1 + pPORCENS/100) - pSUMBASES;
  SET pTOTE = pSUMBASEE * (1 + pPORCENE/100) - pSUMBASEE;
  SET pSUMTOT = pTOTN + pTOTR + pTOTS + pTOTE;
	/* SELECT PTOTBASES,pSUMBASEN, pSUMBASER, pSUMBASES, pSUMBASEE, pTOTN, pTOTR, pTOTS, pTOTE, pPORCENN, pPORCENR, pPORCENS, pPORCENE; */
  IF ( (pIVA_RECARGO ='S') AND (pAPLICA_RECARGO = 'S') ) THEN
    SET pTOTRECN = pSUMBASEN * (1 + pPORCENREN/100) - pSUMBASEN;
		SET pTOTRECR = pSUMBASER * (1 + pPORCENRER/100) - pSUMBASER;
    SET pTOTRECS = pSUMBASES * (1 + pPORCENRES/100) - pSUMBASES;
    SET pTOTRECE = pSUMBASEE * (1 + pPORCENREE/100) - pSUMBASEE;
    SET pSUMTOTREC = pTOTRECN + pTOTRECR + pTOTRECS + pTOTRECE;
		/* SELECT pTOTRECN, pSUMBASEN, pPORCENREN, pTOTRECS,  */
  ELSE 
    SET pTOTRECN = 0;
    SET pTOTRECR = 0;
    SET pTOTRECS = 0;
    SET pTOTRECE = 0;
    SET pSUMTOTREC = 0;
  END IF;
	/* SELECT pAPLICA_RETENCIONES_CLI, pAPLICA_RETENCIONES_EMP; */
  IF ( (pAPLICA_RETENCIONES_CLI = 'S') AND
       (pAPLICA_RETENCIONES_EMP = 'S') AND 
        pPORCENRET = 0							
     )  AND (( EXISTS( SELECT PORCENRETENCION_RETENCION
               FROM fza_empresas_retenciones
              WHERE CODIGO_EMPRESA_RETENCION = pCODEMPRESA
							  AND  FECHA_DESDE_RETENCION <= pFECHA
                         AND (    FECHA_HASTA_RETENCION >= pFECHA
                               OR FECHA_HASTA_RETENCION IS NULL)) ) ) THEN 
    SET pPORCENRET = (SELECT PORCENRETENCION_RETENCION 
                        FROM fza_empresas_retenciones 
                       WHERE CODIGO_EMPRESA_RETENCION = pCODEMPRESA
                         AND FECHA_DESDE_RETENCION <= pFECHA
                         AND (    FECHA_HASTA_RETENCION >= pFECHA
                               OR FECHA_HASTA_RETENCION IS NULL) LIMIT 1);
  ELSE
	  IF ((pPORCENRET = 0) OR (pPORCENRET IS NULL)) THEN
		  SET pPORCENRET = 0;
		  SET pTOTALRET = 0;
		END IF;
  END IF;
  IF (pIRPF_IMP_INCL = 'S') THEN
    SET pTOTALRET = (pTOTBASES + pSUMTOT ) * (pPORCENRET/100);
  ELSE
    SET pTOTALRET = pTOTBASES * (pPORCENRET/100);
  END IF;
	/* SELECT pIRPF_IMP_INCL, pTOTALRET, pPORCENRET, pTOTBASES, pSUMTOT; */
	/* SELECT pPORCENRET, pTOTALRET; */
  IF ((pVENTA_ACT_FIJ = 'S') AND (pREG_AG_EMP = 'S')) THEN
    SET pPORCENRET = 0;
    SET PTOTALRET = 0;
  END IF;
  UPDATE fza_facturas 
     SET TOTAL_BASEI_IVAN_FACTURA = pSUMBASEN,
         TOTAL_BASEI_IVAR_FACTURA = pSUMBASER,
         TOTAL_BASEI_IVAS_FACTURA = pSUMBASES,
         TOTAL_BASEI_IVAE_FACTURA = pSUMBASEE,
         TOTAL_IVAN_FACTURA = pTOTN,
         TOTAL_IVAR_FACTURA = pTOTR,
         TOTAL_IVAS_FACTURA = pTOTS,
         TOTAL_IVAE_FACTURA = pTOTE,
         TOTAL_REN_FACTURA = PTOTRECN,
         TOTAL_RER_FACTURA = PTOTRECR,
         TOTAL_RES_FACTURA = PTOTRECS,
         TOTAL_REE_FACTURA = PTOTRECE,
         TOTAL_BASES_FACTURA = pTOTBASES,
         TOTAL_RETENCION_FACTURA = pTOTALRET,
         TOTAL_LIQUIDO_FACTURA = pTOTBASES + 
                                 pSUMTOT - 
                                 PTOTALRET + 
                                 pSUMTOTREC,
         ESIVA_EXENTO_CLIENTE_FACTURA = pIVA_EXENTO,
         ESRETENCIONES_CLIENTE_FACTURA = pAPLICA_RETENCIONES_CLI,
         ESRETENCIONES_EMPRESA_FACTURA = pAPLICA_RETENCIONES_EMP,
         ESIVA_RECARGO_CLIENTE_FACTURA = pAPLICA_RECARGO,
         TOTAL_IMPUESTOS_FACTURA = pSUMTOTREC + pSUMTOT,
         GRUPO_ZONA_IVA_EMPRESA_FACTURA = pGRUPO_ZONA_IVA,
         CODIGO_IVA_FACTURA = pCODIGO_IVA,
         PORCEN_IVAN_FACTURA = pPORCENN,
         PORCEN_IVAE_FACTURA = pPORCENE,
         PORCEN_IVAR_FACTURA = pPORCENR,
         PORCEN_IVAS_FACTURA = pPORCENS,
         PORCEN_RETENCION_FACTURA = pPORCENRET
   WHERE NRO_FACTURA = pNRO_FACTURA 
     AND SERIE_FACTURA = pSERIE_FACTURA;
	 COMMIT;
END $$
DELIMITER ;

-- Recreando procedimiento: PRC_CREAR_ACTUALIZAR_ARTICULO
DROP PROCEDURE IF EXISTS `PRC_CREAR_ACTUALIZAR_ARTICULO`;

DELIMITER $$
CREATE  PROCEDURE `PRC_CREAR_ACTUALIZAR_ARTICULO`(IN pCODIGO_ARTICULO 									varchar(20),
																																						IN pDESCRIPCION_ARTICULO							varchar(1000),
																																						IN pTIPOIVA_ARTICULO                  varchar(2),
																																						IN pTIPO_CANTIDAD_ARTICULO            varchar(20),
																																						IN pESACTIVO_FIJO_ARTICULO            varchar(1),
																																						                    
																																						IN pCODIGO_FAMILIA                    varchar(20),
																																						IN pNOMBRE_FAMILIA                    varchar(200),
																																						
																																						IN pCODIGO_PROVEEDOR                  varchar(20),
																																						IN pRAZONSOCIAL_PROVEEDOR             varchar(200),
																																						IN pESPROVEEDORPRINCIPAL              varchar(1),
																																						IN pPRECIO_ULT_COMPRA                 decimal(19,6),
																																						
																																						IN pCODIGO_TARIFA                     varchar(20),
																																						IN pPRECIOSALIDA_TARIFA								decimal(19,6),
																																						IN pPRECIOFINAL_TARIFA  							decimal(19,6),
																																						IN pPRECIO_DTO_TARIFA		  						decimal(19,6),
																																						IN pPORCEN_DTO_TARIFA			  					decimal(19,6),
																																						
																																						IN `pUSUARIO`                         varchar(100))
BEGIN
DECLARE pCONT BIGINT;
START TRANSACTION;


IF (TRIM(pCODIGO_ARTICULO) <> '') THEN
BEGIN
	IF( EXISTS( SELECT *
								 FROM fza_articulos
								WHERE `CODIGO_ARTICULO` =  pCODIGO_ARTICULO) ) THEN
	 BEGIN
		 UPDATE fza_articulos
				SET 
						DESCRIPCION_ARTICULO              = pDESCRIPCION_ARTICULO   ,
						ESACTIVO_FIJO_ARTICULO            = pESACTIVO_FIJO_ARTICULO,
						TIPOIVA_ARTICULO                  = pTIPOIVA_ARTICULO       ,
						TIPO_CANTIDAD_ARTICULO            = pTIPO_CANTIDAD_ARTICULO ,
						CODIGO_FAMILIA_ARTICULO           = pCODIGO_FAMILIA         ,
						USUARIOMODIF                      = pUSUARIO                ,
						INSTANTEMODIF                     = CURRENT_TIMESTAMP 
			WHERE CODIGO_ARTICULO = pCODIGO_ARTICULO;
		END;
		ELSE
		BEGIN
		  CALL PRC_FNC_GET_NEXT_NRO_DOC('AO', pCONT);
			INSERT INTO fza_articulos (CODIGO_ARTICULO                  ,
														    ORDEN_ARTICULO                    ,		
																DESCRIPCION_ARTICULO              ,
																TIPOIVA_ARTICULO                  ,
																TIPO_CANTIDAD_ARTICULO            ,
																CODIGO_FAMILIA_ARTICULO           ,
																ESACTIVO_FIJO_ARTICULO            ,
																USUARIOMODIF                      ,
																INSTANTEMODIF                     ,
																USUARIOALTA                       ,
																INSTANTEALTA                      
												) VALUES
															 (pCODIGO_ARTICULO                  ,														 
															  pCONT                             ,
																pDESCRIPCION_ARTICULO             , 
																pTIPOIVA_ARTICULO                 ,
																pTIPO_CANTIDAD_ARTICULO           ,
																pCODIGO_FAMILIA                   ,
																pESACTIVO_FIJO_ARTICULO           ,
																pUSUARIO                          ,
																CURRENT_TIMESTAMP			            ,
																pUSUARIO                          ,
																CURRENT_TIMESTAMP			 
																);
		END;
		END IF;
		CALL PRC_CREAR_ACTUALIZAR_FAMILIA(pCODIGO_FAMILIA, pNOMBRE_FAMILIA, pUSUARIO);
		CALL PRC_CREAR_ACTUALIZAR_PROVEEDOR(pCODIGO_PROVEEDOR, pRAZONSOCIAL_PROVEEDOR, pUSUARIO);
		CALL PRC_CREAR_ACTUALIZAR_ARTICULO_PROVEEDOR(pCODIGO_ARTICULO, pCODIGO_PROVEEDOR, pESPROVEEDORPRINCIPAL, pPRECIO_ULT_COMPRA, pUSUARIO);
		CALL PRC_CREAR_ACTUALIZAR_TARIFA(pCODIGO_ARTICULO, pCODIGO_TARIFA, pPRECIOSALIDA_TARIFA, pPRECIOFINAL_TARIFA, pPRECIO_DTO_TARIFA, pPORCEN_DTO_TARIFA, pUSUARIO);
END;
END IF;	
  COMMIT;
END $$
DELIMITER ;

-- Recreando procedimiento: PRC_CREAR_ACTUALIZAR_ARTICULO_PROVEEDOR
DROP PROCEDURE IF EXISTS `PRC_CREAR_ACTUALIZAR_ARTICULO_PROVEEDOR`;

DELIMITER $$
CREATE  PROCEDURE `PRC_CREAR_ACTUALIZAR_ARTICULO_PROVEEDOR`(IN pCODIGO_ARTICULO 									varchar(20),
                                                    IN pCODIGO_PROVEEDOR                  varchar(20),
																										IN pESPROVEEDORPRINCIPAL               varchar(1),
																									  IN pPRECIO_ULT_COMPRA                  decimal(19,6),
																										
																										IN `pUSUARIO`                         varchar(100))
BEGIN
START TRANSACTION;
IF ((TRIM(pCODIGO_PROVEEDOR) <> '') AND 
    (TRIM(pCODIGO_ARTICULO) <> '')) THEN
BEGIN
	 IF( EXISTS( SELECT *
								 FROM fza_articulos_proveedores
								WHERE `CODIGO_PROVEEDOR_ARTICULO_PROVEEDOR` =  pCODIGO_PROVEEDOR
								  AND CODIGO_ARTICULO_ARTICULO_PROVEEDOR = pCODIGO_ARTICULO )) THEN
	 BEGIN
		 UPDATE fza_articulos_proveedores
				SET 
						PRECIO_ULT_COMPRA_ARTICULO_PROVEEDOR     = pPRECIO_ULT_COMPRA   ,
						ESPROVEEDORPRINCIPAL_ARTICULO_PROVEEDOR = pESPROVEEDORPRINCIPAL ,
						USUARIOMODIF              = pUSUARIO                            ,
						INSTANTEMODIF             = CURRENT_TIMESTAMP			 
				WHERE `CODIGO_PROVEEDOR_ARTICULO_PROVEEDOR` =  pCODIGO_PROVEEDOR
				  AND CODIGO_ARTICULO_ARTICULO_PROVEEDOR = pCODIGO_ARTICULO;
		END;
		ELSE
		BEGIN
			INSERT INTO fza_articulos_proveedores (  CODIGO_PROVEEDOR_ARTICULO_PROVEEDOR , 
			                                         CODIGO_ARTICULO_ARTICULO_PROVEEDOR  ,  				
																							 PRECIO_ULT_COMPRA_ARTICULO_PROVEEDOR,
																							 ESPROVEEDORPRINCIPAL_ARTICULO_PROVEEDOR,																 
																				  
																					USUARIOMODIF                     ,
																					INSTANTEMODIF                    ,
																					USUARIOALTA                      ,
																          INSTANTEALTA                      
												                 ) VALUES
																				(pCODIGO_PROVEEDOR                   ,
																				 pCODIGO_ARTICULO                    ,
																				 pPRECIO_ULT_COMPRA             ,		
																				 pESPROVEEDORPRINCIPAL           ,																			
																				 pUSUARIO                         ,
																				 CURRENT_TIMESTAMP			             ,
																				 pUSUARIO                         ,
																				 CURRENT_TIMESTAMP			 
																					);
		END;
		END IF;
END;
END IF;		
COMMIT;
END $$
DELIMITER ;

-- Recreando procedimiento: PRC_CREAR_ACTUALIZAR_CLIENTE
DROP PROCEDURE IF EXISTS `PRC_CREAR_ACTUALIZAR_CLIENTE`;

DELIMITER $$
CREATE  PROCEDURE `PRC_CREAR_ACTUALIZAR_CLIENTE`(IN `pCODIGO_CLIENTE`                       varchar(20),
                            IN `pRAZONSOCIAL_CLIENTE`             varchar(200),
                            IN `pNIF_CLIENTE`                      varchar(50),
                            IN `pMOVIL_CLIENTE`                    varchar(40),
                            IN `pEMAIL_CLIENTE`                   varchar(200),
                            IN `pDIRECCION1_CLIENTE`              varchar(200),
                            IN `pDIRECCION2_CLIENTE`              varchar(200),
                            IN `pPOBLACION_CLIENTE`               varchar(200),
                            IN `pPROVINCIA_CLIENTE`               varchar(200),
                            IN `pCPOSTAL_CLIENTE`                  varchar(15),
														IN `pCOD_PAIS_CLIENTE`								 varchar(3),
                            IN `pPAIS_CLIENTE`                    varchar(150),
                            IN `pESIVA_EXENTO_CLIENTE`              varchar(1),
                            IN `pESRETENCIONES_CLIENTE`             varchar(1),
                            IN `pESIVA_RECARGO_CLIENTE`             varchar(1),
                            IN `pESINTRACOMUNITARIO_CLIENTE`        varchar(1),
                            IN `pESREGIMENESPECIALAGRICOLA_CLIENTE` varchar(1),
                            IN `pTARIFA_ARTICULO_CLIENTE`          varchar(20),
                            IN `pUSUARIO`                         varchar(100))
BEGIN
START TRANSACTION;
 IF( EXISTS( SELECT *
               FROM fza_clientes
              WHERE `CODIGO_CLIENTE` =  pCODIGO_CLIENTE) ) THEN
 BEGIN
   UPDATE fza_clientes
      SET RAZONSOCIAL_CLIENTE               = pRAZONSOCIAL_CLIENTE ,
          NIF_CLIENTE                       = pNIF_CLIENTE         ,
          MOVIL_CLIENTE                     = pMOVIL_CLIENTE       ,
          EMAIL_CLIENTE                     = pEMAIL_CLIENTE       ,
          DIRECCION1_CLIENTE                = pDIRECCION1_CLIENTE  ,
          DIRECCION2_CLIENTE                = pDIRECCION2_CLIENTE  ,
          POBLACION_CLIENTE                 = pPOBLACION_CLIENTE   ,
          PROVINCIA_CLIENTE                 = pPROVINCIA_CLIENTE   ,
          CPOSTAL_CLIENTE                   = pCPOSTAL_CLIENTE     ,
          NOMBRE_PAIS_CLIENTE               = pPAIS_CLIENTE        ,
					CODIGO_PAIS_CLIENTE               = pCOD_PAIS_CLIENTE    ,
          ESIVA_EXENTO_CLIENTE              = pESIVA_EXENTO_CLIENTE  ,
          ESRETENCIONES_CLIENTE             = pESRETENCIONES_CLIENTE ,
          ESIVA_RECARGO_CLIENTE             = pESIVA_RECARGO_CLIENTE ,
          ESREGIMENESPECIALAGRICOLA_CLIENTE = pESREGIMENESPECIALAGRICOLA_CLIENTE,
          ESINTRACOMUNITARIO_CLIENTE        = pESINTRACOMUNITARIO_CLIENTE,
          TARIFA_ARTICULO_CLIENTE           = pTARIFA_ARTICULO_CLIENTE,
          USUARIOMODIF                      = pUSUARIO,
				  INSTANTEMODIF                     = CURRENT_TIMESTAMP
    WHERE CODIGO_cliente = pCODIGO_CLIENTE;
  END;
  ELSE
  BEGIN
    INSERT INTO fza_clientes (CODIGO_CLIENTE                    ,
                              RAZONSOCIAL_CLIENTE               ,
                              NIF_CLIENTE                       ,
                              MOVIL_CLIENTE                     ,
                              EMAIL_CLIENTE                     ,
                              DIRECCION1_CLIENTE                ,
                              DIRECCION2_CLIENTE                ,
                              POBLACION_CLIENTE                 ,
                              PROVINCIA_CLIENTE                 ,
                              CPOSTAL_CLIENTE                   ,
                              NOMBRE_PAIS_CLIENTE               ,
															CODIGO_PAIS_CLIENTE               ,
                              ESIVA_EXENTO_CLIENTE              ,
                              ESRETENCIONES_CLIENTE             ,
                              ESIVA_RECARGO_CLIENTE             ,
                              ESREGIMENESPECIALAGRICOLA_CLIENTE ,
                              ESINTRACOMUNITARIO_CLIENTE        ,
                              TARIFA_ARTICULO_CLIENTE           ,
                              USUARIOMODIF                      ,
                              USUARIOALTA                       ,
                              INSTANTEALTA                      ,
                              INSTANTEMODIF
                      ) VALUES
                             (pCODIGO_CLIENTE                   ,
                              pRAZONSOCIAL_CLIENTE              ,
                              pNIF_CLIENTE                      ,
                              pMOVIL_CLIENTE                    ,
                              pEMAIL_CLIENTE                    ,
                              pDIRECCION1_CLIENTE               ,
                              pDIRECCION2_CLIENTE               ,
                              pPOBLACION_CLIENTE                ,
                              pPROVINCIA_CLIENTE                ,
                              pCPOSTAL_CLIENTE                  ,
                              pPAIS_CLIENTE                     ,
															pCOD_PAIS_CLIENTE                 ,
                              pESIVA_EXENTO_CLIENTE             ,
                              pESRETENCIONES_CLIENTE            ,
                              pESIVA_RECARGO_CLIENTE            ,
                              pESREGIMENESPECIALAGRICOLA_CLIENTE,
                              pESINTRACOMUNITARIO_CLIENTE       ,
                              pTARIFA_ARTICULO_CLIENTE          ,
                              pUSUARIO                          ,
                              pUSUARIO                          ,
                              CURRENT_TIMESTAMP                 ,
                              CURRENT_TIMESTAMP           
                              );
  END;
  END IF;
  COMMIT;
END $$
DELIMITER ;

-- Recreando procedimiento: PRC_CREAR_ACTUALIZAR_EMPRESA
DROP PROCEDURE IF EXISTS `PRC_CREAR_ACTUALIZAR_EMPRESA`;

DELIMITER $$
CREATE  PROCEDURE `PRC_CREAR_ACTUALIZAR_EMPRESA`(IN `pCODIGO_EMPRESA`                varchar(10), 
																																					 IN `pRAZONSOCIAL_EMPRESA`           varchar(200),
																																					 IN `pNIF_EMPRESA`                   varchar(50),
																																					 IN `pMOVIL_EMPRESA`                 varchar(40),
																																					 IN `pEMAIL_EMPRESA`                 varchar(200),
																																					 IN `pDIRECCION1_EMPRESA`            varchar(200),
																																					 IN `pDIRECCION2_EMPRESA`            varchar(200),
																																					 IN `pPOBLACION_EMPRESA`             varchar(200),
																																					 IN `pPROVINCIA_EMPRESA`             varchar(200),
																																					 IN `pCPOSTAL_EMPRESA`               varchar(15),
																																					 IN `pPAIS_EMPRESA`                  varchar(150),
																																					 IN `pCODPAIS_EMPRESA`               varchar(150),
																																					 IN `pRETENCIONES_EMPRESA`           varchar(1),
																																					 IN `pIVA_RECARGO_EMPRESA`           varchar(1),
																																					 IN `pREGIMENESPECIALAGRICOLA_EMPRESA` varchar(1),
																																					 IN `pGRUPO_ZONA_IVA_EMPRESA`        varchar(10),
																																					 IN `pUSUARIO`                       varchar(100))
BEGIN
START TRANSACTION;
 IF( EXISTS(
             SELECT *
             FROM fza_empresas
             WHERE `CODIGO_EMPRESA` =  pCODIGO_EMPRESA) ) THEN
  UPDATE fza_EMPRESAs
    SET  RAZONSOCIAL_EMPRESA               = pRAZONSOCIAL_EMPRESA            ,
         NIF_EMPRESA                       = pNIF_EMPRESA                    ,
         MOVIL_EMPRESA                     = pMOVIL_EMPRESA                  ,
         EMAIL_EMPRESA                     = pEMAIL_EMPRESA                  ,
         DIRECCION1_EMPRESA                = pDIRECCION1_EMPRESA             ,
         DIRECCION2_EMPRESA                = pDIRECCION2_EMPRESA             ,
         POBLACION_EMPRESA                 = pPOBLACION_EMPRESA              ,
         PROVINCIA_EMPRESA                 = pPROVINCIA_EMPRESA              ,
         CPOSTAL_EMPRESA                   = pCPOSTAL_EMPRESA                ,
         NOMBRE_PAIS_EMPRESA                      = pPAIS_EMPRESA            ,
				 CODIGO_PAIS_EMPRESA							 = pCODPAIS_EMPRESA                ,
         ESRETENCIONES_EMPRESA             = pRETENCIONES_EMPRESA            ,
         ESREGIMENESPECIALAGRICOLA_EMPRESA = pREGIMENESPECIALAGRICOLA_EMPRESA,
         GRUPO_ZONA_IVA_EMPRESA            = pGRUPO_ZONA_IVA_EMPRESA,
         USUARIOMODIF                      = pUSUARIO,
			   INSTANTEMODIF                     = CURRENT_TIMESTAMP			
  WHERE CODIGO_EMPRESA = pCODIGO_EMPRESA;
  ELSE
  INSERT INTO fza_EMPRESAs (CODIGO_EMPRESA                    ,
                            RAZONSOCIAL_EMPRESA               ,
                            NIF_EMPRESA                       ,
                            MOVIL_EMPRESA                     ,
                            EMAIL_EMPRESA                     ,
                            DIRECCION1_EMPRESA                ,
                            DIRECCION2_EMPRESA                ,
                            POBLACION_EMPRESA                 ,
                            PROVINCIA_EMPRESA                 ,
                            CPOSTAL_EMPRESA                   ,
                            NOMBRE_PAIS_EMPRESA               ,
														CODIGO_PAIS_EMPRESA               ,
                            ESRETENCIONES_EMPRESA             ,
                            ESREGIMENESPECIALAGRICOLA_EMPRESA ,
                            GRUPO_ZONA_IVA_EMPRESA            ,
                            USUARIOMODIF                      ,
                            USUARIOALTA                       ,
                            INSTANTEALTA                      ,
													  INSTANTEMODIF		
                    ) VALUES
                           (pCODIGO_EMPRESA      ,
                            pRAZONSOCIAL_EMPRESA ,
                            pNIF_EMPRESA         ,
                            pMOVIL_EMPRESA       ,
                            pEMAIL_EMPRESA       ,
                            pDIRECCION1_EMPRESA  ,
                            pDIRECCION2_EMPRESA  ,
                            pPOBLACION_EMPRESA   ,
                            pPROVINCIA_EMPRESA   ,
                            pCPOSTAL_EMPRESA     ,
                            pPAIS_EMPRESA        ,
														pCODPAIS_EMPRESA     ,
                            pRETENCIONES_EMPRESA ,
                            pREGIMENESPECIALAGRICOLA_EMPRESA,
                            pGRUPO_ZONA_IVA_EMPRESA,
                            pUSUARIO             ,
                            pUSUARIO             ,
                            CURRENT_TIMESTAMP,
											      CURRENT_TIMESTAMP						
                            );
  END IF;
  COMMIT;
END $$
DELIMITER ;

-- Recreando procedimiento: PRC_CREAR_ACTUALIZAR_FAMILIA
DROP PROCEDURE IF EXISTS `PRC_CREAR_ACTUALIZAR_FAMILIA`;

DELIMITER $$
CREATE  PROCEDURE `PRC_CREAR_ACTUALIZAR_FAMILIA`(IN pCODIGO_FAMILIA                     varchar(20),
																																						IN pNOMBRE_FAMILIA                    varchar(200),
																																					
																																						IN `pUSUARIO`                         varchar(100))
BEGIN
DECLARE pCONT BIGINT;
START TRANSACTION;
IF (TRIM(pCODIGO_FAMILIA) <> '') THEN
BEGIN
	 IF( EXISTS( SELECT *
								 FROM fza_articulos_familias
								WHERE `CODIGO_FAMILIA` =  pCODIGO_FAMILIA) ) THEN
	 BEGIN
		 UPDATE fza_articulos_familias
				SET 
						NOMBRE_FAMILIA                    = pNOMBRE_FAMILIA   ,
						DESCRIPCION_FAMILIA               = pNOMBRE_FAMILIA       ,
						USUARIOMODIF                      = pUSUARIO                ,
						INSTANTEMODIF                     = CURRENT_TIMESTAMP			 
			WHERE CODIGO_FAMILIA = pCODIGO_FAMILIA;
		END;
		ELSE
		BEGIN
			CALL PRC_FNC_GET_NEXT_NRO_DOC('FO', pCONT);
			INSERT INTO fza_articulos_familias (CODIGO_FAMILIA                   ,
																					ORDEN_FAMILIA                    ,
																				  NOMBRE_FAMILIA                   ,
                                          DESCRIPCION_FAMILIA              ,
																					USUARIOMODIF                     ,
																					INSTANTEMODIF                    ,
																					USUARIOALTA                      ,
																          INSTANTEALTA                      
												                 ) VALUES
																				(pCODIGO_FAMILIA                   ,
																				 pCONT                             ,
																				 pNOMBRE_FAMILIA                    ,
																				 pNOMBRE_FAMILIA                    ,
																				 pUSUARIO                         ,
																				 CURRENT_TIMESTAMP			             ,
																				 pUSUARIO                         ,
																				 CURRENT_TIMESTAMP			 
																					);
		END;
		END IF;
END;
END IF;		
COMMIT;
END $$
DELIMITER ;

-- Recreando procedimiento: PRC_CREAR_ACTUALIZAR_KEY
DROP PROCEDURE IF EXISTS `PRC_CREAR_ACTUALIZAR_KEY`;

DELIMITER $$
CREATE  PROCEDURE `PRC_CREAR_ACTUALIZAR_KEY`(IN `pUSUARIO`       varchar(200),
                                              IN `pKEY`           varchar(100),
                                              IN `pSUBKEY`        varchar(100),
                                              IN `pVALUE`         varchar(200),
                                              IN `pVALUE_TEXT`    text,
                                              IN `pUSUARIO_MODIF` varchar(100))
BEGIN
START TRANSACTION;
 IF( EXISTS(
             SELECT *
               FROM `fza_usuarios_perfiles`
              WHERE `USUARIO_GRUPO_PERFILES` = `pUSUARIO`
                AND `KEY_PERFILES`           = `pKEY` 
                AND `SUBKEY_PERFILES`        = `pSUBKEY` )) THEN
  BEGIN
    UPDATE `fza_usuarios_perfiles`
      SET `VALUE_PERFILES`      = `pVALUE`,
          `VALUE_TEXT_PERFILES` = `pVALUE_TEXT`,
          `USUARIOMODIF`        = `pUSUARIO_MODIF`
    WHERE `USUARIO_GRUPO_PERFILES` = `pUSUARIO`
      AND `KEY_PERFILES`           = `pKEY` 
      AND `SUBKEY_PERFILES`        = `pSUBKEY`;
  END;
  ELSE
  BEGIN
    INSERT INTO fza_usuarios_perfiles (`USUARIO_GRUPO_PERFILES`, 
                                       `KEY_PERFILES`          , 
                                       `SUBKEY_PERFILES`       , 
                                       `VALUE_PERFILES`        , 
                                       `VALUE_TEXT_PERFILES`   , 
                                       `INSTANTEALTA`          , 
                                       `USUARIOALTA`           , 
                                       `USUARIOMODIF`
                                      ) VALUES
                             (`pUSUARIO`         ,
                              `pKEY`             ,
                              `pSUBKEY`          ,
                              `pVALUE`           ,
                              `pVALUE_TEXT`      ,
                              CURRENT_TIMESTAMP  ,
                              `pUSUARIO_MODIF`   ,
                              `pUSUARIO_MODIF`
                             );
  END;
  END IF;
  COMMIT;
END $$
DELIMITER ;

-- Recreando procedimiento: PRC_CREAR_ACTUALIZAR_PROVEEDOR
DROP PROCEDURE IF EXISTS `PRC_CREAR_ACTUALIZAR_PROVEEDOR`;

DELIMITER $$
CREATE  PROCEDURE `PRC_CREAR_ACTUALIZAR_PROVEEDOR`(IN pCODIGO_PROVEEDOR                  varchar(20),
																										IN pRAZONSOCIAL_PROVEEDOR             varchar(200),
																									
																										IN `pUSUARIO`                         varchar(100))
BEGIN
DECLARE pCONT BIGINT;
START TRANSACTION;
IF (TRIM(pCODIGO_PROVEEDOR) <> '') THEN
BEGIN
	 IF( EXISTS( SELECT *
								 FROM fza_proveedores
								WHERE `CODIGO_PROVEEDOR` =  pCODIGO_PROVEEDOR) ) THEN
	 BEGIN
		 UPDATE fza_proveedores
				SET 
						RAZONSOCIAL_PROVEEDOR     = pRAZONSOCIAL_PROVEEDOR   ,
						USUARIOMODIF              = pUSUARIO                ,
						INSTANTEMODIF             = CURRENT_TIMESTAMP			 
			WHERE CODIGO_PROVEEDOR = pCODIGO_PROVEEDOR;
		END;
		ELSE
		BEGIN
			CALL PRC_FNC_GET_NEXT_NRO_DOC('PO', pCONT);
			INSERT INTO fza_proveedores (  CODIGO_PROVEEDOR                      ,
																					ORDEN_PROVEEDOR                  ,
																				  RAZONSOCIAL_PROVEEDOR            ,																				
																					USUARIOMODIF                     ,
																					INSTANTEMODIF                    ,
																					USUARIOALTA                      ,
																          INSTANTEALTA                      
												                 ) VALUES
																				(pCODIGO_PROVEEDOR                   ,
																				 pCONT                             ,
																				 pRAZONSOCIAL_PROVEEDOR             ,																				 
																				 pUSUARIO                         ,
																				 CURRENT_TIMESTAMP			             ,
																				 pUSUARIO                         ,
																				 CURRENT_TIMESTAMP			 
																					);
		END;
		END IF;
END;
END IF;		
COMMIT;
END $$
DELIMITER ;

-- Recreando procedimiento: PRC_CREAR_ACTUALIZAR_TARIFA
DROP PROCEDURE IF EXISTS `PRC_CREAR_ACTUALIZAR_TARIFA`;

DELIMITER $$
CREATE  PROCEDURE `PRC_CREAR_ACTUALIZAR_TARIFA`(IN pCODIGO_ARTICULO                   varchar(20),
																										                        IN pCODIGO_TARIFA                     varchar(20),
																																						IN pPRECIOSALIDA_TARIFA								decimal(19,6),
																																						IN pPRECIOFINAL_TARIFA  							decimal(19,6),
																																						IN pPRECIO_DTO_TARIFA		  						decimal(19,6),
																																						IN pPORCEN_DTO_TARIFA			  					decimal(19,6),
																										                        IN `pUSUARIO`                         varchar(100))
BEGIN

DECLARE ppPRECIOSALIDA_TARIFA    decimal(19,6);
DECLARE	ppPRECIOFINAL_TARIFA     decimal(19,6);
DECLARE	ppPORCEN_DTO_TARIFA      decimal(19,6);
DECLARE	ppPRECIO_DTO_TARIFA      decimal(19,6);

START TRANSACTION;

IF (TRIM(pCODIGO_TARIFA) <> '') THEN
BEGIN
	CALL PRC_FNC_GET_PRECIO_ARTICULO_FECHA(pCODIGO_ARTICULO, 
	                                       CURRENT_DATE, 
																				 ppPRECIOSALIDA_TARIFA, 
																				 ppPRECIOFINAL_TARIFA,
																				 ppPORCEN_DTO_TARIFA,
																				 ppPRECIO_DTO_TARIFA);

	IF (ppPRECIOFINAL_TARIFA IS NOT NULL) THEN
	BEGIN
		 UPDATE fza_articulos_tarifas
				SET 
						PRECIOSALIDA_TARIFA	   = pPRECIOSALIDA_TARIFA,
            PRECIOFINAL_TARIFA     = pPRECIOFINAL_TARIFA,
            PRECIO_DTO_TARIFA		   = pPRECIO_DTO_TARIFA,
            PORCEN_DTO_TARIFA		   = pPORCEN_DTO_TARIFA,
						USUARIOMODIF           = pUSUARIO          ,
						INSTANTEMODIF          = CURRENT_TIMESTAMP			 
			WHERE CODIGO_ARTICULO_TARIFA =  pCODIGO_ARTICULO
				AND  CODIGO_TARIFA = pCODIGO_TARIFA;
		END;
		ELSE
		BEGIN
			IF (ppPRECIOFINAL_TARIFA IS NULL) THEN
			BEGIN
				INSERT INTO fza_articulos_tarifas ( CODIGO_ARTICULO_TARIFA,
																						CODIGO_TARIFA,
																						PRECIOSALIDA_TARIFA	,
																						PRECIOFINAL_TARIFA  ,
																						PRECIO_DTO_TARIFA		,
																						PORCEN_DTO_TARIFA		,
																						FECHA_DESDE_TARIFA  ,
																						USUARIOMODIF                     ,
																						INSTANTEMODIF                    ,
																						USUARIOALTA                      ,
																						INSTANTEALTA                      
																					 ) VALUES
																					(pCODIGO_ARTICULO                   ,
																					 pCODIGO_TARIFA                     ,
																					 pPRECIOSALIDA_TARIFA             ,
																					 pPRECIOFINAL_TARIFA              ,
																					 pPRECIO_DTO_TARIFA               ,
																					 pPORCEN_DTO_TARIFA               ,
																					 CURRENT_TIMESTAMP               ,
																					 pUSUARIO                         ,
																					 CURRENT_TIMESTAMP			             ,
																					 pUSUARIO                         ,
																					 CURRENT_TIMESTAMP			 
																						);
			END;
			END IF;
		END;
		END IF;
END;
END IF;		
COMMIT;
END $$
DELIMITER ;

-- Recreando procedimiento: PRC_CREAR_ACTUALIZAR_TEST
DROP PROCEDURE IF EXISTS `PRC_CREAR_ACTUALIZAR_TEST`;

DELIMITER $$
CREATE  PROCEDURE `PRC_CREAR_ACTUALIZAR_TEST`()
BEGIN
  CALL PRC_FNC_GET_PRECIO_ARTICULO_FECHA('PAÑITOS', CURRENT_DATE, @PRECIOFINAL, @PRECIO_INICIAL, @PORCEN_DTO, @PRECIO_DTO);
  /* SELECT @PRECIOFINAL, @PRECIO_INICIAL, @PORCEN_DTO, @PRECIO_DTO; */
			IF (@PRECIOFINAL IS NULL) THEN
			BEGIN
			 SELECT 'HOLA';
		 END;
		 ELSE
	   BEGIN
		   SELECT 'NO HAY';
		 END;
		 END IF;
END $$
DELIMITER ;

-- Recreando procedimiento: PRC_CREAR_FACTURA_ABONO
DROP PROCEDURE IF EXISTS `PRC_CREAR_FACTURA_ABONO`;

DELIMITER $$
CREATE  PROCEDURE `PRC_CREAR_FACTURA_ABONO`(IN `pidseriefactura`      varchar(200),
                                      IN `pidnumfactura`        varchar(200),
                                      IN `pidseriefacturaabono` varchar(200),
																			IN `pidcodigo_empresa`    varchar(200),
                                      IN `pfechafacturaabono`   date,
                                     OUT `pidnumfacturaabono`   varchar(200),
                                      IN `pUSUARIO`             varchar(100))
BEGIN
   DECLARE contadorped varchar(200);
   START TRANSACTION;
   CALL PRC_GET_NEXT_CONT_FACT_SERIE(pidseriefacturaabono, 'FC', pidcodigo_empresa, pUSUARIO, @cont);   
   SET @pFecha = (SELECT DATE_FORMAT(pfechafacturaabono, '%Y-%m-%d'));
   SET contadorped = @cont;     
   SET pidnumfacturaabono = contadorped;
   INSERT INTO fza_facturas  (`NRO_FACTURA`                                  ,
                              `SERIE_FACTURA`                                ,
                              `FECHA_FACTURA`                                ,
                              `CODIGO_EMPRESA_FACTURA`                       ,
                              `RAZONSOCIAL_EMPRESA_FACTURA`                  ,
                              `NIF_EMPRESA_FACTURA`                          ,
                              `MOVIL_EMPRESA_FACTURA`                        ,
                              `EMAIL_EMPRESA_FACTURA`                        ,
                              `DIRECCION1_EMPRESA_FACTURA`                   ,
                              `DIRECCION2_EMPRESA_FACTURA`                   ,
                              `POBLACION_EMPRESA_FACTURA`                    ,
                              `PROVINCIA_EMPRESA_FACTURA`                    ,
                              `NOMBRE_PAIS_EMPRESA_FACTURA`                         ,
															`CODIGO_PAIS_EMPRESA_FACTURA`                         ,
                              `CPOSTAL_EMPRESA_FACTURA`                      ,
                              `ESRETENCIONES_EMPRESA_FACTURA`                ,
                              `GRUPO_ZONA_IVA_EMPRESA_FACTURA`               ,
                              `ESREGIMENESPECIALAGRICOLA_EMPRESA_FACTURA`    ,
                              `CODIGO_CLIENTE_FACTURA`                       ,
                              `RAZONSOCIAL_CLIENTE_FACTURA`                  ,
                              `NIF_CLIENTE_FACTURA`                          ,
                              `MOVIL_CLIENTE_FACTURA`                        ,
                              `EMAIL_CLIENTE_FACTURA`                        ,
                              `DIRECCION1_CLIENTE_FACTURA`                   ,
                              `DIRECCION2_CLIENTE_FACTURA`                   ,
                              `POBLACION_CLIENTE_FACTURA`                    ,
                              `PROVINCIA_CLIENTE_FACTURA`                    ,
                              `CPOSTAL_CLIENTE_FACTURA`                      ,
                              `NOMBRE_PAIS_CLIENTE_FACTURA`                         ,
															`CODIGO_PAIS_CLIENTE_FACTURA`                         ,
                              `ESIVA_RECARGO_CLIENTE_FACTURA`                ,
                              `ESIVA_EXENTO_CLIENTE_FACTURA`                 ,
                              `ESREGIMENESPECIALAGRICOLA_CLIENTE_FACTURA`    ,
                              `ESRETENCIONES_CLIENTE_FACTURA`                ,
                              `TARIFA_ARTICULO_CLIENTE_FACTURA`              ,
                              `ESIMP_INCL_TARIFA_CLIENTE_FACTURA`            ,
                              `ESINTRACOMUNITARIO_CLIENTE_FACTURA`           ,
                              `ESIRPF_IMP_INCL_ZONA_IVA_FACTURA`             ,
                              `ESAPLICA_RE_ZONA_IVA_FACTURA`                 ,
                              `ESIVAAGRICOLA_ZONA_IVA_FACTURA`               ,
                              `PALABRA_REPORTS_ZONA_IVA_FACTURA`             ,
                              `CODIGO_IVA_FACTURA`                           ,
                              `ESVENTA_ACTIVO_FIJO_FACTURA`                  ,
                              `PORCEN_IVAN_FACTURA`                          ,
                              `TOTAL_IVAN_FACTURA`                           ,
                              `PORCEN_REN_FACTURA`                           ,
                              `TOTAL_REN_FACTURA`                            ,
                              `TOTAL_BASEI_IVAN_FACTURA`                     ,
                              `PORCEN_IVAR_FACTURA`                          ,
                              `TOTAL_IVAR_FACTURA`                           ,
                              `PORCEN_RER_FACTURA`                           ,
                              `TOTAL_RER_FACTURA`                            ,
                              `TOTAL_BASEI_IVAR_FACTURA`                     ,
                              `PORCEN_IVAS_FACTURA`                          ,
                              `TOTAL_IVAS_FACTURA`                           ,
                              `PORCEN_RES_FACTURA`                           ,
                              `TOTAL_RES_FACTURA`                            ,
                              `TOTAL_BASEI_IVAS_FACTURA`                     ,
                              `PORCEN_IVAE_FACTURA`                          ,
                              `TOTAL_IVAE_FACTURA`                           ,
                              `PORCEN_REE_FACTURA`                           ,
                              `TOTAL_REE_FACTURA`                            ,
                              `TOTAL_BASEI_IVAE_FACTURA`                     ,
                              `TOTAL_BASES_FACTURA`                          ,
                              `TOTAL_IMPUESTOS_FACTURA`                      ,
                              `FORMA_PAGO_FACTURA`                           ,
                              `PORCEN_RETENCION_FACTURA`                     ,
                              `TOTAL_RETENCION_FACTURA`                      ,
                              `TOTAL_LIQUIDO_FACTURA`                        ,
                              `NRO_FACTURA_ABONO_FACTURA`                    ,
                              `SERIE_FACTURA_ABONO_FACTURA`                  ,
                              `TEXTO_LEGAL_FACTURA_CLIENTE_FACTURA`          ,
                              `TEXTO_LEGAL_FACTURA_EMPRESA_FACTURA`          ,
                              `DOCUMENTO_FACTURA`                            ,
                              `COMENTARIOS_FACTURA`                          ,
                              `CONTADOR_LINEAS_FACTURA`                      ,
															`ESCREARARTICULOS_FACTURA`										 ,	
                              `ESDESCRIPCIONES_AMP_FACTURA`	                 ,
                              `ESFECHADEENTREGA_FACTURA`	                   ,
                              `INSTANTEMODIF`                                ,
                              `INSTANTEALTA`                                 ,
                              `USUARIOALTA`                                  ,                        
                              `USUARIOMODIF`
                             )                                 
                     SELECT `contadorped`                                    ,
                            `pidseriefacturaabono`                           ,
                            `@pFecha`                                        ,
                            `CODIGO_EMPRESA_FACTURA`                         ,
                            `RAZONSOCIAL_EMPRESA_FACTURA`                    ,
                            `NIF_EMPRESA_FACTURA`                            ,
                            `MOVIL_EMPRESA_FACTURA`                          ,
                            `EMAIL_EMPRESA_FACTURA`                          ,
                            `DIRECCION1_EMPRESA_FACTURA`                     ,
                            `DIRECCION2_EMPRESA_FACTURA`                     ,
                            `POBLACION_EMPRESA_FACTURA`                      ,
                            `PROVINCIA_EMPRESA_FACTURA`                      ,
                            `NOMBRE_PAIS_EMPRESA_FACTURA`                           ,
														`CODIGO_PAIS_EMPRESA_FACTURA`                           ,
                            `CPOSTAL_EMPRESA_FACTURA`                        ,
                            `ESRETENCIONES_EMPRESA_FACTURA`                  ,
                            `GRUPO_ZONA_IVA_EMPRESA_FACTURA`                 ,
                            `ESREGIMENESPECIALAGRICOLA_EMPRESA_FACTURA`      ,
                            `CODIGO_CLIENTE_FACTURA`                         ,
                            `RAZONSOCIAL_CLIENTE_FACTURA`                    ,
                            `NIF_CLIENTE_FACTURA`                            ,
                            `MOVIL_CLIENTE_FACTURA`                          ,
                            `EMAIL_CLIENTE_FACTURA`                          ,
                            `DIRECCION1_CLIENTE_FACTURA`                     ,
                            `DIRECCION2_CLIENTE_FACTURA`                     ,
                            `POBLACION_CLIENTE_FACTURA`                      ,
                            `PROVINCIA_CLIENTE_FACTURA`                      ,
                            `CPOSTAL_CLIENTE_FACTURA`                        ,
                            `NOMBRE_PAIS_CLIENTE_FACTURA`                           ,
														`CODIGO_PAIS_CLIENTE_FACTURA`                           ,
                            `ESIVA_RECARGO_CLIENTE_FACTURA`                  ,
                            `ESIVA_EXENTO_CLIENTE_FACTURA`                   ,
                            `ESREGIMENESPECIALAGRICOLA_CLIENTE_FACTURA`      ,
                            `ESRETENCIONES_CLIENTE_FACTURA`                  ,
                            `TARIFA_ARTICULO_CLIENTE_FACTURA`                ,
                            `ESIMP_INCL_TARIFA_CLIENTE_FACTURA`              ,
                            `ESINTRACOMUNITARIO_CLIENTE_FACTURA`             ,
                            `ESIRPF_IMP_INCL_ZONA_IVA_FACTURA`               ,
                            `ESAPLICA_RE_ZONA_IVA_FACTURA`                   ,
                            `ESIVAAGRICOLA_ZONA_IVA_FACTURA`                 ,
                            `PALABRA_REPORTS_ZONA_IVA_FACTURA`               ,
                            `CODIGO_IVA_FACTURA`                             ,
                            `ESVENTA_ACTIVO_FIJO_FACTURA`                    ,
                            `PORCEN_IVAN_FACTURA`                            ,
                            `TOTAL_IVAN_FACTURA`                             ,
                            `PORCEN_REN_FACTURA`                             ,
                            `TOTAL_REN_FACTURA`                              ,
                            `TOTAL_BASEI_IVAN_FACTURA`                       ,
                            `PORCEN_IVAR_FACTURA`                            ,
                            `TOTAL_IVAR_FACTURA`                             ,
                            `PORCEN_RER_FACTURA`                             ,
                            `TOTAL_RER_FACTURA`                              ,
                            `TOTAL_BASEI_IVAR_FACTURA`                       ,
                            `PORCEN_IVAS_FACTURA`                            ,
                            `TOTAL_IVAS_FACTURA`                             ,
                            `PORCEN_RES_FACTURA`                             ,
                            `TOTAL_RES_FACTURA`                              ,
                            `TOTAL_BASEI_IVAS_FACTURA`                       ,
                            `PORCEN_IVAE_FACTURA`                            ,
                            `TOTAL_IVAE_FACTURA`                             ,
                            `PORCEN_REE_FACTURA`                             ,
                            `TOTAL_REE_FACTURA`                              ,
                            `TOTAL_BASEI_IVAE_FACTURA`                       ,
                            `TOTAL_BASES_FACTURA`                            ,
                            `TOTAL_IMPUESTOS_FACTURA`                        ,
                            `FORMA_PAGO_FACTURA`                             ,
                            `PORCEN_RETENCION_FACTURA`                       ,
                            `TOTAL_RETENCION_FACTURA`                        ,
                            `TOTAL_LIQUIDO_FACTURA`                          ,
                            `NRO_FACTURA_ABONO_FACTURA`                      ,
                            `SERIE_FACTURA_ABONO_FACTURA`                    ,
                            `TEXTO_LEGAL_FACTURA_CLIENTE_FACTURA`            ,
                            `TEXTO_LEGAL_FACTURA_EMPRESA_FACTURA`            ,
                            `DOCUMENTO_FACTURA`                              ,
                            `COMENTARIOS_FACTURA`                            ,
                            `CONTADOR_LINEAS_FACTURA`                        ,
														`ESCREARARTICULOS_FACTURA`											 ,	
                            `ESDESCRIPCIONES_AMP_FACTURA`	                   ,
                            `ESFECHADEENTREGA_FACTURA`	                     , 
                            CURRENT_TIMESTAMP                                 ,
                            CURRENT_TIMESTAMP                                 ,
                            `pUSUARIO`                                       ,
                            `pUSUARIO`
                       FROM `fza_facturas` 
                      WHERE `NRO_FACTURA`   = `pidnumfactura` 
                        AND `SERIE_FACTURA` = `pidseriefactura`;  
  INSERT INTO `fza_facturas_lineas` (`NRO_FACTURA_LINEA`                      ,
                                     `SERIE_FACTURA_LINEA`                    ,
                                     `LINEA_FACTURA_LINEA`                    ,
                                     `CODIGO_ARTICULO_FACTURA_LINEA`          ,
                                     `TIPO_CANTIDAD_ARTICULO_FACTURA_LINEA`   ,
                                     `ESIMP_INCL_TARIFA_FACTURA_LINEA`        ,
                                     `TIPOIVA_ARTICULO_FACTURA_LINEA`         ,
                                     `DESCRIPCION_ARTICULO_FACTURA_LINEA`     ,
                                     `CANTIDAD_FACTURA_LINEA`                 ,
                                     `PRECIOVENTA_SIVA_ARTICULO_FACTURA_LINEA`,
                                     `PORCEN_IVA_FACTURA_LINEA`               ,
                                     `PRECIOVENTA_CIVA_ARTICULO_FACTURA_LINEA`,
                                     `TOTAL_FACTURA_LINEA`                    ,
                                     `INSTANTEMODIF`                          ,
                                     `INSTANTEALTA`                           ,
                                     `USUARIOALTA`                            ,                        
                                     `USUARIOMODIF`                  
                                      ) 
                              SELECT `contadorped`                             ,
                                     `pidseriefacturaabono`                    ,
                                     `LINEA_FACTURA_LINEA`                     ,
                                     `CODIGO_ARTICULO_FACTURA_LINEA`           ,
                                     `TIPO_CANTIDAD_ARTICULO_FACTURA_LINEA`    ,
                                     `ESIMP_INCL_TARIFA_FACTURA_LINEA`         ,
                                     `TIPOIVA_ARTICULO_FACTURA_LINEA`          ,
                                     `DESCRIPCION_ARTICULO_FACTURA_LINEA`      ,
                                     (`CANTIDAD_FACTURA_LINEA`*-1)             ,
                                     `PRECIOVENTA_SIVA_ARTICULO_FACTURA_LINEA` ,
                                     `PORCEN_IVA_FACTURA_LINEA`                ,
                                     `PRECIOVENTA_CIVA_ARTICULO_FACTURA_LINEA` ,
                                     (`TOTAL_FACTURA_LINEA` * -1)              ,
                                     CURRENT_TIMESTAMP                          ,
                                     CURRENT_TIMESTAMP                          ,
                                     `pUSUARIO`                                ,
                                     `pUSUARIO`
                               FROM  `fza_facturas_lineas` 
                              WHERE  `SERIE_FACTURA_LINEA`  = `pidseriefactura`
                                AND  `NRO_FACTURA_LINEA`    = `pidnumfactura`  ;                 
   CALL `PRC_CALCULAR_FACTURA_NETOS`(`pidseriefacturaabono`, `contadorped`);
   COMMIT;
END $$
DELIMITER ;

-- Recreando procedimiento: PRC_CREAR_FACTURA_DUPLICADA
DROP PROCEDURE IF EXISTS `PRC_CREAR_FACTURA_DUPLICADA`;

DELIMITER $$
CREATE  PROCEDURE `PRC_CREAR_FACTURA_DUPLICADA`(IN `pidseriefactura`      varchar(200),
                                        IN `pidnumfactura`        varchar(200),
                                        IN `pidseriefacturaabono` varchar(200),
																				IN `pidcodigo_empresa`    varchar(200),
                                        IN `pfechafacturaabono`   date,
                                        IN `pUSUARIO`             varchar(100),
                                       OUT `pidnumfacturaabono`   varchar(200))
BEGIN
   DECLARE `contadorped` varchar(200);
   DECLARE `pfecha` date;
   START TRANSACTION;
   CALL PRC_GET_NEXT_CONT_FACT_SERIE(`pidseriefacturaabono`, 
                                     'FC', 
																		 pidcodigo_empresa,
																		 pUSUARIO,
                                     `contadorped`);
   SET pFecha = (SELECT DATE_FORMAT(`pfechafacturaabono`, '%Y-%m-%d'));
   SET pidnumfacturaabono = contadorped;
   INSERT INTO fza_facturas (`NRO_FACTURA`                                  ,
                             `SERIE_FACTURA`                                ,
                             `FECHA_FACTURA`                                ,
                             `CODIGO_EMPRESA_FACTURA`                       ,
                             `RAZONSOCIAL_EMPRESA_FACTURA`                  ,
                             `NIF_EMPRESA_FACTURA`                          ,
                             `MOVIL_EMPRESA_FACTURA`                        ,
                             `EMAIL_EMPRESA_FACTURA`                        ,
                             `DIRECCION1_EMPRESA_FACTURA`                   ,
                             `DIRECCION2_EMPRESA_FACTURA`                   ,
                             `POBLACION_EMPRESA_FACTURA`                    ,
                             `PROVINCIA_EMPRESA_FACTURA`                    ,
                             `NOMBRE_PAIS_EMPRESA_FACTURA`                  ,
														 `CODIGO_PAIS_EMPRESA_FACTURA`                  ,
                             `CPOSTAL_EMPRESA_FACTURA`                      ,
                             `ESRETENCIONES_EMPRESA_FACTURA`                ,
                             `GRUPO_ZONA_IVA_EMPRESA_FACTURA`               ,
                             `ESREGIMENESPECIALAGRICOLA_EMPRESA_FACTURA`    ,
                             `CODIGO_CLIENTE_FACTURA`                       ,
                             `RAZONSOCIAL_CLIENTE_FACTURA`                  ,
                             `NIF_CLIENTE_FACTURA`                          ,
                             `MOVIL_CLIENTE_FACTURA`                        ,
                             `EMAIL_CLIENTE_FACTURA`                        ,
                             `DIRECCION1_CLIENTE_FACTURA`                   ,
                             `DIRECCION2_CLIENTE_FACTURA`                   ,
                             `POBLACION_CLIENTE_FACTURA`                    ,
                             `PROVINCIA_CLIENTE_FACTURA`                    ,
                             `CPOSTAL_CLIENTE_FACTURA`                      ,
                             `NOMBRE_PAIS_CLIENTE_FACTURA`                         ,
														 `CODIGO_PAIS_CLIENTE_FACTURA`                         ,
                             `ESIVA_RECARGO_CLIENTE_FACTURA`                ,
                             `ESIVA_EXENTO_CLIENTE_FACTURA`                 ,
                             `ESREGIMENESPECIALAGRICOLA_CLIENTE_FACTURA`    ,
                             `ESRETENCIONES_CLIENTE_FACTURA`                ,
                             `TARIFA_ARTICULO_CLIENTE_FACTURA`              ,
                             `ESIMP_INCL_TARIFA_CLIENTE_FACTURA`            ,
                             `ESINTRACOMUNITARIO_CLIENTE_FACTURA`           ,
                             `ESIRPF_IMP_INCL_ZONA_IVA_FACTURA`             ,
                             `ESAPLICA_RE_ZONA_IVA_FACTURA`                 ,
                             `ESIVAAGRICOLA_ZONA_IVA_FACTURA`               ,
                             `PALABRA_REPORTS_ZONA_IVA_FACTURA`             ,
                             `CODIGO_IVA_FACTURA`                           ,
                             `ESVENTA_ACTIVO_FIJO_FACTURA`                  ,
                             `PORCEN_IVAN_FACTURA`                          ,
                             `TOTAL_IVAN_FACTURA`                           ,
                             `PORCEN_REN_FACTURA`                           ,
                             `TOTAL_REN_FACTURA`                            ,
                             `TOTAL_BASEI_IVAN_FACTURA`                     ,
                             `PORCEN_IVAR_FACTURA`                          ,
                             `TOTAL_IVAR_FACTURA`                           ,
                             `PORCEN_RER_FACTURA`                           ,
                             `TOTAL_RER_FACTURA`                            ,
                             `TOTAL_BASEI_IVAR_FACTURA`                     ,
                             `PORCEN_IVAS_FACTURA`                          ,
                             `TOTAL_IVAS_FACTURA`                           ,
                             `PORCEN_RES_FACTURA`                           ,
                             `TOTAL_RES_FACTURA`                            ,
                             `TOTAL_BASEI_IVAS_FACTURA`                     ,
                             `PORCEN_IVAE_FACTURA`                          ,
                             `TOTAL_IVAE_FACTURA`                           ,
                             `PORCEN_REE_FACTURA`                           ,
                             `TOTAL_REE_FACTURA`                            ,
                             `TOTAL_BASEI_IVAE_FACTURA`                     ,
                             `TOTAL_BASES_FACTURA`                          ,
                             `TOTAL_IMPUESTOS_FACTURA`                      ,
                             `FORMA_PAGO_FACTURA`                           ,
                             `PORCEN_RETENCION_FACTURA`                     ,
                             `TOTAL_RETENCION_FACTURA`                      ,
                             `TOTAL_LIQUIDO_FACTURA`                        ,
                             `NRO_FACTURA_ABONO_FACTURA`                    ,
                             `SERIE_FACTURA_ABONO_FACTURA`                  ,
                             `TEXTO_LEGAL_FACTURA_CLIENTE_FACTURA`          ,
                             `TEXTO_LEGAL_FACTURA_EMPRESA_FACTURA`          ,
                             `DOCUMENTO_FACTURA`                            ,
                             `COMENTARIOS_FACTURA`                          ,
                             `CONTADOR_LINEAS_FACTURA`                      ,
														 `ESCREARARTICULOS_FACTURA`											,	
                             `ESDESCRIPCIONES_AMP_FACTURA`	                ,
                             `ESFECHADEENTREGA_FACTURA`	                    ,
                             `INSTANTEMODIF`                                ,
                             `INSTANTEALTA`                                 ,
                             `USUARIOALTA`                                  ,
                             `USUARIOMODIF`
                        )
                          SELECT `contadorped`                                ,
                                 `pidseriefacturaabono`                       ,
                                 `pFecha`                                     ,
                                 `CODIGO_EMPRESA_FACTURA`                     ,
                                 `RAZONSOCIAL_EMPRESA_FACTURA`                ,
                                 `NIF_EMPRESA_FACTURA`                        ,
                                 `MOVIL_EMPRESA_FACTURA`                      ,
                                 `EMAIL_EMPRESA_FACTURA`                      ,
                                 `DIRECCION1_EMPRESA_FACTURA`                 ,
                                 `DIRECCION2_EMPRESA_FACTURA`                 ,
                                 `POBLACION_EMPRESA_FACTURA`                  ,
                                 `PROVINCIA_EMPRESA_FACTURA`                  ,
                                 `NOMBRE_PAIS_EMPRESA_FACTURA`                       ,
																 `CODIGO_PAIS_EMPRESA_FACTURA`                       ,
                                 `CPOSTAL_EMPRESA_FACTURA`                    ,
                                 `ESRETENCIONES_EMPRESA_FACTURA`              ,
                                 `GRUPO_ZONA_IVA_EMPRESA_FACTURA`             ,
                                 `ESREGIMENESPECIALAGRICOLA_EMPRESA_FACTURA`  ,
                                 `CODIGO_CLIENTE_FACTURA`                     ,
                                 `RAZONSOCIAL_CLIENTE_FACTURA`                ,
                                 `NIF_CLIENTE_FACTURA`                        ,
                                 `MOVIL_CLIENTE_FACTURA`                      ,
                                 `EMAIL_CLIENTE_FACTURA`                      ,
                                 `DIRECCION1_CLIENTE_FACTURA`                 ,
                                 `DIRECCION2_CLIENTE_FACTURA`                 ,
                                 `POBLACION_CLIENTE_FACTURA`                  ,
                                 `PROVINCIA_CLIENTE_FACTURA`                  ,
                                 `CPOSTAL_CLIENTE_FACTURA`                    ,
                                 `NOMBRE_PAIS_CLIENTE_FACTURA`                       ,
																 `CODIGO_PAIS_CLIENTE_FACTURA`                       ,
                                 `ESIVA_RECARGO_CLIENTE_FACTURA`              ,
                                 `ESIVA_EXENTO_CLIENTE_FACTURA`               ,
                                 `ESREGIMENESPECIALAGRICOLA_CLIENTE_FACTURA`  ,
                                 `ESRETENCIONES_CLIENTE_FACTURA`              ,
                                 `TARIFA_ARTICULO_CLIENTE_FACTURA`            ,
                                 `ESIMP_INCL_TARIFA_CLIENTE_FACTURA`          ,
                                 `ESINTRACOMUNITARIO_CLIENTE_FACTURA`         ,
                                 `ESIRPF_IMP_INCL_ZONA_IVA_FACTURA`           ,
                                 `ESAPLICA_RE_ZONA_IVA_FACTURA`               ,
                                 `ESIVAAGRICOLA_ZONA_IVA_FACTURA`             ,
                                 `PALABRA_REPORTS_ZONA_IVA_FACTURA`           ,
                                 `CODIGO_IVA_FACTURA`                         ,
                                 `ESVENTA_ACTIVO_FIJO_FACTURA`                ,
                                 `PORCEN_IVAN_FACTURA`                        ,
                                 `TOTAL_IVAN_FACTURA`                         ,
                                 `PORCEN_REN_FACTURA`                         ,
                                 `TOTAL_REN_FACTURA`                          ,
                                 `TOTAL_BASEI_IVAN_FACTURA`                   ,
                                 `PORCEN_IVAR_FACTURA`                        ,
                                 `TOTAL_IVAR_FACTURA`                         ,
                                 `PORCEN_RER_FACTURA`                         ,
                                 `TOTAL_RER_FACTURA`                          ,
                                 `TOTAL_BASEI_IVAR_FACTURA`                   ,
                                 `PORCEN_IVAS_FACTURA`                        ,
                                 `TOTAL_IVAS_FACTURA`                         ,
                                 `PORCEN_RES_FACTURA`                         ,
                                 `TOTAL_RES_FACTURA`                          ,
                                 `TOTAL_BASEI_IVAS_FACTURA`                   ,
                                 `PORCEN_IVAE_FACTURA`                        ,
                                 `TOTAL_IVAE_FACTURA`                         ,
                                 `PORCEN_REE_FACTURA`                         ,
                                 `TOTAL_REE_FACTURA`                          ,
                                 `TOTAL_BASEI_IVAE_FACTURA`                   ,
                                 `TOTAL_BASES_FACTURA`                        ,
                                 `TOTAL_IMPUESTOS_FACTURA`                    ,
                                 `FORMA_PAGO_FACTURA`                         ,
                                 `PORCEN_RETENCION_FACTURA`                   ,
                                 `TOTAL_RETENCION_FACTURA`                    ,
                                 `TOTAL_LIQUIDO_FACTURA`                      ,
                                 `NRO_FACTURA_ABONO_FACTURA`                  ,
                                 `SERIE_FACTURA_ABONO_FACTURA`                ,
                                 `TEXTO_LEGAL_FACTURA_CLIENTE_FACTURA`        ,
                                 `TEXTO_LEGAL_FACTURA_EMPRESA_FACTURA`        ,
                                 `DOCUMENTO_FACTURA`                          ,
                                 `COMENTARIOS_FACTURA`                        ,
                                 `CONTADOR_LINEAS_FACTURA`                    ,
																 `ESCREARARTICULOS_FACTURA`										,	
                                 `ESDESCRIPCIONES_AMP_FACTURA`	              ,
                                 `ESFECHADEENTREGA_FACTURA`	                  ,
                                 CURRENT_TIMESTAMP                             ,
                                 CURRENT_TIMESTAMP                            ,
                                 `pUSUARIO`                                   ,
                                 `pUSUARIO`
                            FROM `fza_facturas` 
                           WHERE `NRO_FACTURA`   = `pidnumfactura` 
                             AND `SERIE_FACTURA` = `pidseriefactura`;  
  INSERT INTO fza_facturas_lineas (`NRO_FACTURA_LINEA`                        ,
                                   `SERIE_FACTURA_LINEA`                      ,
                                   `LINEA_FACTURA_LINEA`                      ,
                                   `CODIGO_ARTICULO_FACTURA_LINEA`            ,
                                   `TIPO_CANTIDAD_ARTICULO_FACTURA_LINEA`     ,
                                   `ESIMP_INCL_TARIFA_FACTURA_LINEA`          ,
                                   `TIPOIVA_ARTICULO_FACTURA_LINEA`           ,
                                   `DESCRIPCION_ARTICULO_FACTURA_LINEA`       ,
                                   `CANTIDAD_FACTURA_LINEA`                   ,
                                   `PRECIOVENTA_SIVA_ARTICULO_FACTURA_LINEA`  ,
                                   `PORCEN_IVA_FACTURA_LINEA`                 ,
                                   `PRECIOVENTA_CIVA_ARTICULO_FACTURA_LINEA`  ,
                                   `TOTAL_FACTURA_LINEA`                      ,
                                   `INSTANTEMODIF`                            ,
                                   `INSTANTEALTA`                             ,
                                   `USUARIOALTA`                              ,
                                   `USUARIOMODIF`
                                  )
                           SELECT `contadorped`                               ,
                                  `pidseriefacturaabono`                      ,
                                  `LINEA_FACTURA_LINEA`                       ,
                                  `CODIGO_ARTICULO_FACTURA_LINEA`             ,
                                  `TIPO_CANTIDAD_ARTICULO_FACTURA_LINEA`      ,
                                  `ESIMP_INCL_TARIFA_FACTURA_LINEA`           ,
                                  `TIPOIVA_ARTICULO_FACTURA_LINEA`            ,
                                  `DESCRIPCION_ARTICULO_FACTURA_LINEA`        ,
                                  `CANTIDAD_FACTURA_LINEA`                    ,
                                  `PRECIOVENTA_SIVA_ARTICULO_FACTURA_LINEA`   ,
                                  `PORCEN_IVA_FACTURA_LINEA`                  ,
                                  `PRECIOVENTA_CIVA_ARTICULO_FACTURA_LINEA`   ,
                                  `TOTAL_FACTURA_LINEA`                       ,
                                  CURRENT_TIMESTAMP                           ,
                                  CURRENT_TIMESTAMP                           ,
                                  `pUSUARIO`                                  ,
                                  `pUSUARIO`
                             FROM `fza_facturas_lineas`
                            WHERE `SERIE_FACTURA_LINEA`      = `pidseriefactura`
                              AND `NRO_FACTURA_LINEA`        = `pidnumfactura` ;
    COMMIT;
END $$
DELIMITER ;

-- Recreando procedimiento: PRC_CREAR_METADATOS
DROP PROCEDURE IF EXISTS `PRC_CREAR_METADATOS`;

DELIMITER $$
CREATE  PROCEDURE `PRC_CREAR_METADATOS`(IN `pDATABASENAME` varchar(100))
BEGIN
START TRANSACTION;
  DROP TABLE IF EXISTS `fza_metadatos`;
  CREATE TABLE `fza_metadatos`  (
    `CODIGO_METADATO` int(20) NOT NULL AUTO_INCREMENT,
    `NOMBRE_METADATO` varchar(100) CHARACTER SET utf8mb4 
                               COLLATE utf8mb4_spanish_ci NOT NULL,
    `PARENT_METADATO` varchar(20) CHARACTER SET utf8mb4 
                               COLLATE utf8mb4_spanish_ci NOT NULL,
    PRIMARY KEY (`CODIGO_METADATO`) USING BTREE
  ) ENGINE = InnoDB AUTO_INCREMENT = 4 CHARACTER SET = utf8mb4 
             COLLATE = utf8mb4_spanish_ci ROW_FORMAT = Dynamic;
  INSERT INTO `fza_metadatos` (`PARENT_METADATO`, `NOMBRE_METADATO`)
  SELECT '1' AS `PARENT_METADATO`,
         `table_name` as `NOMBRE_METADATO`
    FROM `information_schema`.`TABLES` 
   WHERE `table_schema` = `pDATABASENAME`  
     AND `table_type` = 'BASE TABLE';
  INSERT INTO `fza_metadatos` (`PARENT_METADATO`, `NOMBRE_METADATO`)    
  SELECT '2' AS `PARENT_METADATO`,
         `table_name` as `NOMBRE_METADATO`
    FROM `information_schema`.`TABLES` 
   WHERE `table_schema` = `pDATABASENAME`
     AND `table_type` = 'VIEW';
   INSERT INTO `fza_metadatos` (`PARENT_METADATO`, `NOMBRE_METADATO`) 
   SELECT '3' AS `PARENT_METADATO`,
          `SPECIFIC_NAME` AS `NOMBRE_METADATO`
     FROM `information_schema`.`ROUTINES` 
    WHERE `ROUTINE_SCHEMA` = pDATABASENAME  
      AND `ROUTINE_TYPE` = 'PROCEDURE';     
   
   INSERT INTO `fza_metadatos` (`CODIGO_METADATO`, 
                                `PARENT_METADATO`, 
                                `NOMBRE_METADATO`) 
                        VALUES (1, '-1','Tablas');  
   INSERT INTO `fza_metadatos` (`CODIGO_METADATO`, 
                                `PARENT_METADATO`, 
                                `NOMBRE_METADATO`) 
                        VALUES (2, '-1','Vistas');
   INSERT INTO `fza_metadatos` (`CODIGO_METADATO`, 
                                `PARENT_METADATO`, 
                                `NOMBRE_METADATO`) 
                        VALUES (3, '-1','Procedimientos');
COMMIT;
END $$
DELIMITER ;

-- Recreando procedimiento: PRC_CREAR_RECIBOS_FACTURA
DROP PROCEDURE IF EXISTS `PRC_CREAR_RECIBOS_FACTURA`;

DELIMITER $$
CREATE  PROCEDURE `PRC_CREAR_RECIBOS_FACTURA`(IN `pSERIE_FACTURA` varchar(12),
	                                        IN `pNRO_FACTURA` varchar(12),
																					IN `pUSUARIO`             varchar(100))
BEGIN
  DECLARE pCODIGO_FORMAPAGO VARCHAR(10);
	DECLARE pFORMA_PAGO_FACTURA VARCHAR(100);
	DECLARE pN_PLAZOS int(10); 
	DECLARE I int(10);
	DECLARE pDIAS_ENTRE_PLAZOS int(10);
	DECLARE pPORCEN_ANTICIPO decimal(5,2);
	DECLARE pCODIGO_CLIENTE  varchar(20);
	DECLARE pIBAN varchar(34);
	DECLARE pRAZONSOCIAL_CLIENTE varchar(200);
	DECLARE pDIRECCION1_CLIENTE  varchar(200);
	DECLARE pPOBLACION_CLIENTE  varchar(200);
	DECLARE pPOBLACION_EMPRESA varchar(200);
	DECLARE pPROVINCIA_CLIENTE  varchar(200);
	DECLARE pCPOSTAL_CLIENTE  varchar(15);
	DECLARE pIMPORTE_LETRA  varchar(150);
	DECLARE pTOTAL_LIQUIDO_FACTURA decimal(18,6);
	DECLARE pIMPORTE_RECIBO decimal(18,6);
	DECLARE pIMPORTE_RESTO decimal(18,6);
	DECLARE pIMPORTE_ANTICIPO decimal(18,6);
	DECLARE pFECHA_VENCIMIENTO date;
	DECLARE pFECHA_FACTURA date;
	DECLARE finished INTEGER DEFAULT 0;
	/* DECLARE pTRATAMIENTO_LINEA VARCHAR(100); */
  /* DECLARE pTRATAMIENTOS varchar(1000) DEFAULT ""; */
  /* DECLARE curTratamientos 
        CURSOR FOR 
            SELECT DESCRIPCION_ARTICULO_LINEA 
						  FROM suboc_facturas_lineas 
						 WHERE SERIE_FACTURA_LINEA = pSERIE_FACTURA 
						   AND NRO_FACTURA_LINEA = pNRO_FACTURA;
  DECLARE CONTINUE HANDLER 
        FOR NOT FOUND SET finished = 1; */
	START TRANSACTION;
	DELETE FROM fza_recibos 
   WHERE NRO_FACTURA_RECIBO = pNRO_FACTURA
	   AND SERIE_FACTURA_RECIBO = pSERIE_FACTURA;	
  /* OPEN curTratamientos;
  getTratamientos: LOOP
		FETCH curTratamientos INTO pTRATAMIENTO_LINEA;
		IF finished = 1 THEN 
				LEAVE getTratamientos;
		END IF;
		-- build email list
		SET pTRATAMIENTOS = CONCAT(pTRATAMIENTOS,'\n',pTRATAMIENTO_LINEA);
  END LOOP getTratamientos;
	*/
	SELECT FORMA_PAGO_FACTURA, 
				 CODIGO_CLIENTE_FACTURA,
				 TOTAL_LIQUIDO_FACTURA,
				 RAZONSOCIAL_CLIENTE_FACTURA,
				 DIRECCION1_CLIENTE_FACTURA,
				 POBLACION_CLIENTE_FACTURA,
				 PROVINCIA_CLIENTE_FACTURA,
				 CPOSTAL_CLIENTE_FACTURA,
				 FECHA_FACTURA,
				 POBLACION_EMPRESA_FACTURA
		INTO pFORMA_PAGO_FACTURA,
				 pCODIGO_CLIENTE,
				 pTOTAL_LIQUIDO_FACTURA,
				 pRAZONSOCIAL_CLIENTE,
				 pDIRECCION1_CLIENTE,
				 pPOBLACION_CLIENTE,
				 pPROVINCIA_CLIENTE,
				 pCPOSTAL_CLIENTE,
				 pFECHA_FACTURA,
				 pPOBLACION_EMPRESA
		FROM fza_facturas
   WHERE SERIE_FACTURA = pSERIE_FACTURA
	   AND NRO_FACTURA = pNRO_FACTURA;
     /*select pFORMA_PAGO_FACTURA;*/		 
		 SELECT IBAN_CLIENTE 
		  INTO pIBAN
		 FROM fza_clientes
		 WHERE CODIGO_CLIENTE = pCODIGO_CLIENTE;
		 /* select pforma_pago_factura; */
		 IF( EXISTS(
							 SELECT *
							 FROM fza_formapago
							 WHERE CODIGO_FORMAPAGO =  pFORMA_PAGO_FACTURA) ) THEN
		BEGIN
			SELECT CODIGO_FORMAPAGO, 
			       N_PLAZOS_FORMAPAGO, 
						 N_DIAS_ENTRE_PLAZOS_FORMAPAGO, 
						 PORCEN_ANTICIPO_FORMAPAGO 
				INTO pCODIGO_FORMAPAGO,
				     pN_PLAZOS, 
						 pDIAS_ENTRE_PLAZOS,  
						 pPORCEN_ANTICIPO
				FROM fza_formapago
				WHERE CODIGO_FORMAPAGO = pFORMA_PAGO_FACTURA;
				
			IF ((pPORCEN_ANTICIPO = 100)) THEN
			BEGIN
				CALL PRC_GET_NUMEROS_A_LETRAS(pTOTAL_LIQUIDO_FACTURA, pIMPORTE_LETRA);
				INSERT INTO  fza_recibos 
				       (NRO_FACTURA_RECIBO					        ,
								SERIE_FACTURA_RECIBO                ,
								NRO_PLAZO_RECIBO                    ,
								FORMA_PAGO_ORIGEN_RECIBO            ,
								FORMA_PAGO_DESCRIPCION_ORIGEN_RECIBO,								
								EUROS_RECIBO                        ,
								STADO_RECIBO                       ,
								FECHA_EXPEDICION_RECIBO             ,
								FECHA_VENCIMIENTO_RECIBO            ,
								IBAN_CLIENTE_RECIBO                 ,
								FECHA_PAGO_RECIBO                   ,
								LOCALIDAD_EXPEDICION_RECIBO         ,
								CODIGO_CLIENTE_RECIBO               ,
								RAZONSOCIAL_CLIENTE_RECIBO          ,
								DIRECCION1_CLIENTE_RECIBO           ,
								POBLACION_CLIENTE_RECIBO            ,
								PROVINCIA_CLIENTE_RECIBO            ,
								CPOSTAL_CLIENTE_RECIBO              ,
								IMPORTE_LETRA_RECIBO                ,
								INSTANTEALTA,
								INSTANTEMODIF,
								USUARIOALTA,
								USUARIOMODIF	)
				VALUES( pNRO_FACTURA                        ,
				        pSERIE_FACTURA                      ,
								1                                   ,
								pCODIGO_FORMAPAGO                   ,
								pFORMA_PAGO_FACTURA                 ,
								pTOTAL_LIQUIDO_FACTURA              ,
								'Pagado'                            ,
								pFECHA_FACTURA                      ,
								pFECHA_FACTURA                      ,
								pIBAN                               ,
								pFECHA_FACTURA                      ,
								pPOBLACION_EMPRESA                  ,
								pCODIGO_CLIENTE                     ,
								pRAZONSOCIAL_CLIENTE                ,
								pDIRECCION1_CLIENTE                 ,
								pPOBLACION_CLIENTE                  ,
								pPROVINCIA_CLIENTE                  ,
								pCPOSTAL_CLIENTE                    ,
								pIMPORTE_LETRA                      ,
								CURRENT_TIMESTAMP                   ,
								CURRENT_TIMESTAMP                   ,
								pUSUARIO                            ,
								pUSUARIO
							);
			END;
			ELSE 
			  IF (pN_PLAZOS >= 1) THEN
				BEGIN
			    SET I = 1;
					WHILE (I<=pN_PLAZOS) DO
					BEGIN
					      IF ((I = 1)) THEN 
								BEGIN
								  SET pFECHA_VENCIMIENTO  =  ADDDATE(pFECHA_FACTURA, INTERVAL pDIAS_ENTRE_PLAZOS DAY);
								  SET pIMPORTE_ANTICIPO = pTOTAL_LIQUIDO_FACTURA * (pPORCEN_ANTICIPO/100);
								  SET pIMPORTE_RESTO = (pTOTAL_LIQUIDO_FACTURA - pIMPORTE_ANTICIPO);
									/* SELECT pTOTAL_LIQUIDO_FACTURA, pIMPORTE_RESTO, pIMPORTE_ANTICIPO; */
								END;	
								END IF;									
								IF ((I= 1) AND (pPORCEN_ANTICIPO > 0)) THEN
									SET pIMPORTE_RECIBO = pIMPORTE_ANTICIPO;
								ELSE
								  IF pN_PLAZOS > 1 THEN 
									  /* SELECT pN_PLAZOS, pIMPORTE_RESTO, I AS iteracion; */
									  SET pIMPORTE_RECIBO = pIMPORTE_RESTO / (pN_PLAZOS);
									ELSE
										SET pIMPORTE_RECIBO = pIMPORTE_RESTO;
									END IF;
								END IF;
							  CALL PRC_GET_NUMEROS_A_LETRAS(pIMPORTE_RECIBO, pIMPORTE_LETRA);	
								IF (I <> 1) THEN
								  SET pFECHA_VENCIMIENTO = ADDDATE(pFECHA_VENCIMIENTO, INTERVAL pDIAS_ENTRE_PLAZOS DAY);
								END IF;
								INSERT INTO  fza_recibos 
												 (NRO_FACTURA_RECIBO					        ,
													SERIE_FACTURA_RECIBO                ,
													NRO_PLAZO_RECIBO                    ,
													FORMA_PAGO_ORIGEN_RECIBO            ,													
													FORMA_PAGO_DESCRIPCION_ORIGEN_RECIBO,
													EUROS_RECIBO                        ,
													STADO_RECIBO                       ,
													FECHA_EXPEDICION_RECIBO             ,
													FECHA_VENCIMIENTO_RECIBO            ,
													IBAN_CLIENTE_RECIBO                 ,
													FECHA_PAGO_RECIBO                   ,
													LOCALIDAD_EXPEDICION_RECIBO         ,
													CODIGO_CLIENTE_RECIBO               ,
													RAZONSOCIAL_CLIENTE_RECIBO          ,
													DIRECCION1_CLIENTE_RECIBO           ,
													POBLACION_CLIENTE_RECIBO            ,
													PROVINCIA_CLIENTE_RECIBO            ,
													CPOSTAL_CLIENTE_RECIBO              ,
													IMPORTE_LETRA_RECIBO                ,	
													INSTANTEALTA                        ,
													INSTANTEMODIF                       ,
          								USUARIOALTA                         ,
					          			USUARIOMODIF	)
								VALUES(   pNRO_FACTURA,
													pSERIE_FACTURA,
													I,
													pCODIGO_FORMAPAGO,										
													pFORMA_PAGO_FACTURA,
													pIMPORTE_RECIBO,
													'Emitido',
													pFECHA_FACTURA,
													pFECHA_VENCIMIENTO,
													pIBAN,
													NULL,
													pPOBLACION_EMPRESA,
													pCODIGO_CLIENTE,
													pRAZONSOCIAL_CLIENTE,
													pDIRECCION1_CLIENTE,
													pPOBLACION_CLIENTE,
													pPROVINCIA_CLIENTE,
													pCPOSTAL_CLIENTE,
													pIMPORTE_LETRA,
													CURRENT_TIMESTAMP,
													CURRENT_TIMESTAMP,
													pUSUARIO,
													PUSUARIO
												);
								SET I = I + 1;
					END;
					END WHILE;
				END;
				END IF;
			END IF;
		END;
		END IF;
		COMMIT;
END $$
DELIMITER ;

-- Recreando procedimiento: PRC_CREAR_TRASPASO
DROP PROCEDURE IF EXISTS `PRC_CREAR_TRASPASO`;

DELIMITER $$
CREATE  PROCEDURE `PRC_CREAR_TRASPASO`(IN pUsuario VARCHAR(50),
    IN pEmpresa VARCHAR(20),
    IN pAlmacenOrigen VARCHAR(10),
    IN pAlmacenDestino VARCHAR(10),
    IN pSku VARCHAR(50),
    IN pCantidad DECIMAL(19,6))
BEGIN
    DECLARE vSerie VARCHAR(20) DEFAULT 'TRAS';
    DECLARE vNroDoc VARCHAR(20);
    
    -- Generamos un número de documento único basado en la fecha y hora (simplificado)
    SET vNroDoc = DATE_FORMAT(NOW(), '%Y%m%d%H%i%s');

    START TRANSACTION;

    -- 1. SALIDA DEL ORIGEN (Resta stock en Origen)
    INSERT INTO `fza_movimientos_almacen` 
    (TIPO_DOC_MOV, SERIE_DOC_MOV, NRO_DOC_MOV, LINEA_MOV, CODIGO_EMPRESA_MOV, 
     CODIGO_ALMACEN_MOV, CODIGO_ALMACEN_CONTRA_MOV, FECHA_MOV, 
     CODIGO_UNIDAD_MOV, TIPO_MOVIMIENTO_MOV, CANTIDAD_MOV, 
     DESCRIPCION_ARTICULO_MOV, USUARIOALTA, USUARIOMODIF)
    VALUES 
    ('TR', vSerie, vNroDoc, '001', pEmpresa, 
     pAlmacenOrigen, pAlmacenDestino, NOW(), 
     pSku, 'S', pCantidad, 
     CONCAT('Traspaso a ', pAlmacenDestino), pUsuario, pUsuario);

    -- 2. ENTRADA EN DESTINO (Suma stock en Destino)
    -- Referenciamos al movimiento anterior para trazabilidad
    INSERT INTO `fza_movimientos_almacen` 
    (TIPO_DOC_MOV, SERIE_DOC_MOV, NRO_DOC_MOV, LINEA_MOV, CODIGO_EMPRESA_MOV, 
     CODIGO_ALMACEN_MOV, CODIGO_ALMACEN_CONTRA_MOV, FECHA_MOV, 
     CODIGO_UNIDAD_MOV, TIPO_MOVIMIENTO_MOV, CANTIDAD_MOV, 
     DESCRIPCION_ARTICULO_MOV, USUARIOALTA, USUARIOMODIF,
     TIPO_DOC_REF_MOV, SERIE_DOC_REF_MOV, NRO_DOC_REF_MOV, LINEA_REF_MOV)
    VALUES 
    ('TR', vSerie, vNroDoc, '002', pEmpresa, 
     pAlmacenDestino, pAlmacenOrigen, NOW(), 
     pSku, 'E', pCantidad, 
     CONCAT('Traspaso desde ', pAlmacenOrigen), pUsuario, pUsuario,
     'TR', vSerie, vNroDoc, '001');

    COMMIT;
    
    SELECT CONCAT('Traspaso realizado. Doc: ', vSerie, '-', vNroDoc) as MENSAJE;
END $$
DELIMITER ;

-- Recreando procedimiento: PRC_FNC_GET_NEXT_LINEA_FACTURA
DROP PROCEDURE IF EXISTS `PRC_FNC_GET_NEXT_LINEA_FACTURA`;

DELIMITER $$
CREATE  PROCEDURE `PRC_FNC_GET_NEXT_LINEA_FACTURA`(IN  `pnumfac` VARCHAR(12), 
                                                   IN  `pserie`  VARCHAR(12), 
                                                   OUT `presul`  VARCHAR(3))
BEGIN
  DECLARE `pnextnum` varchar(3);
  START TRANSACTION;
  SET `pnextnum` = ( SELECT lpad(((`CONTADOR_LINEAS_FACTURA`)),3,'0' )
                       FROM `fza_facturas`
                      WHERE `NRO_FACTURA`   = `pnumfac`
                        AND `SERIE_FACTURA` = `pserie`);
  IF (`pnextnum` IS NULL) THEN
    SET `presul` = '010';
  ELSE
    SET `presul` = `pnextnum`;
  END IF;
    UPDATE `fza_facturas`
       SET `CONTADOR_LINEAS_FACTURA` = LPAD(((`presul`)+10),3,'0' )
     WHERE `SERIE_FACTURA` = `pserie`
       AND `NRO_FACTURA` = `pnumfac`;
  COMMIT;
END $$
DELIMITER ;

-- Recreando procedimiento: PRC_FNC_GET_NEXT_NRO_DOC
DROP PROCEDURE IF EXISTS `PRC_FNC_GET_NEXT_NRO_DOC`;

DELIMITER $$
CREATE  PROCEDURE `PRC_FNC_GET_NEXT_NRO_DOC`(IN  `ptipodoc` VARCHAR(8), 
                                             INOUT `ppresul`   BIGINT)
BEGIN
START TRANSACTION;
UPDATE `fza_contadores`
   SET `CONTADOR_CONTADOR` = CONTADOR_CONTADOR + 1
 WHERE `SERIE_CONTADOR` = '-'
   AND `TIPODOC_CONTADOR` = `pTipoDoc`;
  SET `ppresul` = (SELECT `CONTADOR_CONTADOR` - 1
                     FROM `fza_contadores`
                    WHERE `SERIE_CONTADOR` = '-'
                      AND `DEFAULT_CONTADOR` = 'S'
                      AND `TIPODOC_CONTADOR` = `pTipoDoc` 
                    LIMIT 1);
COMMIT;

END $$
DELIMITER ;

-- Recreando procedimiento: PRC_FNC_GET_PRECIO_ARTICULO_FECHA
DROP PROCEDURE IF EXISTS `PRC_FNC_GET_PRECIO_ARTICULO_FECHA`;

DELIMITER $$
CREATE  PROCEDURE `PRC_FNC_GET_PRECIO_ARTICULO_FECHA`(IN  `pCODIGO_ARTICULO`              VARCHAR(20), 
																																								IN `pFECHA`                         DATE, 
                                                                                INOUT `pPRECIOSALIDA_TARIFA`        decimal(19,6),
																																								INOUT `pPRECIOFINAL_TARIFA`         decimal(19,6),
																																								INOUT `pPORCEN_DTO_TARIFA`         decimal(19,6),
																																								INOUT `pPRECIO_DTO_TARIFA`         decimal(19,6))
BEGIN
SELECT  PRECIOSALIDA_TARIFA,
			  PRECIOFINAL_TARIFA,
				PORCEN_DTO_TARIFA,
				PRECIO_DTO_TARIFA
	INTO 
				pPRECIOSALIDA_TARIFA,
				pPRECIOFINAL_TARIFA,
				pPORCEN_DTO_TARIFA,
				pPRECIO_DTO_TARIFA
	 FROM fza_articulos_tarifas
	 WHERE CODIGO_ARTICULO_TARIFA = pCODIGO_ARTICULO
	   AND FECHA_DESDE_TARIFA <= pFECHA 
	   AND (FECHA_HASTA_TARIFA IS NULL OR
					FECHA_HASTA_TARIFA >= pFECHA);
END $$
DELIMITER ;

-- Recreando procedimiento: PRC_FNC_GET_SERIE_TIPODOC
DROP PROCEDURE IF EXISTS `PRC_FNC_GET_SERIE_TIPODOC`;

DELIMITER $$
CREATE  PROCEDURE `PRC_FNC_GET_SERIE_TIPODOC`(IN `ptipodoc` VARCHAR(8), 
                                                OUT `presul` VARCHAR(3))
BEGIN


DECLARE pserie varchar(3);
SET pserie = (select SERIE_CONTADOR
FROM fza_contadores
  where DEFAULT_CONTADOR = 'S'
and TIPODOC_CONTADOR = ptipodoc);
IF (pserie IS NULL) THEN
   SET presul = '-';
ELSE
   SET presul = pserie;
END IF;
END $$
DELIMITER ;

-- Recreando procedimiento: PRC_GET_CAJA_STOCK_PIVOTADO
DROP PROCEDURE IF EXISTS `PRC_GET_CAJA_STOCK_PIVOTADO`;

DELIMITER $$
CREATE  PROCEDURE `PRC_GET_CAJA_STOCK_PIVOTADO`(IN p_input VARCHAR(50))
BEGIN
    DECLARE v_codigo_articulo VARCHAR(20);
    DECLARE v_es_sku BOOLEAN DEFAULT FALSE;
    DECLARE v_id_atributo_pivot VARCHAR(20);
    DECLARE v_nombre_atributo_pivot VARCHAR(50);
    DECLARE v_columnas_dinamicas TEXT;
    DECLARE v_filtros_fijos TEXT DEFAULT '';
    DECLARE v_sql_query TEXT;

    -- 1. RESOLUCIÓN DE IDENTIDAD (¿Es Artículo padre o es un SKU?)
    -- Buscamos primero si es un código padre directo
    SELECT CODIGO_ARTICULO INTO v_codigo_articulo 
    FROM fza_articulos WHERE CODIGO_ARTICULO = p_input;

    IF v_codigo_articulo IS NULL THEN
        -- Si no es padre, miramos si es un SKU hijo
        SELECT CODIGO_ARTICULO_SKU INTO v_codigo_articulo 
        FROM fza_articulos_skus WHERE CODIGO_UNIDAD_SKU = p_input;
        
        IF v_codigo_articulo IS NOT NULL THEN
            SET v_es_sku = TRUE;
        END IF;
    END IF;

    -- 2. BUSCAR ATRIBUTO PARA PIVOTAR (Talla, Color, etc.)
    -- Solo intentamos buscar atributos si encontramos un padre válido
    IF v_codigo_articulo IS NOT NULL THEN
        SELECT va.ID_ATRIBUTO_VA, va.NOMBRE_VA
        INTO v_id_atributo_pivot, v_nombre_atributo_pivot
        FROM fza_articulos_skus sk
        JOIN fza_atributos_sku ask ON sk.CODIGO_UNIDAD_SKU = ask.CODIGO_UNIDAD_SA
        JOIN fza_atributos_valores av ON ask.ID_VALOR_SA = av.ID_VALOR_AV
        JOIN fza_variaciones_atributos va ON av.ID_VA_AV = va.ID_ATRIBUTO_VA
        WHERE sk.CODIGO_ARTICULO_SKU = v_codigo_articulo
        ORDER BY va.ORDEN_VA DESC
        LIMIT 1;
    END IF;

    -- 3. DECISIÓN DE EJECUCIÓN

    -- CASO A: TIENE ATRIBUTOS -> HACEMOS PIVOT (Lógica compleja)
    IF v_id_atributo_pivot IS NOT NULL THEN
    
        -- 3.1 Generar columnas dinámicas (S, M, L...)
        SELECT GROUP_CONCAT(DISTINCT
            CONCAT(
                'SUM(CASE WHEN av.VALOR_AV = ''', av.VALOR_AV, 
                ''' THEN stk.CANTIDAD_STK ELSE 0 END) AS `', av.VALOR_AV, '`'
            )
            ORDER BY av.ID_VALOR_AV
        ) INTO v_columnas_dinamicas
        FROM fza_articulos_skus sk
        JOIN fza_atributos_sku ask ON sk.CODIGO_UNIDAD_SKU = ask.CODIGO_UNIDAD_SA
        JOIN fza_atributos_valores av ON ask.ID_VALOR_SA = av.ID_VALOR_AV
        WHERE sk.CODIGO_ARTICULO_SKU = v_codigo_articulo
          AND av.ID_VA_AV = v_id_atributo_pivot;

        -- 3.2 Filtros si el usuario escaneó un SKU específico (ej. ZAPATO-ROJO)
        IF v_es_sku = TRUE THEN
            SELECT GROUP_CONCAT(
                CONCAT(
                    ' AND EXISTS (SELECT 1 FROM fza_atributos_sku f_ask ',
                    ' JOIN fza_atributos_valores f_av ON f_ask.ID_VALOR_SA = f_av.ID_VALOR_AV ',
                    ' WHERE f_ask.CODIGO_UNIDAD_SA = sk.CODIGO_UNIDAD_SKU ',
                    ' AND f_av.ID_VA_AV = ''', av.ID_VA_AV, ''' ',
                    ' AND f_av.VALOR_AV = ''', av.VALOR_AV, ''') '
                ) SEPARATOR ' '
            ) INTO v_filtros_fijos
            FROM fza_atributos_sku ask
            JOIN fza_atributos_valores av ON ask.ID_VALOR_SA = av.ID_VALOR_AV
            WHERE ask.CODIGO_UNIDAD_SA = p_input 
              AND av.ID_VA_AV <> v_id_atributo_pivot;
        END IF;

        IF v_filtros_fijos IS NULL THEN SET v_filtros_fijos = ''; END IF;

        -- 3.3 Query Pivotada
        SET @sql = CONCAT(
            'SELECT sk.CODIGO_UNIDAD_SKU AS Código,
                alm.NOMBRE_ALMACEN_ALM AS Almacén, ', 
                v_columnas_dinamicas, ',
                SUM(stk.CANTIDAD_STK) AS Total
             FROM fza_articulos_stockactual stk
             JOIN fza_almacenes alm ON stk.CODIGO_ALMACEN_STK = alm.CODIGO_ALMACEN_ALM
             JOIN fza_articulos_skus sk ON stk.CODIGO_UNIDAD_STK = sk.CODIGO_UNIDAD_SKU
             JOIN fza_atributos_sku ask ON sk.CODIGO_UNIDAD_SKU = ask.CODIGO_UNIDAD_SA
             JOIN fza_atributos_valores av ON ask.ID_VALOR_SA = av.ID_VALOR_AV
             WHERE sk.CODIGO_ARTICULO_SKU = ''', v_codigo_articulo, '''
               AND av.ID_VA_AV = ''', v_id_atributo_pivot, ''' ',
               v_filtros_fijos, '
             GROUP BY alm.NOMBRE_ALMACEN_ALM
             ORDER BY alm.NOMBRE_ALMACEN_ALM'
        );

        PREPARE stmt FROM @sql;
        EXECUTE stmt;
        DEALLOCATE PREPARE stmt;

    ELSE
        -- CASO B: NO TIENE ATRIBUTOS O NO ES SKU (Artículo Simple)
        -- Aquí quitamos el JOIN con fza_articulos_skus para permitir stock directo
        
        SELECT stk.CODIGO_UNIDAD_STK as Código,  
            alm.NOMBRE_ALMACEN_ALM as Almacén, 
            SUM(stk.CANTIDAD_STK) as `Stock Total`
        FROM fza_articulos_stockactual stk
        JOIN fza_almacenes alm ON stk.CODIGO_ALMACEN_STK = alm.CODIGO_ALMACEN_ALM
        WHERE stk.CODIGO_UNIDAD_STK = p_input -- Buscamos exactamente lo que escribió el usuario
        GROUP BY alm.NOMBRE_ALMACEN_ALM
        ORDER BY alm.NOMBRE_ALMACEN_ALM;
        
    END IF;

END $$
DELIMITER ;

-- Recreando procedimiento: PRC_GET_CAJA_STOCK_PIVOTADO_PRUEBA
DROP PROCEDURE IF EXISTS `PRC_GET_CAJA_STOCK_PIVOTADO_PRUEBA`;

DELIMITER $$
CREATE  PROCEDURE `PRC_GET_CAJA_STOCK_PIVOTADO_PRUEBA`(IN p_input VARCHAR(50))
BEGIN
    DECLARE v_codigo_articulo VARCHAR(20);
    DECLARE v_es_sku BOOLEAN DEFAULT FALSE;
    
    -- Variables para identificar qué es Talla (Pivot) y qué es Color (Grupo)
    DECLARE v_id_atributo_pivot VARCHAR(20); -- Ej: TAL
    DECLARE v_id_atributo_grupo VARCHAR(20); -- Ej: CO
    
    -- Variable para filtrar si entramos con un SKU específico (Ej: NEGRO)
    DECLARE v_valor_grupo_filtro VARCHAR(50) DEFAULT NULL;

    DECLARE v_columnas_dinamicas TEXT;
    DECLARE v_sql_query TEXT;

    -- 1. RESOLUCIÓN DE IDENTIDAD (¿Es Padre o SKU?)
    SELECT CODIGO_ARTICULO INTO v_codigo_articulo 
    FROM fza_articulos WHERE CODIGO_ARTICULO = p_input;

    IF v_codigo_articulo IS NULL THEN
        SELECT CODIGO_ARTICULO_SKU INTO v_codigo_articulo 
        FROM fza_articulos_skus WHERE CODIGO_UNIDAD_SKU = p_input;
        
        IF v_codigo_articulo IS NOT NULL THEN
            SET v_es_sku = TRUE;
        END IF;
    END IF;

    -- 2. ESTRATEGIA DE ATRIBUTOS
    -- Buscamos los 2 atributos más importantes. 
    -- Asumimos: Mayor Orden Visual = Pivot (Columnas/Talla), Segundo Orden = Grupo (Filas/Color)
    IF v_codigo_articulo IS NOT NULL THEN
        -- A. Identificar atributo para COLUMNAS (El de mayor orden, ej. Talla)
        SELECT va.ID_ATRIBUTO_VA INTO v_id_atributo_pivot
        FROM fza_articulos_skus sk
        JOIN fza_atributos_sku ask ON sk.CODIGO_UNIDAD_SKU = ask.CODIGO_UNIDAD_SA
        JOIN fza_atributos_valores av ON ask.ID_VALOR_SA = av.ID_VALOR_AV
        JOIN fza_variaciones_atributos va ON av.ID_VA_AV = va.ID_ATRIBUTO_VA
        WHERE sk.CODIGO_ARTICULO_SKU = v_codigo_articulo
        ORDER BY va.ORDEN_VA DESC
        LIMIT 1;

        -- B. Identificar atributo para FILAS (El siguiente, ej. Color)
        SELECT va.ID_ATRIBUTO_VA INTO v_id_atributo_grupo
        FROM fza_articulos_skus sk
        JOIN fza_atributos_sku ask ON sk.CODIGO_UNIDAD_SKU = ask.CODIGO_UNIDAD_SA
        JOIN fza_atributos_valores av ON ask.ID_VALOR_SA = av.ID_VALOR_AV
        JOIN fza_variaciones_atributos va ON av.ID_VA_AV = va.ID_ATRIBUTO_VA
        WHERE sk.CODIGO_ARTICULO_SKU = v_codigo_articulo
          AND va.ID_ATRIBUTO_VA <> v_id_atributo_pivot -- Que no sea el mismo que usamos para columnas
        ORDER BY va.ORDEN_VA DESC
        LIMIT 1;
    END IF;

    -- 3. SI TENEMOS ESTRUCTURA PARA PIVOTAR...
    IF v_id_atributo_pivot IS NOT NULL THEN
    
        -- 3.1 Si es SKU, detectamos el valor del atributo "Grupo" (Ej. detectar que es 'NEGRO')
        IF v_es_sku = TRUE AND v_id_atributo_grupo IS NOT NULL THEN
            SELECT av.VALOR_AV INTO v_valor_grupo_filtro
            FROM fza_atributos_sku ask
            JOIN fza_atributos_valores av ON ask.ID_VALOR_SA = av.ID_VALOR_AV
            WHERE ask.CODIGO_UNIDAD_SA = p_input -- El SKU exacto que escaneó el usuario
              AND av.ID_VA_AV = v_id_atributo_grupo;
        END IF;

        -- 3.2 Construir columnas dinámicas (S, M, L...) usando el alias 'av_p' (Atributo Pivot)
        SELECT GROUP_CONCAT(DISTINCT
            CONCAT(
                'SUM(CASE WHEN av_p.VALOR_AV = ''', REPLACE(av.VALOR_AV, "'", "''"), 
                ''' THEN stk.CANTIDAD_STK ELSE 0 END) AS `', REPLACE(av.VALOR_AV, "`", "``"), '`'
            )
            ORDER BY av.ID_VALOR_AV
        ) INTO v_columnas_dinamicas
        FROM fza_articulos_skus sk
        JOIN fza_atributos_sku ask ON sk.CODIGO_UNIDAD_SKU = ask.CODIGO_UNIDAD_SA
        JOIN fza_atributos_valores av ON ask.ID_VALOR_SA = av.ID_VALOR_AV
        WHERE sk.CODIGO_ARTICULO_SKU = v_codigo_articulo
          AND av.ID_VA_AV = v_id_atributo_pivot;

        -- 3.3 Construir Query Final
        IF v_columnas_dinamicas IS NOT NULL THEN
            SET @sql = CONCAT(
                'SELECT 
                    -- Construimos el código: PADRE o PADRE/COLOR
                    CONCAT(''', v_codigo_articulo, ''', 
                        CASE 
                            WHEN av_g.VALOR_AV IS NOT NULL THEN CONCAT(''/'', av_g.VALOR_AV) 
                            ELSE '''' 
                        END
                    ) AS Codigo,
                    alm.NOMBRE_ALMACEN_ALM AS Almacen, ', 
                    v_columnas_dinamicas, ',
                    SUM(stk.CANTIDAD_STK) AS Total
                 FROM fza_articulos_stockactual stk
                 JOIN fza_almacenes alm ON stk.CODIGO_ALMACEN_STK = alm.CODIGO_ALMACEN_ALM
                 JOIN fza_articulos_skus sk ON stk.CODIGO_UNIDAD_STK = sk.CODIGO_UNIDAD_SKU
                 
                 -- JOIN 1: Para obtener el valor de la columna (Talla) -> av_p
                 JOIN fza_atributos_sku ask_p ON sk.CODIGO_UNIDAD_SKU = ask_p.CODIGO_UNIDAD_SA
                 JOIN fza_atributos_valores av_p ON ask_p.ID_VALOR_SA = av_p.ID_VALOR_AV 
                    AND av_p.ID_VA_AV = ''', v_id_atributo_pivot, '''
                 
                 -- JOIN 2: Para obtener el valor de la fila (Color) -> av_g
                 LEFT JOIN fza_atributos_sku ask_g ON sk.CODIGO_UNIDAD_SKU = ask_g.CODIGO_UNIDAD_SA
                 LEFT JOIN fza_atributos_valores av_g ON ask_g.ID_VALOR_SA = av_g.ID_VALOR_AV 
                    AND av_g.ID_VA_AV = ''', IFNULL(v_id_atributo_grupo, 'xxx'), '''

                 WHERE sk.CODIGO_ARTICULO_SKU = ''', v_codigo_articulo, '''
                 -- Si hay filtro de grupo (ej. escaneó NEGRO), filtramos aquí
                 ', CASE WHEN v_valor_grupo_filtro IS NOT NULL THEN 
                        CONCAT(' AND av_g.VALOR_AV = ''', REPLACE(v_valor_grupo_filtro, "'", "''"), ''' ') 
                        ELSE '' END, '
                 
                 GROUP BY av_g.VALOR_AV, alm.NOMBRE_ALMACEN_ALM
                 ORDER BY alm.NOMBRE_ALMACEN_ALM, av_g.VALOR_AV'
            );

            PREPARE stmt FROM @sql;
            EXECUTE stmt;
            DEALLOCATE PREPARE stmt;
            
            SET v_id_atributo_pivot = NULL; -- Evitar entrar al fallback
        END IF;
    END IF;

    -- CASO B: FALLBACK (Si no tiene atributos complejos)
    IF v_id_atributo_pivot IS NOT NULL OR v_columnas_dinamicas IS NULL THEN 
        SELECT stk.CODIGO_UNIDAD_STK as Codigo,  
            alm.NOMBRE_ALMACEN_ALM as Almacen, 
            SUM(stk.CANTIDAD_STK) as Stock_Total
        FROM fza_articulos_stockactual stk
        JOIN fza_almacenes alm ON stk.CODIGO_ALMACEN_STK = alm.CODIGO_ALMACEN_ALM
        WHERE stk.CODIGO_UNIDAD_STK = p_input 
        GROUP BY alm.NOMBRE_ALMACEN_ALM
        ORDER BY alm.NOMBRE_ALMACEN_ALM;
    END IF;

END $$
DELIMITER ;

-- Recreando procedimiento: PRC_GET_CAJA_STOCK_PIVOTADO_WITHZ
DROP PROCEDURE IF EXISTS `PRC_GET_CAJA_STOCK_PIVOTADO_WITHZ`;

DELIMITER $$
CREATE  PROCEDURE `PRC_GET_CAJA_STOCK_PIVOTADO_WITHZ`(IN p_input VARCHAR(50))
BEGIN
    DECLARE v_codigo_articulo VARCHAR(20);
    DECLARE v_es_sku BOOLEAN DEFAULT FALSE;
    DECLARE v_id_atributo_pivot VARCHAR(20);
    DECLARE v_nombre_atributo_pivot VARCHAR(50);
    DECLARE v_columnas_dinamicas TEXT;
    DECLARE v_filtros_fijos TEXT DEFAULT '';
    DECLARE v_sql_query TEXT;

    -- 1. IDENTIFICAR ARTÍCULO O SKU
    SELECT CODIGO_ARTICULO INTO v_codigo_articulo 
    FROM fza_articulos WHERE CODIGO_ARTICULO = p_input;

    IF v_codigo_articulo IS NULL THEN
        SELECT CODIGO_ARTICULO_SKU INTO v_codigo_articulo 
        FROM fza_articulos_skus WHERE CODIGO_UNIDAD_SKU = p_input;
        
        IF v_codigo_articulo IS NOT NULL THEN SET v_es_sku = TRUE; END IF;
    END IF;

    -- 2. BUSCAR ATRIBUTO PIVOTE
    IF v_codigo_articulo IS NOT NULL THEN
        SELECT va.ID_ATRIBUTO_VA, va.NOMBRE_VA
        INTO v_id_atributo_pivot, v_nombre_atributo_pivot
        FROM fza_articulos_skus sk
        JOIN fza_atributos_sku ask ON sk.CODIGO_UNIDAD_SKU = ask.CODIGO_UNIDAD_SA
        JOIN fza_atributos_valores av ON ask.ID_VALOR_SA = av.ID_VALOR_AV
        JOIN fza_variaciones_atributos va ON av.ID_VA_AV = va.ID_ATRIBUTO_VA
        WHERE sk.CODIGO_ARTICULO_SKU = v_codigo_articulo
        ORDER BY va.ORDEN_VA DESC
        LIMIT 1;
    END IF;

    -- 3. CONSTRUCCIÓN DE LA CONSULTA
    IF v_id_atributo_pivot IS NOT NULL THEN
        -- CASO A: CON ATRIBUTOS (PIVOT)
        
        -- Generamos columnas dinámicas apuntando a la subconsulta 'src'
        SELECT GROUP_CONCAT(DISTINCT
            CONCAT(
                'SUM(CASE WHEN src.VALOR_AV = ''', av.VALOR_AV, 
                ''' THEN src.CANTIDAD_STK ELSE 0 END) AS `', av.VALOR_AV, '`'
            )
            ORDER BY av.ID_VALOR_AV
        ) INTO v_columnas_dinamicas
        FROM fza_articulos_skus sk
        JOIN fza_atributos_sku ask ON sk.CODIGO_UNIDAD_SKU = ask.CODIGO_UNIDAD_SA
        JOIN fza_atributos_valores av ON ask.ID_VALOR_SA = av.ID_VALOR_AV
        WHERE sk.CODIGO_ARTICULO_SKU = v_codigo_articulo
          AND av.ID_VA_AV = v_id_atributo_pivot;

        -- Filtros SKU
        IF v_es_sku = TRUE THEN
            SELECT GROUP_CONCAT(
                CONCAT(
                    ' AND EXISTS (SELECT 1 FROM fza_atributos_sku f_ask ',
                    ' JOIN fza_atributos_valores f_av ON f_ask.ID_VALOR_SA = f_av.ID_VALOR_AV ',
                    ' WHERE f_ask.CODIGO_UNIDAD_SA = sk.CODIGO_UNIDAD_SKU ',
                    ' AND f_av.ID_VA_AV = ''', av.ID_VA_AV, ''' ',
                    ' AND f_av.VALOR_AV = ''', av.VALOR_AV, ''') '
                ) SEPARATOR ' '
            ) INTO v_filtros_fijos
            FROM fza_atributos_sku ask
            JOIN fza_atributos_valores av ON ask.ID_VALOR_SA = av.ID_VALOR_AV
            WHERE ask.CODIGO_UNIDAD_SA = p_input 
              AND av.ID_VA_AV <> v_id_atributo_pivot;
        END IF;
        IF v_filtros_fijos IS NULL THEN SET v_filtros_fijos = ''; END IF;

        -- QUERY FINAL: Desde Almacenes LEFT JOIN Subconsulta de Stock
        SET @sql = CONCAT(
            'SELECT 
                alm.NOMBRE_ALMACEN_ALM AS Almacen, ', 
                v_columnas_dinamicas, ',
                COALESCE(SUM(src.CANTIDAD_STK), 0) AS Total
             FROM fza_almacenes alm
             LEFT JOIN (
                SELECT stk.CODIGO_ALMACEN_STK, av.VALOR_AV, stk.CANTIDAD_STK
                FROM fza_articulos_stockactual stk
                JOIN fza_articulos_skus sk ON stk.CODIGO_UNIDAD_STK = sk.CODIGO_UNIDAD_SKU
                JOIN fza_atributos_sku ask ON sk.CODIGO_UNIDAD_SKU = ask.CODIGO_UNIDAD_SA
                JOIN fza_atributos_valores av ON ask.ID_VALOR_SA = av.ID_VALOR_AV
                WHERE sk.CODIGO_ARTICULO_SKU = ''', v_codigo_articulo, '''
                  AND av.ID_VA_AV = ''', v_id_atributo_pivot, ''' ',
                  v_filtros_fijos, '
             ) src ON alm.CODIGO_ALMACEN_ALM = src.CODIGO_ALMACEN_STK
             WHERE alm.ESACTIVO_ALM = ''S'' 
             GROUP BY alm.NOMBRE_ALMACEN_ALM
             ORDER BY alm.NOMBRE_ALMACEN_ALM'
        );

        PREPARE stmt FROM @sql;
        EXECUTE stmt;
        DEALLOCATE PREPARE stmt;

    ELSE
        -- CASO B: ARTÍCULO SIMPLE (Sin atributos)
        SELECT 
            alm.NOMBRE_ALMACEN_ALM as Almacen, 
            COALESCE(SUM(stk.CANTIDAD_STK), 0) as `Stock Total`
        FROM fza_almacenes alm
        LEFT JOIN fza_articulos_stockactual stk 
            ON alm.CODIGO_ALMACEN_ALM = stk.CODIGO_ALMACEN_STK
            AND stk.CODIGO_UNIDAD_STK = p_input -- Filtro en el ON para no romper el LEFT JOIN
        WHERE alm.ESACTIVO_ALM = 'S'
        GROUP BY alm.NOMBRE_ALMACEN_ALM
        ORDER BY alm.NOMBRE_ALMACEN_ALM;
        
    END IF;
END $$
DELIMITER ;

-- Recreando procedimiento: PRC_GET_CREAR_VALOR
DROP PROCEDURE IF EXISTS `PRC_GET_CREAR_VALOR`;

DELIMITER $$
CREATE  PROCEDURE `PRC_GET_CREAR_VALOR`(IN `p_id_va` VARCHAR(20),       -- Tipo de Variación (ej: 'CO')
    IN `p_valor` VARCHAR(100),      -- El valor escrito (ej: 'VERDE LIMA')
    IN `p_usuario` VARCHAR(100),    -- Usuario que hace la acción
    OUT `p_id_resultado` INT)
BEGIN
    -- 1. Intentamos buscar el ID si ya existe
    SELECT `ID_VALOR_AV` INTO p_id_resultado
    FROM `fza_atributos_valores`
    WHERE `ID_VA_AV` = p_id_va 
      AND UPPER(`VALOR_AV`) = UPPER(p_valor) -- Comparamos ignorando mayúsculas
    LIMIT 1;

    -- 2. Si p_id_resultado sigue siendo NULL, significa que no existe. LO CREAMOS.
    IF p_id_resultado IS NULL THEN
        INSERT INTO `fza_atributos_valores` (
            `ID_VA_AV`, 
            `VALOR_AV`, 
            `USUARIOALTA`, 
            `USUARIOMODIF`, 
            `INSTANTEALTA`
        ) VALUES (
            p_id_va, 
            p_valor, 
            p_usuario, 
            p_usuario, 
            NOW()
        );
        
        -- Obtenemos el ID que se acaba de generar
        SET p_id_resultado = LAST_INSERT_ID();
    END IF;

    -- Al final, p_id_resultado siempre tiene un número válido (viejo o nuevo).
END $$
DELIMITER ;

-- Recreando procedimiento: PRC_GET_DATA_ARTICULO
DROP PROCEDURE IF EXISTS `PRC_GET_DATA_ARTICULO`;

DELIMITER $$
CREATE  PROCEDURE `PRC_GET_DATA_ARTICULO`(IN `pidcodarticulo` varchar(200), 
                                         OUT `pidnomarticulo` varchar(1000), 
                                         OUT `ptipoiva` varchar(2))
BEGIN
   IF( EXISTS(
             SELECT *
               FROM `fza_articulos`
              WHERE `CODIGO_ARTICULO` =  `pidcodarticulo`) ) THEN
  BEGIN
    SELECT `DESCRIPCION_ARTICULO`, `TIPOIVA_ARTICULO` 
      INTO `pidnomarticulo`, `ptipoiva`
      FROM `fza_articulos`
     WHERE `CODIGO_ARTICULO` = `pidcodarticulo`;
  END;
  ELSE
  BEGIN
    SET `pidnomarticulo` = 'NO EXISTE';
    SET `ptipoiva` = 'N';
  END;
  END IF;
END $$
DELIMITER ;

-- Recreando procedimiento: PRC_GET_DATA_CLIENTE
DROP PROCEDURE IF EXISTS `PRC_GET_DATA_CLIENTE`;

DELIMITER $$
CREATE  PROCEDURE `PRC_GET_DATA_CLIENTE`(IN `pCODIGO_CLIENTE`                    varchar(10),
                         OUT `pRAZONSOCIAL_CLIENTE`               varchar(200),
                         OUT `pNIF_CLIENTE`                       varchar(50),
                         OUT `pCODIGO_ZONA_IVA_CLIENTE`           int,
                         OUT `pMOVIL_CLIENTE`                     varchar(40),
                         OUT `pESIVA_RECARGO_CLIENTE`             varchar(1),
                         OUT `pESRETENCIONES_CLIENTE`             varchar(1),
                         OUT `pESIVA_EXENTO_CLIENTE`              varchar(1),
                         OUT `pESINTRACOMUNITARIO_CLIENTE`        varchar(1),
                         OUT `pESREGIMENESPECIALAGRICOLA_CLIENTE` varchar(1),
                         OUT `pEMAIL_CLIENTE`                     varchar(200),
                         OUT `pDIRECCION1_CLIENTE`                varchar(200),
                         OUT `pDIRECCION2_CLIENTE`                varchar(200),
                         OUT `pPOBLACION_CLIENTE`                 varchar(200),
                         OUT `pPROVINCIA_CLIENTE`                 varchar(200),
                         OUT `pCPOSTAL_CLIENTE`                   varchar(15),
                         OUT `pTARIFA_ARTICULO_CLIENTE`           varchar(10),
                         OUT `pTEXTO_LEGAL_FACTURA_CLIENTE`       varchar(1000),
                         OUT `pPAIS_CLIENTE`                      varchar(150),
												 OUT `pCOD_PAIS_CLIENTE`                      varchar(150))
BEGIN
   IF( EXISTS(
             SELECT *
             FROM `fza_clientes`
             WHERE `CODIGO_CLIENTE` =  `pCODIGO_CLIENTE`) ) THEN
  BEGIN
    SELECT  `RAZONSOCIAL_CLIENTE`               ,
            `NIF_CLIENTE`                       ,
            `CODIGO_ZONA_IVA_CLIENTE`           ,
            `ESIVA_RECARGO_CLIENTE`             ,
            `ESRETENCIONES_CLIENTE`             ,
            `ESIVA_EXENTO_CLIENTE`              ,
            `ESINTRACOMUNITARIO_CLIENTE`        ,
            `ESREGIMENESPECIALAGRICOLA_CLIENTE` ,
            `MOVIL_CLIENTE`                     ,
            `EMAIL_CLIENTE`                     ,
            `DIRECCION1_CLIENTE`                ,
            `DIRECCION2_CLIENTE`                ,
            `POBLACION_CLIENTE`                 ,
            `PROVINCIA_CLIENTE`                 ,
            `CPOSTAL_CLIENTE`                   ,
            `TARIFA_ARTICULO_CLIENTE`           ,
            `TEXTO_LEGAL_FACTURA_CLIENTE`       ,
            `NOMBRE_PAIS_CLIENTE`               ,
						`CODIGO_PAIS_CLIENTE`    
      INTO  `pRAZONSOCIAL_CLIENTE`              ,
            `pNIF_CLIENTE`                      ,
            `pCODIGO_ZONA_IVA_CLIENTE`          ,
            `pESIVA_RECARGO_CLIENTE`            ,
            `pESRETENCIONES_CLIENTE`            ,
            `pESIVA_EXENTO_CLIENTE`             ,
            `pESINTRACOMUNITARIO_CLIENTE`       ,
            `pESREGIMENESPECIALAGRICOLA_CLIENTE`,
            `pMOVIL_CLIENTE`                    ,
            `pEMAIL_CLIENTE`                    ,
            `pDIRECCION1_CLIENTE`               ,
            `pDIRECCION2_CLIENTE`               ,
            `pPOBLACION_CLIENTE`                ,
            `pPROVINCIA_CLIENTE`                ,
            `pCPOSTAL_CLIENTE`                  ,
            `pTARIFA_ARTICULO_CLIENTE`          ,
            `pTEXTO_LEGAL_FACTURA_CLIENTE`      ,
            `pPAIS_CLIENTE`                     ,
						`pCOD_PAIS_CLIENTE`
      FROM `fza_clientes`
     WHERE `CODIGO_CLIENTE` =  `pCODIGO_CLIENTE`;
  END;
  ELSE
  BEGIN
    SET `pRAZONSOCIAL_CLIENTE` = 'CLIENTE NO ENCONTRADO';
  END;
  END IF;
END $$
DELIMITER ;

-- Recreando procedimiento: PRC_GET_IVA_ZONA_FECHA
DROP PROCEDURE IF EXISTS `PRC_GET_IVA_ZONA_FECHA`;

DELIMITER $$
CREATE  PROCEDURE `PRC_GET_IVA_ZONA_FECHA`(IN `pFECHA` DATE, 
                                       IN `pZONA` INT, 
                                       OUT `pRESUL` INT, 
                                       OUT `pEXENTO_IVA` DECIMAL(18,6), 
                                       OUT `pEXENTO_RE_IVA` DECIMAL(18,6), 
                                       OUT `pNORMAL_IVA` DECIMAL(18,6), 
                                       OUT `pNORMAL_RE_IVA` DECIMAL(18,6), 
                                       OUT `pREDUCIDO_IVA` DECIMAL(18,6), 
                                       OUT `pREDUCIDO_RE_IVA` DECIMAL(18,6), 
                                       OUT `pSUPERREDUCIDO_IVA` DECIMAL(18,6), 
                                       OUT `pSUPERREDUCIDO_RE_IVA` DECIMAL(18,6))
BEGIN
    IF( EXISTS(
             SELECT *
               FROM fza_ivas
              WHERE FECHA_DESDE_IVA >=  FECHA
                AND (FECHA_HASTA_IVA <= FECHA 
                 OR FECHA_HASTA_IVA IS NULL)
                AND  GRUPO_ZONA_IVA = pZONA)) THEN
  SELECT `PORCENEXENTO_IVA` ,
         `PORCENEXENTO_RE_IVA`,
         `PORCENNORMAL_IVA` ,
         `PORCENNORMAL_RE_IVA`,
         `PORCENREDUCIDO_IVA` ,
         `PORCENREDUCIDO_RE_IVA` ,
         `PORCENSUPERREDUCIDO_IVA` ,
         `PORCENSUPERREDUCIDO_RE_IVA`
    INTO
         pEXENTO_IVA,
         pEXENTO_RE_IVA,
         pNORMAL_IVA ,
         pNORMAL_RE_IVA,
         pREDUCIDO_IVA,
         pREDUCIDO_RE_IVA ,
         pSUPERREDUCIDO_IVA,
         pSUPERREDUCIDO_RE_IVA
    FROM fza_ivas
   WHERE (FECHA_DESDE_IVA >=  FECHA
     AND (FECHA_HASTA_IVA <= FECHA OR 
          FECHA_HASTA_IVA IS NULL))
     AND CODIGO_ZONA_IVA = pZONA;
ELSE
    SELECT `PORCENEXENTO_IVA` ,
           `PORCENEXENTO_RE_IVA`,
           `PORCENNORMAL_IVA` ,
           `PORCENNORMAL_RE_IVA`,
           `PORCENREDUCIDO_IVA` ,
           `PORCENREDUCIDO_RE_IVA` ,
           `PORCENSUPERREDUCIDO_IVA` ,
           `PORCENSUPERREDUCIDO_RE_IVA`
       INTO
            pEXENTO_IVA,
            pEXENTO_RE_IVA,
            pNORMAL_IVA ,
            pNORMAL_RE_IVA,
            pREDUCIDO_IVA,
            pREDUCIDO_RE_IVA ,
            pSUPERREDUCIDO_IVA,
            pSUPERREDUCIDO_RE_IVA
      FROM  fza_ivas
     WHERE (FECHA_DESDE_IVA >=  FECHA
       AND FECHA_HASTA_IVA IS NULL )
       AND CODIGO_ZONA_IVA = pZONA;
  END IF;
END $$
DELIMITER ;

-- Recreando procedimiento: PRC_GET_NEXT_CONT
DROP PROCEDURE IF EXISTS `PRC_GET_NEXT_CONT`;

DELIMITER $$
CREATE  PROCEDURE `PRC_GET_NEXT_CONT`(IN  pTipoDoc varchar(2), 
                                         IN  pUSUARIO_MODIF varchar(100),
                                         OUT pcont varchar(20))
BEGIN
DECLARE pPADD bigint;
DECLARE pEMPRESA_CONTADOR varchar(10);
START TRANSACTION;
  IF ( pEMPRESA_CONTADOR = '' OR pEMPRESA_CONTADOR IS NULL ) THEN 
	  SET pEMPRESA_CONTADOR = '-'; 
	END IF;

  IF( NOT( EXISTS(
             SELECT *
             FROM fza_contadores
             WHERE `TIPODOC_CONTADOR` =  pTipoDoc
						   AND EMPRESA_CONTADOR = pEMPRESA_CONTADOR) ) ) THEN
    BEGIN
      INSERT INTO fza_contadores (TIPODOC_CONTADOR, 
                                  SERIE_CONTADOR,
																  EMPRESA_CONTADOR,	
                                  CONTADOR_CONTADOR, 
                                  DEFAULT_CONTADOR,
                                  NUMDIGIT_CONTADOR,
                                  INSTANTEALTA, 
                                  USUARIOALTA,
                                  USUARIOMODIF) 
                          VALUES
                                 (pTipoDoc, 
                                  '-', 
																	pEMPRESA_CONTADOR,
                                   1, 
                                  'S', 
                                   3,
                                  CURRENT_TIMESTAMP,
                                  pUSUARIO_MODIF, 
                                  pUSUARIO_MODIF);
    END;
    END IF;
    SET pPADD = (SELECT NUMDIGIT_CONTADOR 
                   FROM fza_contadores 
                  WHERE TIPODOC_CONTADOR = pTipoDoc 
									  AND EMPRESA_CONTADOR = pEMPRESA_CONTADOR
                    AND DEFAULT_CONTADOR = 'S' 
                  LIMIT 1);
     
     UPDATE fza_contadores 
        SET CONTADOR_CONTADOR = CONTADOR_CONTADOR + 1,
            USUARIOMODIF = pUSUARIO_MODIF
      WHERE TIPODOC_CONTADOR = pTipoDoc
			  AND EMPRESA_CONTADOR = pEMPRESA_CONTADOR;            
      SELECT LPAD( (SELECT CONTADOR_CONTADOR - 1 
                      FROM fza_contadores         
                     WHERE TIPODOC_CONTADOR = pTipoDoc 
										   AND EMPRESA_CONTADOR = pEMPRESA_CONTADOR
                     LIMIT 1) , pPADD, '0') INTO pcont;
COMMIT;
END $$
DELIMITER ;

-- Recreando procedimiento: PRC_GET_NEXT_CONT_FACT_SERIE
DROP PROCEDURE IF EXISTS `PRC_GET_NEXT_CONT_FACT_SERIE`;

DELIMITER $$
CREATE  PROCEDURE `PRC_GET_NEXT_CONT_FACT_SERIE`(IN  `pserie` VARCHAR(12), 
                                                                           IN  `pTipoDoc` VARCHAR(2), 
																																					 IN  `pEMPRESA_CONTADOR` VARCHAR(10), 
																																					 IN  `pUSUARIOMODIF` varchar(100),
																																					 OUT `pcont` varchar(12))
BEGIN
DECLARE pNUMDIGIT varchar(12);
START TRANSACTION;
  IF ( pEMPRESA_CONTADOR = ''  OR pEMPRESA_CONTADOR IS NULL) THEN 
	  SET pEMPRESA_CONTADOR = '-'; 
	END IF;
  IF( NOT( EXISTS(
             SELECT *
             FROM fza_contadores
             WHERE `TIPODOC_CONTADOR` =  pTipoDoc
						   AND EMPRESA_CONTADOR = pEMPRESA_CONTADOR
						   AND `SERIE_CONTADOR` = pserie) ) ) THEN
	BEGIN
	   INSERT INTO fza_contadores (TIPODOC_CONTADOR, 
		                            SERIE_CONTADOR, 
																CONTADOR_CONTADOR, 
																EMPRESA_CONTADOR,
																DEFAULT_CONTADOR,
																NUMDIGIT_CONTADOR,
																INSTANTEALTA, 
																USUARIOALTA,
																USUARIOMODIF) 
												VALUES
																(pTipoDoc, 
																 pserie, 
																 1, 
																 pEMPRESA_CONTADOR,
																 'N', 
																 6,
																 CURRENT_TIMESTAMP,
																 pUSUARIOMODIF, 
																 pUSUARIOMODIF);
	END;
	END IF;

UPDATE fza_contadores
    SET CONTADOR_CONTADOR = CONTADOR_CONTADOR + 1
  WHERE SERIE_CONTADOR = pserie
		  AND EMPRESA_CONTADOR = pEMPRESA_CONTADOR
      AND TIPODOC_CONTADOR = pTipoDoc;
  
	SELECT CONTADOR_CONTADOR - 1 , 
 	 			 NUMDIGIT_CONTADOR
		INTO pcont,
				 pNUMDIGIT
	  from fza_contadores
	 where SERIE_CONTADOR = pserie
		 and TIPODOC_CONTADOR = pTipoDoc
		 AND EMPRESA_CONTADOR = pEMPRESA_CONTADOR 
		 LIMIT 1;
		 
 IF (NOT(pNUMDIGIT IS NULL) AND (pNUMDIGIT <> 0)) THEN
   SET pcont = LPAD(pcont, pNUMDIGIT, '0');
 END IF;								 

COMMIT;
END $$
DELIMITER ;

-- Recreando procedimiento: PRC_GET_NUMEROS_A_LETRAS
DROP PROCEDURE IF EXISTS `PRC_GET_NUMEROS_A_LETRAS`;

DELIMITER $$
CREATE  PROCEDURE `PRC_GET_NUMEROS_A_LETRAS`(IN NUMERO DECIMAL(12,2), OUT pResul varchar(200))
BEGIN
	DECLARE MILLARES INT;
	DECLARE CENTENAS INT;
	DECLARE CENTIMOS INT;
	DECLARE CENTIMO_AUX VARCHAR(200);
	DECLARE CENTIMO_AUX_CON VARCHAR(200);
	DECLARE MIL_AUX VARCHAR(200);
	DECLARE EN_LETRAS VARCHAR(200);
	DECLARE ENTERO INT;
	DECLARE AUX VARCHAR(15);
	DECLARE INTER VARCHAR(200);
	
	SET EN_LETRAS = '';
	SET CENTIMO_AUX_CON = '';
	SET ENTERO = TRUNCATE(NUMERO,0);
	SET MILLARES = TRUNCATE(ENTERO / 1000,0);
	SET CENTENAS = ENTERO MOD 1000;
	SET CENTIMOS = (TRUNCATE(NUMERO,2) * 100) MOD 100;
	
	IF ((MILLARES = 1)) THEN
		SET EN_LETRAS = 'MIL ';
	ELSE 
		IF (MILLARES > 0) THEN
        CALL PRC_GET_NUMERO_MENOR_MIL(MILLARES, INTER); 
				SET EN_LETRAS = CONCAT(EN_LETRAS , INTER ,'MIL ');
				SET EN_LETRAS = REPLACE(EN_LETRAS,'UNO ','UN ');
		END IF;
	END IF;
	
	IF ((CENTENAS > 0) OR ((ENTERO = 0) AND (CENTIMOS = 0))) THEN
		BEGIN
      CALL PRC_GET_NUMERO_MENOR_MIL(CENTENAS, INTER);
			SET EN_LETRAS = CONCAT(EN_LETRAS, INTER);			
		END;
	END IF;
	IF (CENTIMOS > 0) THEN
	BEGIN
		IF (CENTIMOS = 1) THEN
			SET  AUX = 'CÉNTIMO ';
		ELSE
			SET AUX = 'CÉNTIMOS ';
		END IF;	
		IF (CENTIMOS > 0) THEN
            CALL PRC_GET_NUMERO_MENOR_MIL(CENTIMOS, INTER);
			SET CENTIMO_AUX = INTER;
			SET CENTIMO_AUX = REPLACE(CENTIMO_AUX,'UNO ','UN '); 
			IF ENTERO <> 0 THEN 
			  SET CENTIMO_AUX_CON = 'CON ' ; 
			END IF;
			SET EN_LETRAS = CONCAT(EN_LETRAS, CENTIMO_AUX_CON, CENTIMO_AUX , AUX);
		ELSE
			SET EN_LETRAS = CONCAT(EN_LETRAS, CENTIMO_AUX, AUX);		
		END IF;
	END;
	END IF;
	SET pResul = EN_LETRAS;
END $$
DELIMITER ;

-- Recreando procedimiento: PRC_GET_NUMERO_MENOR_MIL
DROP PROCEDURE IF EXISTS `PRC_GET_NUMERO_MENOR_MIL`;

DELIMITER $$
CREATE  PROCEDURE `PRC_GET_NUMERO_MENOR_MIL`(IN NUMERO DECIMAL(4), OUT pResul varchar(100))
BEGIN
       DECLARE CENTENAS INT;
       DECLARE DECENAS INT;
       DECLARE UNIDADES INT;
       DECLARE EN_LETRAS VARCHAR(100);
       DECLARE UNIR VARCHAR(2);
			 SET EN_LETRAS = '';
        IF (NUMERO = 100) THEN
            SET pResul = ('CIEN ');
        ELSEIF NUMERO = 0 THEN
            SET pResul = ('CERO ');
        ELSEIF NUMERO = 1 THEN
            SET pResul = ('UNO ');
        ELSE
            SET CENTENAS = TRUNCATE(NUMERO / 100,0);
            SET DECENAS  = TRUNCATE((NUMERO MOD 100)/10,0);
            SET UNIDADES = NUMERO MOD 10;
            SET UNIR = 'Y ';
            
						IF CENTENAS = 1 THEN
                SET EN_LETRAS = 'CIENTO ';
            ELSEIF CENTENAS = 2 THEN
                SET EN_LETRAS = 'DOSCIENTOS ';
            ELSEIF CENTENAS = 3 THEN
                SET EN_LETRAS = 'TRESCIENTOS ';
            ELSEIF CENTENAS = 4 THEN
                SET EN_LETRAS = 'CUATROCIENTOS ';
            ELSEIF CENTENAS = 5 THEN
                SET EN_LETRAS = 'QUINIENTOS ';
            ELSEIF CENTENAS = 6 THEN
                SET EN_LETRAS = 'SEISCIENTOS ';
            ELSEIF CENTENAS = 7 THEN
                SET EN_LETRAS = 'SETECIENTOS ';
            ELSEIF CENTENAS = 8 THEN
                SET EN_LETRAS = 'OCHOCIENTOS ';
            ELSEIF CENTENAS = 9 THEN
                SET EN_LETRAS = 'NOVECIENTOS ';
            END IF;
            
						IF DECENAS = 3 THEN
                SET EN_LETRAS = CONCAT(EN_LETRAS , 'TREINTA ');
            ELSEIF DECENAS = 4 THEN
                SET EN_LETRAS = CONCAT(EN_LETRAS , 'CUARENTA ');
            ELSEIF DECENAS = 5 THEN
                SET EN_LETRAS = CONCAT(EN_LETRAS , 'CINCUENTA ');
            ELSEIF DECENAS = 6 THEN
                SET EN_LETRAS = CONCAT(EN_LETRAS , 'SESENTA ');
            ELSEIF DECENAS = 7 THEN
                SET EN_LETRAS = CONCAT(EN_LETRAS , 'SETENTA ');
            ELSEIF DECENAS = 8 THEN
                SET EN_LETRAS = CONCAT(EN_LETRAS , 'OCHENTA ');
            ELSEIF DECENAS = 9 THEN
                SET EN_LETRAS = CONCAT(EN_LETRAS , 'NOVENTA ');
            ELSEIF DECENAS = 1 THEN
                IF UNIDADES < 6 THEN
                    IF UNIDADES = 0 THEN
                        SET EN_LETRAS = CONCAT(EN_LETRAS , 'DIEZ ');
                    ELSEIF UNIDADES = 1 THEN
                        SET EN_LETRAS = CONCAT(EN_LETRAS , 'ONCE ');
                    ELSEIF UNIDADES = 2 THEN
                        SET EN_LETRAS = CONCAT(EN_LETRAS , 'DOCE ');
                    ELSEIF UNIDADES = 3 THEN
                        SET EN_LETRAS = CONCAT(EN_LETRAS , 'TRECE ');
                    ELSEIF UNIDADES = 4 THEN
                        SET EN_LETRAS = CONCAT(EN_LETRAS , 'CATORCE ');
                    ELSEIF UNIDADES = 5 THEN
                        SET EN_LETRAS = CONCAT(EN_LETRAS , 'QUINCE ');
                    END IF;
                    SET UNIDADES = 0;
                ELSE
                    SET EN_LETRAS = CONCAT(EN_LETRAS, 'DIECI');
                    SET UNIR = '';
                END IF;
            ELSEIF (DECENAS = 2) THEN
                IF (UNIDADES = 0) THEN
                    SET EN_LETRAS = CONCAT(EN_LETRAS, 'VEINTE ');
                ELSE
                    SET EN_LETRAS = CONCAT(EN_LETRAS, 'VEINTI');
                END IF;
                SET UNIR = '';
            ELSEIF (DECENAS = 0) THEN
                SET UNIR = '';
            END IF;
						
            IF (UNIDADES = 1) THEN
                SET EN_LETRAS = CONCAT(EN_LETRAS, UNIR, 'UNO ');
            ELSEIF UNIDADES = 2 THEN
                SET EN_LETRAS = CONCAT(EN_LETRAS, UNIR, 'DOS ');
            ELSEIF UNIDADES = 3 THEN
                SET EN_LETRAS = CONCAT(EN_LETRAS, UNIR, 'TRES ');
            ELSEIF UNIDADES = 4 THEN
                SET EN_LETRAS = CONCAT(EN_LETRAS, UNIR, 'CUATRO ');
            ELSEIF UNIDADES = 5 THEN
                SET EN_LETRAS = CONCAT(EN_LETRAS, UNIR, 'CINCO ');
            ELSEIF UNIDADES = 6 THEN
                SET EN_LETRAS = CONCAT(EN_LETRAS, UNIR, 'SEIS ');
            ELSEIF UNIDADES = 7 THEN
                SET EN_LETRAS = CONCAT(EN_LETRAS, UNIR, 'SIETE ');
            ELSEIF UNIDADES = 8 THEN
                SET EN_LETRAS = CONCAT(EN_LETRAS, UNIR, 'OCHO ');
            ELSEIF UNIDADES = 9 THEN
                SET EN_LETRAS = CONCAT(EN_LETRAS , UNIR , 'NUEVE ');
            END IF;
        END IF;
        SET pResul = EN_LETRAS;
    END $$
DELIMITER ;

-- Recreando procedimiento: PRC_REALIZAR_TRASPASO
DROP PROCEDURE IF EXISTS `PRC_REALIZAR_TRASPASO`;

DELIMITER $$
CREATE  PROCEDURE `PRC_REALIZAR_TRASPASO`(IN pUsuario VARCHAR(50),
    IN pEmpresa VARCHAR(20),
    IN pAlmacenOrigen VARCHAR(10),
    IN pAlmacenDestino VARCHAR(10),
    IN pSku VARCHAR(50),
    IN pCantidad DECIMAL(19,6))
BEGIN
    DECLARE vSerie VARCHAR(20) DEFAULT 'TRAS';
    DECLARE vNroDoc VARCHAR(20);
    
    -- Generamos un número de documento único basado en la fecha y hora (simplificado)
    SET vNroDoc = DATE_FORMAT(NOW(), '%Y%m%d%H%i%s');

    START TRANSACTION;

    -- 1. SALIDA DEL ORIGEN (Resta stock en Origen)
    INSERT INTO `fza_movimientos_almacen` 
    (TIPO_DOC_MOV, SERIE_DOC_MOV, NRO_DOC_MOV, LINEA_MOV, CODIGO_EMPRESA_MOV, 
     CODIGO_ALMACEN_MOV, CODIGO_ALMACEN_CONTRA_MOV, FECHA_MOV, 
     CODIGO_UNIDAD_MOV, TIPO_MOVIMIENTO_MOV, CANTIDAD_MOV, 
     DESCRIPCION_ARTICULO_MOV, USUARIOALTA, USUARIOMODIF)
    VALUES 
    ('TR', vSerie, vNroDoc, '001', pEmpresa, 
     pAlmacenOrigen, pAlmacenDestino, NOW(), 
     pSku, 'S', pCantidad, 
     CONCAT('Traspaso a ', pAlmacenDestino), pUsuario, pUsuario);

    -- 2. ENTRADA EN DESTINO (Suma stock en Destino)
    -- Referenciamos al movimiento anterior para trazabilidad
    INSERT INTO `fza_movimientos_almacen` 
    (TIPO_DOC_MOV, SERIE_DOC_MOV, NRO_DOC_MOV, LINEA_MOV, CODIGO_EMPRESA_MOV, 
     CODIGO_ALMACEN_MOV, CODIGO_ALMACEN_CONTRA_MOV, FECHA_MOV, 
     CODIGO_UNIDAD_MOV, TIPO_MOVIMIENTO_MOV, CANTIDAD_MOV, 
     DESCRIPCION_ARTICULO_MOV, USUARIOALTA, USUARIOMODIF,
     TIPO_DOC_REF_MOV, SERIE_DOC_REF_MOV, NRO_DOC_REF_MOV, LINEA_REF_MOV)
    VALUES 
    ('TR', vSerie, vNroDoc, '002', pEmpresa, 
     pAlmacenDestino, pAlmacenOrigen, NOW(), 
     pSku, 'E', pCantidad, 
     CONCAT('Traspaso desde ', pAlmacenOrigen), pUsuario, pUsuario,
     'TR', vSerie, vNroDoc, '001');

    COMMIT;
    
    SELECT CONCAT('Traspaso realizado. Doc: ', vSerie, '-', vNroDoc) as MENSAJE;
END $$
DELIMITER ;

-- Recreando procedimiento: PRC_RECALCULAR_STOCK
DROP PROCEDURE IF EXISTS `PRC_RECALCULAR_STOCK`;

DELIMITER $$
CREATE  PROCEDURE `PRC_RECALCULAR_STOCK`()
BEGIN
    DECLARE EXIT HANDLER FOR SQLEXCEPTION
    BEGIN
        -- En caso de error, deshacer cambios
        ROLLBACK;
        SELECT 'ERROR: No se pudo recalcular el stock' as MENSAJE;
    END;

    START TRANSACTION;
    
        -- Borramos la tabla de saldos
        DELETE FROM fza_articulos_stockactual;
        
        -- Volcamos los datos recalculados
        INSERT INTO fza_articulos_stockactual 
        (CODIGO_ALMACEN_STK, CODIGO_UNIDAD_STK, CANTIDAD_STK, INSTANTEMODIF)
        SELECT 
            CODIGO_ALMACEN_MOV,
            CODIGO_UNIDAD_MOV,
            SUM(IF(TIPO_MOVIMIENTO_MOV = 'E', CANTIDAD_MOV, -CANTIDAD_MOV)),
            NOW()
        FROM fza_movimientos_almacen
        GROUP BY CODIGO_ALMACEN_MOV, CODIGO_UNIDAD_MOV;
        
    COMMIT;
    
    SELECT 'Stock recalculado correctamente.' as MENSAJE;
END $$
DELIMITER ;

-- === FUNCIONES ===
-- === TRIGGERS ===


-- Crear trigger: TRG_CALC_CAMBIO_INSERT
CREATE  TRIGGER `TRG_CALC_CAMBIO_INSERT` BEFORE INSERT ON `fza_caja_pagos` FOR EACH ROW BEGIN
    -- Solo si se ha indicado un importe en divisa/crypto diferente de 0
    IF NEW.IMPORTE_DIVISA_PAGO IS NOT NULL AND NEW.IMPORTE_DIVISA_PAGO <> 0 THEN
        
        -- Si por error el factor de cambio es 0 o nulo, forzamos a 1 para evitar importes a 0
        IF NEW.FACTOR_CAMBIO_PAGO IS NULL OR NEW.FACTOR_CAMBIO_PAGO = 0 THEN
            SET NEW.FACTOR_CAMBIO_PAGO = 1;
        END IF;

        -- CALCULO AUTOMÁTICO: Cantidad Crypto * Cotización = Importe en Euros (o moneda base)
        SET NEW.IMPORTE_ENTREGADO_PAGO = NEW.IMPORTE_DIVISA_PAGO * NEW.FACTOR_CAMBIO_PAGO;
        
    END IF;
END;

-- Crear trigger: TRG_CALC_CAMBIO_UPDATE
CREATE  TRIGGER `TRG_CALC_CAMBIO_UPDATE` BEFORE UPDATE ON `fza_caja_pagos` FOR EACH ROW BEGIN
    -- Recalcular solo si cambia el importe en divisa o el factor de cambio
    IF (NEW.IMPORTE_DIVISA_PAGO <> OLD.IMPORTE_DIVISA_PAGO) OR (NEW.FACTOR_CAMBIO_PAGO <> OLD.FACTOR_CAMBIO_PAGO) THEN
        
        IF NEW.IMPORTE_DIVISA_PAGO IS NOT NULL AND NEW.IMPORTE_DIVISA_PAGO <> 0 THEN
            
            IF NEW.FACTOR_CAMBIO_PAGO IS NULL OR NEW.FACTOR_CAMBIO_PAGO = 0 THEN
                 SET NEW.FACTOR_CAMBIO_PAGO = 1;
            END IF;

            SET NEW.IMPORTE_ENTREGADO_PAGO = NEW.IMPORTE_DIVISA_PAGO * NEW.FACTOR_CAMBIO_PAGO;
            
        END IF;
    END IF;
END;

-- Crear trigger: TRG_CALCULO_PMP_INSERT
CREATE  TRIGGER `TRG_CALCULO_PMP_INSERT` AFTER INSERT ON `fza_movimientos_almacen` FOR EACH ROW BEGIN
    DECLARE vStockActual DECIMAL(19,6);
    DECLARE vCosteMedioActual DECIMAL(19,6);
    DECLARE vNuevoCosteMedio DECIMAL(19,6);

    -- Solo nos interesa recalcular si es una ENTRADA ('E') y tiene coste
    IF NEW.TIPO_MOVIMIENTO_MOV = 'E' AND NEW.PRECIO_COSTE_UNITARIO_MOV > 0 THEN

        -- 1. Obtenemos el Stock y Coste que teníamos ANTES de este movimiento
        -- (Nota: Simplificado. En un ERP real leerías de fza_articulos_stockactual)
        -- Aquí leemos de la ficha del SKU
        SELECT PRECIO_COSTE_MEDIO 
        INTO vCosteMedioActual
        FROM fza_articulos_skus 
        WHERE CODIGO_UNIDAD_SKU = NEW.CODIGO_UNIDAD_MOV;
        
        -- Calculamos el stock actual sumando todos los movimientos anteriores (sin incluir este nuevo todavía)
        -- OJO: Esto es lento si hay millones de filas. Idealmente leerías de una tabla de stock acumulado.
        SET vStockActual = (
            SELECT IFNULL(SUM(CASE WHEN TIPO_MOVIMIENTO_MOV='E' THEN CANTIDAD_MOV ELSE -CANTIDAD_MOV END), 0)
            FROM fza_movimientos_almacen
            WHERE CODIGO_UNIDAD_MOV = NEW.CODIGO_UNIDAD_MOV
            AND (FECHA_MOV < NEW.FECHA_MOV OR (FECHA_MOV = NEW.FECHA_MOV AND INSTANTEALTA < NEW.INSTANTEALTA))
        );

        -- Si el stock era negativo o cero (estábamos sin stock), el precio medio es el de la nueva compra
        IF vStockActual <= 0 THEN
            SET vNuevoCosteMedio = NEW.PRECIO_COSTE_UNITARIO_MOV;
        ELSE
            -- 2. LA FÓRMULA DEL PMP
            -- ((StockViejo * CosteViejo) + (CantidadNueva * CosteNuevo)) / (StockViejo + CantidadNueva)
            SET vNuevoCosteMedio = (
                (vStockActual * vCosteMedioActual) + 
                (NEW.CANTIDAD_MOV * NEW.PRECIO_COSTE_UNITARIO_MOV)
            ) / (vStockActual + NEW.CANTIDAD_MOV);
        END IF;

        -- 3. Actualizamos la ficha del producto
        UPDATE fza_articulos_skus 
        SET PRECIO_COSTE_MEDIO = vNuevoCosteMedio
        WHERE CODIGO_UNIDAD_SKU = NEW.CODIGO_UNIDAD_MOV;

    END IF;
END;

-- Crear trigger: TRG_MOVIMIENTOS_AD
CREATE  TRIGGER `TRG_MOVIMIENTOS_AD` AFTER DELETE ON `fza_movimientos_almacen` FOR EACH ROW BEGIN
    DECLARE vCantidad DECIMAL(19,6);

    -- Lógica inversa: Si borro una Entrada, tengo que RESTAR stock.
    IF OLD.TIPO_MOVIMIENTO_MOV = 'E' THEN
        SET vCantidad = -OLD.CANTIDAD_MOV;
    ELSE
        SET vCantidad = OLD.CANTIDAD_MOV;
    END IF;

    -- Actualizamos la tabla de stock
    UPDATE `fza_articulos_stockactual` 
    SET CANTIDAD_STK = CANTIDAD_STK + vCantidad,
        INSTANTEMODIF = NOW()
    WHERE CODIGO_ALMACEN_STK = OLD.CODIGO_ALMACEN_MOV 
      AND CODIGO_UNIDAD_STK = OLD.CODIGO_UNIDAD_MOV;
END;

-- Crear trigger: TRG_MOVIMIENTOS_AI
CREATE  TRIGGER `TRG_MOVIMIENTOS_AI` AFTER INSERT ON `fza_movimientos_almacen` FOR EACH ROW BEGIN
    DECLARE vCantidad DECIMAL(19,6);
    DECLARE vStockActual DECIMAL(19,6);
    DECLARE vCosteMedioActual DECIMAL(19,6);
    DECLARE vNuevoCosteMedio DECIMAL(19,6);

    -- -----------------------------------------------------------
    -- PARTE A: ACTUALIZAR EL STOCK FÍSICO
    -- -----------------------------------------------------------
    -- Si es Entrada (E) suma, si es Salida (S) resta.
    IF NEW.TIPO_MOVIMIENTO_MOV = 'E' THEN
        SET vCantidad = NEW.CANTIDAD_MOV;
    ELSE
        SET vCantidad = -NEW.CANTIDAD_MOV;
    END IF;

    -- "UPSERT": Si ya existe registro de stock para ese SKU+Almacen, lo actualiza.
    -- Si no existe (es la primera vez), lo crea.
    INSERT INTO `fza_articulos_stockactual` 
    (CODIGO_ALMACEN_STK, CODIGO_UNIDAD_STK, CANTIDAD_STK, INSTANTEMODIF)
    VALUES 
    (NEW.CODIGO_ALMACEN_MOV, NEW.CODIGO_UNIDAD_MOV, vCantidad, NOW())
    ON DUPLICATE KEY UPDATE 
        CANTIDAD_STK = CANTIDAD_STK + vCantidad,
        INSTANTEMODIF = NOW();

    -- -----------------------------------------------------------
    -- PARTE B: RECALCULAR PRECIO MEDIO PONDERADO (PMP)
    -- Solo si es Entrada (E) y tiene un coste > 0
    -- -----------------------------------------------------------
    IF NEW.TIPO_MOVIMIENTO_MOV = 'E' AND NEW.PRECIO_COSTE_UNITARIO_MOV > 0 THEN
        
        -- Obtenemos el coste medio actual de la ficha del SKU
        SELECT IFNULL(PRECIO_COSTE_MEDIO, 0) INTO vCosteMedioActual
        FROM fza_articulos_skus 
        WHERE CODIGO_UNIDAD_SKU = NEW.CODIGO_UNIDAD_MOV;

        -- Obtenemos el stock TOTAL actual (sumando todos los almacenes) antes de esta entrada
        -- Nota: Restamos la cantidad actual porque el trigger se ejecuta AFTER insert
        SELECT IFNULL(SUM(CANTIDAD_STK), 0) - NEW.CANTIDAD_MOV INTO vStockActual
        FROM fza_articulos_stockactual
        WHERE CODIGO_UNIDAD_STK = NEW.CODIGO_UNIDAD_MOV;

        -- Evitamos división por cero o stocks negativos locos para el precio
        IF vStockActual <= 0 THEN
            SET vNuevoCosteMedio = NEW.PRECIO_COSTE_UNITARIO_MOV;
        ELSE
            -- Fórmula del PMP
            SET vNuevoCosteMedio = (
                (vStockActual * vCosteMedioActual) + 
                (NEW.CANTIDAD_MOV * NEW.PRECIO_COSTE_UNITARIO_MOV)
            ) / (vStockActual + NEW.CANTIDAD_MOV);
        END IF;

        -- Guardamos el nuevo precio medio en la ficha
        UPDATE fza_articulos_skus 
        SET PRECIO_COSTE_MEDIO = vNuevoCosteMedio
        WHERE CODIGO_UNIDAD_SKU = NEW.CODIGO_UNIDAD_MOV;
    END IF;

END;

-- Crear trigger: TRG_MOVIMIENTOS_AI_LOTES
CREATE  TRIGGER `TRG_MOVIMIENTOS_AI_LOTES` AFTER INSERT ON `fza_movimientos_almacen` FOR EACH ROW BEGIN
    DECLARE vCantidad DECIMAL(19,6);
    DECLARE vLote VARCHAR(50);
    DECLARE vCaducidad DATE;

    -- Gestión de nulos para que no falle la Clave Primaria
    SET vLote = IFNULL(NEW.LOTE_MOV, '');
    SET vCaducidad = NEW.FECHA_CADUCIDAD_MOV;

    -- Definir signo
    IF NEW.TIPO_MOVIMIENTO_MOV = 'E' THEN SET vCantidad = NEW.CANTIDAD_MOV;
    ELSE SET vCantidad = -NEW.CANTIDAD_MOV; END IF;

    -- UPSERT AHORA USANDO EL LOTE
    INSERT INTO `fza_articulos_stockactual` 
    (CODIGO_ALMACEN_STK, CODIGO_UNIDAD_STK, LOTE_STK, FECHA_CADUCIDAD_STK, CANTIDAD_STK, INSTANTEMODIF)
    VALUES 
    (NEW.CODIGO_ALMACEN_MOV, NEW.CODIGO_UNIDAD_MOV, vLote, vCaducidad, vCantidad, NOW())
    ON DUPLICATE KEY UPDATE 
        CANTIDAD_STK = CANTIDAD_STK + vCantidad,
        -- Si es una entrada nueva, actualizamos la fecha de caducidad por si acaso
        FECHA_CADUCIDAD_STK = IF(NEW.TIPO_MOVIMIENTO_MOV='E', vCaducidad, FECHA_CADUCIDAD_STK),
        INSTANTEMODIF = NOW();

END;

-- Crear trigger: TRG_MOVIMIENTOS_AU
CREATE  TRIGGER `TRG_MOVIMIENTOS_AU` AFTER UPDATE ON `fza_movimientos_almacen` FOR EACH ROW BEGIN
    DECLARE vOldQty DECIMAL(19,6);
    DECLARE vNewQty DECIMAL(19,6);

    -- Solo actuamos si cambia cantidad, tipo, almacén o sku
    IF (OLD.CANTIDAD_MOV <> NEW.CANTIDAD_MOV) OR 
       (OLD.TIPO_MOVIMIENTO_MOV <> NEW.TIPO_MOVIMIENTO_MOV) OR
       (OLD.CODIGO_ALMACEN_MOV <> NEW.CODIGO_ALMACEN_MOV) THEN

        -- 1. Deshacer el efecto del registro VIEJO (en el almacén viejo)
        IF OLD.TIPO_MOVIMIENTO_MOV = 'E' THEN 
          SET vOldQty = -OLD.CANTIDAD_MOV;
        ELSE 
          SET vOldQty = OLD.CANTIDAD_MOV; 
        END IF;

        INSERT INTO `fza_articulos_stockactual` 
        (CODIGO_ALMACEN_STK, CODIGO_UNIDAD_STK, CANTIDAD_STK, INSTANTEMODIF)
        VALUES (OLD.CODIGO_ALMACEN_MOV, OLD.CODIGO_UNIDAD_MOV, vOldQty, NOW())
        ON DUPLICATE KEY UPDATE CANTIDAD_STK = CANTIDAD_STK + vOldQty;

        -- 2. Aplicar el efecto del registro NUEVO (en el almacén nuevo)
        IF NEW.TIPO_MOVIMIENTO_MOV = 'E' THEN 
          SET vNewQty = NEW.CANTIDAD_MOV;
        ELSE 
          SET vNewQty = -NEW.CANTIDAD_MOV; 
        END IF;

        INSERT INTO `fza_articulos_stockactual` 
        (CODIGO_ALMACEN_STK, CODIGO_UNIDAD_STK, CANTIDAD_STK, INSTANTEMODIF)
        VALUES (NEW.CODIGO_ALMACEN_MOV, NEW.CODIGO_UNIDAD_MOV, vNewQty, NOW())
        ON DUPLICATE KEY UPDATE CANTIDAD_STK = CANTIDAD_STK + vNewQty;        
    END IF;
END;


